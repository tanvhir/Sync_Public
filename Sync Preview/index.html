<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync - know Thyself</title>
    <!-- Critical: prevent any flash of desktop FAB on mobile before full CSS loads -->
    <style>
      /* Default-hide the desktop FAB; show it explicitly on desktop widths only */
      .center-hub-fab { display: none !important; }
      @media (min-width: 901px) { .center-hub-fab { display: flex !important; } }
    </style>


    <!-- =================================================================== -->
    <!--                START: FAVICON & PWA MANIFEST LINKS                  -->
    <!-- =================================================================== -->
    
    <!-- For modern browsers -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <!-- For iOS (Apple) home screen icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <!-- For PWA installation -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Fallback for older browsers -->
    <link rel="shortcut icon" href="/favicon.ico">
    
    <!-- PWA Theme Color for Chrome on Android -->
    <meta name="theme-color" content="#000000">

    <!-- =================================================================== -->
    <!--                 END: FAVICON & PWA MANIFEST LINKS                   -->
    <!-- =================================================================== -->


    <!-- Google Fonts Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Font & Icon Links -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- =================================================================== -->
    <!--                START: supabaseClient CLIENT LIBRARY                     -->
    <!-- =================================================================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- =================================================================== -->
    <!--                 END: supabaseClient CLIENT LIBRARY                      -->
    <!-- =================================================================== -->

    <!-- Early Auth Gate: prevent dashboard flash before redirect -->
    <style id="early-auth-gate">html{visibility:hidden}</style>
    <script>
      // Create an isolated early client to check auth ASAP without colliding with later globals
      (function(){
        try {
          var EARLY_SUPABASE_URL = 'https://wivtgqflsutzqexuigyy.supabase.co';
          var EARLY_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpdnRncWZsc3V0enFleHVpZ3l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTk0NDQsImV4cCI6MjA3MDczNTQ0NH0.QqnyKKgJm55lKyrzCaxIOP4mr79Q6eqRyJ5T5oVqvhs';
          var earlyClient = (window.supabase && window.supabase.createClient)
            ? window.supabase.createClient(EARLY_SUPABASE_URL, EARLY_SUPABASE_ANON_KEY)
            : null;
          if (!earlyClient) { window.location.replace('login.html'); return; }
          earlyClient.auth.getSession().then(function(res){
            var hasSession = !!(res && res.data && res.data.session);
            if (!hasSession) { window.location.replace('login.html'); return; }
            // Authenticated: reveal the page
            document.documentElement.style.visibility = 'visible';
            var gate = document.getElementById('early-auth-gate');
            if (gate && gate.parentNode) gate.parentNode.removeChild(gate);
          }).catch(function(){
            window.location.replace('login.html');
          });
        } catch (e) {
          window.location.replace('login.html');
        }
      })();
    </script>


    <!-- Internal Stylesheet -->
    <style>
        /* =================================================================== */
        /*                          :ROOT VARIABLES                            */
        /* =================================================================== */
        :root {
            --primary-color: #4cfa9d; 
            --primary-color-dark: #35e089;
            --primary-glow: rgba(76, 250, 157, 0.3);
            --bg-dark: #050505; 
            --bg-panel: #121212; 
            --bg-card: #1a1a1a;
            --bg-input: #1f1f1f; 
            --border-color: #2d2d2d; 
            --text-primary: #e0e0e0; 
            --text-secondary: #8b949e;
            --nav-height: 60px;
            --nav-mobile-height: 70px;
            --easing-snap: cubic-bezier(0.15, 1.15, 0.6, 1); /* Bouncier easing for Action Hub */
        }

        /* =================================================================== */
        /*                          GLOBAL STYLES                              */
        /* =================================================================== */
        html, body { 
            height: 100%; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Poppins', sans-serif;
        }
        body { 
            background: linear-gradient(135deg, #000000, var(--bg-dark)); 
            background-attachment: fixed; 
            color: var(--text-primary); 
        }
        .main-wrapper { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden;
        }
        
        /* Add this to your GLOBAL STYLES section */
            .no-scroll {
                overflow: hidden !important;
            }
        
        /* =================================================================== */
        /*                      START: LOADER STYLES                         */
        /* =================================================================== */

        .loader-container {
            position: absolute;
            inset: 0;
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(5px);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            color: var(--text-secondary);
            border-radius: 0; /* Full screen inside section */
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Special Dashboard Quote Loader (Unaffected) */
        #dashboard-loader {
            background: linear-gradient(135deg, #000000, var(--bg-dark));
        }
        .quote-wrapper {
            max-width: 600px;
            text-align: center;
            padding: 2rem;
            animation: fadeInQuote 1s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes fadeInQuote {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quote-text {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 1.5rem;
        }
        .quote-author {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--primary-color);
            text-align: right;
            margin-right: 2rem;
        }

/* NEW: Stretch Loader Animation */
.stretch-loader-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 40px; /* Set a fixed height for the bars */
    margin-bottom: 1.5rem;
}
.loader-bar {
    width: 6px;
    height: 100%; /* Will scale within the container's height */
    margin: 0 4px;
    background-color: var(--primary-color);
    border-radius: 3px;
    display: inline-block;
    animation: stretch 1.2s infinite ease-in-out;
}
.loader-bar:nth-child(2) { animation-delay: -1.1s; }
.loader-bar:nth-child(3) { animation-delay: -1.0s; }
.loader-bar:nth-child(4) { animation-delay: -0.9s; }

@keyframes stretch {
    0%, 40%, 100% {
        transform: scaleY(0.4);
    }
    20% {
        transform: scaleY(1.0);
    }
}

.loader-text {
    font-size: 1rem;
    color: var(--text-secondary);
    font-weight: 500;
    letter-spacing: 0.5px;
    text-align: center;
}

        /* =================================================================== */
        /*                       END: LOADER STYLES                          */
        /* =================================================================== */

        /* =================================================================== */
        /*                 DESKTOP NAVIGATION (MACOS STYLE)                    */
        /* =================================================================== */
        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .desktop-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            height: var(--nav-height);
            padding: 0 2rem;
            background: rgba(13, 17, 23, 0.7);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
        }
        
        .nav-menu {
            display: flex;
            gap: 0.5rem;
            position: relative;
        }
        
        .nav-item {
            position: relative;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            color: var(--primary-color);
            background: rgba(76, 250, 157, 0.15);
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            border-radius: 3px;
            background: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-glow);
        }
        
        .nav-actions {
            position: absolute;
            right: 2rem;
            display: flex;
            align-items: center;
        }
        
        /* [REMOVED] Old .add-button styles are no longer needed */
        
        /* =================================================================== */
        /*             START: NEW MOBILE NAVIGATION V3 STYLES                  */
        /* =================================================================== */
        .new-mobile-nav-wrapper {
            display: none; /* Hidden by default, shown in media query */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-mobile-height);
            z-index: 1000;
        }

        #new-mobile-nav-bg {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .nav-bg-path {
            fill: var(--bg-panel);
            stroke: var(--border-color);
            stroke-width: 1;
            transition: fill 0.3s ease;
        }

        .new-mobile-nav-items {
            position: relative;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
            padding: 0 1rem;
            z-index: 1001;
        }

        .new-mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            flex-grow: 1;
            flex-basis: 0;
            height: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            padding-top: 10px; /* Adjust to fit inside the notch area */
        }

        /* [REMOVED] The mobile FAB spacer and button are replaced by the Action Hub */

        .new-mobile-nav-item i {
            font-size: 1.4rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .new-mobile-nav-item span {
            font-size: 0.7rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .new-mobile-nav-item.active i,
        .new-mobile-nav-item.active span,
        .new-mobile-nav-item:hover i,
        .new-mobile-nav-item:hover span {
            color: var(--primary-color);
        }

        .new-mobile-nav-item:hover {
            transform: translateY(-3px);
        }

        /* "More" Options Panel */
        .more-options-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .more-options-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            padding: 1rem 1.5rem 1.5rem;
            z-index: 1999;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            border-top: 1px solid var(--border-color);
        }

        .more-options-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .more-options-header h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .more-options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .more-option-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-panel);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .more-option-item:hover {
            background: rgba(76, 250, 157, 0.1);
            transform: translateY(-5px);
            color: var(--primary-color);
        }
        .more-option-item i {
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        .more-option-item span {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* State when "More" panel is open */
        body.more-panel-open .more-options-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        body.more-panel-open .more-options-panel {
            transform: translateY(0);
        }

        /* =================================================================== */
        /*              END: NEW MOBILE NAVIGATION V3 STYLES                   */
        /* =================================================================== */
        
        /* =================================================================== */
        /*        START: BEAUTIFUL CENTER ACTION HUB STYLES (FINAL)            */
        /* =================================================================== */

        .center-hub-fab {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background: radial-gradient(circle, #57ffae, var(--primary-color));
            color: #000; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 5px 25px var(--primary-glow);
            cursor: pointer;
            z-index: 2000;
            transition: all 0.4s var(--easing-snap);
            animation: breathe 2.5s infinite ease-in-out;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); box-shadow: 0 5px 25px var(--primary-glow); }
            50% { transform: scale(1.05); box-shadow: 0 8px 35px var(--primary-glow); }
        }
        .center-hub-fab:hover {
            transform: scale(1.1) rotate(-15deg);
            animation-play-state: paused;
        }

        .center-hub-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px); z-index: 2999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .center-hub-overlay.visible { 
            opacity: 1; 
            pointer-events: auto; 
        }

        .center-hub-panel {
            position: fixed; top: 50%; left: 50%; width: 90%; max-width: 540px;
            background: var(--bg-card);
            border-radius: 1.5rem; padding: 1.5rem 2rem;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5); z-index: 3000;
            opacity: 0; pointer-events: none;
            transform: translate(-50%, -50%) scale(0.95);
            transition: all 0.4s var(--easing-snap);
            max-height: 85vh;
            overflow: hidden; /* prevent scrollbar during opening animation */
        }
        /* Enable scrolling only after animation completes */
        .center-hub-panel.scroll-ready { overflow: auto; }
        .center-hub-overlay.visible .center-hub-panel {
            opacity: 1; pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .center-hub-header {
            position: relative;
            text-align: center;
            margin-bottom: 2rem;
        }
        .center-hub-panel h4 {
            margin: 0; font-size: 1.5rem; font-weight: 600;
            letter-spacing: 0.5px;
        }
        .close-center-hub-btn {
            position: absolute; top: 50%; right: 0; transform: translateY(-50%);
            background: none; border: none; font-size: 2.2rem;
            color: var(--text-secondary); cursor: pointer;
            transition: all 0.2s ease; line-height: 1;
        }
        .close-center-hub-btn:hover { color: var(--primary-color); transform: translateY(-50%) rotate(90deg); }

        .hub-card-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;
            padding: 0 0.25rem;
        }
        
        #sleepCardStatic, #sleepCardLive {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .hub-card {
            background: linear-gradient(145deg, #212121, #161616);
            border-radius: 1.25rem;
            padding: 1rem; aspect-ratio: 1 / 1;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0; transform: translateY(30px) scale(0.95);
        }
        .center-hub-overlay.visible .hub-card {
             animation: card-fade-in 0.6s var(--easing-snap) forwards;
        }
        .center-hub-overlay.visible .hub-card:nth-child(1) { animation-delay: 0.1s; }
        .center-hub-overlay.visible .hub-card:nth-child(2) { animation-delay: 0.2s; }
        .center-hub-overlay.visible .hub-card:nth-child(3) { animation-delay: 0.3s; }
        @keyframes card-fade-in {
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .hub-card:hover { 
            transform: translateY(-10px);
            background: linear-gradient(145deg, #2c2c2c, #222222);
            box-shadow: 0 8px 30px rgba(76, 250, 157, 0.25);
        }
        
        .hub-card.tracking-active {
            box-shadow: 0 0 25px var(--primary-glow);
        }

        .hub-card-icon {
            font-size: 2.75rem; color: var(--primary-color);
            margin-bottom: 0.75rem;
            transition: all 0.3s var(--easing-snap);
            text-shadow: 0 0 15px transparent;
        }
        .hub-card:hover .hub-card-icon {
            transform: scale(1.2) translateY(-5px);
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .hub-card-title {
            font-size: 1rem; font-weight: 600;
            color: var(--text-primary);
        }
        .hub-card-desc {
            font-size: 0.8rem; font-weight: 400;
            color: var(--text-secondary); margin-top: 4px;
        }
        .hub-card-timer {
            font-size: 1.5rem; font-weight: 600;
            font-family: 'Courier New', monospace;
            margin-top: 0.5rem; color: var(--text-primary);
        }

        @media (max-width: 600px) {
            .center-hub-fab { bottom: 15px; right: 15px; }
            .center-hub-panel { width: 86%; max-width: 360px; padding: 1rem 1rem; border-radius: 1rem; max-height: 80vh; }
            /* Keep vertical stack; avoid scroll; widen slightly */
            .hub-card-grid { grid-template-columns: 1fr; gap: 0.7rem; padding: 0 0.25rem; justify-items: center; }
            .hub-card { width: 94%; aspect-ratio: auto; min-height: 84px; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.8rem 0.9rem; }
            .hub-card-icon { font-size: 1.8rem; margin-bottom: 0; }
            .hub-card-title { font-size: 1rem; }
            .hub-card-desc { font-size: 0.82rem; }
            /* Ensure sleep card keeps same vertical stack */
            #sleepTrackerCard #sleepCardStatic, #sleepTrackerCard #sleepCardLive { flex-direction: column; align-items: center; gap: 0.5rem; }
        }
        
        /* =================================================================== */
        /*        END: BEAUTIFUL CENTER ACTION HUB STYLES (FINAL)              */
        /* =================================================================== */
        
        /* =================================================================== */
        /*                   CONTENT & SECTION STYLES                          */
        /* =================================================================== */
        .content-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-top: var(--nav-height);
            box-sizing: border-box;
        }
        
        .main-content {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            height: 100%;
        }
        
        .content-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            animation: fadeIn 0.5s ease-in-out;
            overflow-y: auto;
            padding-bottom: 2rem;
            box-sizing: border-box;
        }
        
        .content-section.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Hide scrollbar but keep functionality */
        .content-section::-webkit-scrollbar {
            display: none;
        }
        
        .content-section {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Generic scrollbar styling */
        .generic-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .generic-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .generic-scrollbar::-webkit-scrollbar-thumb { 
            background-color: var(--border-color); 
            border-radius: 4px; border: 2px solid transparent; 
            background-clip: content-box; 
        }
        .generic-scrollbar::-webkit-scrollbar-thumb:hover { background-color: var(--primary-color); }
        .content-section { scrollbar-color: var(--border-color) transparent; scrollbar-width: thin; }

        /* Improved scrollbar styling */
        .generic-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
        }
        .generic-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color-dark);
        }

        /* =================================================================== */
        /*                       DASHBOARD PLACEHOLDER                         */
        /* =================================================================== */
        .dashboard-placeholder { 
            text-align: center; 
            color: var(--text-secondary); 
            padding-top: 5rem;
        }
        .dashboard-placeholder h1 { 
            font-size: 3rem; 
            font-weight: 700; 
            color: var(--text-primary); 
            margin-bottom: 0.5rem; 
        }
        .dashboard-placeholder p { 
            font-size: 1.2rem; 
            max-width: 500px; 
        }
        .dashboard-placeholder i { 
            color: var(--primary-color); 
        }
        
        /* =================================================================== */
        /*                       FORM POPUP & OVERLAYS                         */
        /* =================================================================== */
        .form-popup-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(8px); 
            z-index: 4000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            animation: fadeInSuccess 0.3s; 
        }
        .form-popup-overlay.visible { display: flex; }

        @keyframes popupEnter { to { transform: scale(1); opacity: 1; } }

        .form-popup-overlay .form-container { 
            position: relative; 
            margin-top: 0; 
            transform: scale(0.95); 
            opacity: 0; 
            animation: popupEnter 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; 
        }
        .close-popup-btn { 
            position: absolute; top: 1rem; right: 1.2rem; 
            background: none; border: none; 
            font-size: 2.2rem; font-weight: 300; line-height: 1; 
            color: var(--text-secondary); cursor: pointer; 
            transition: all 0.2s ease; z-index: 10; 
        }
        .close-popup-btn:hover { 
            color: var(--primary-color); 
            transform: rotate(90deg); 
        }
        .form-container { 
            background: var(--bg-card); 
            backdrop-filter: blur(12px); 
            border: 1px solid var(--border-color); 
            border-radius: 1rem; 
            padding: 2rem; width: 100%; 
            max-width: 550px; 
            margin-top: 2rem; 
        }
        .tab-controls { 
            display: flex; 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: 2rem; 
        }
        .tab-btn { 
            flex: 1; padding: 1rem; 
            background: none; border: none; 
            color: var(--text-secondary); 
            font-size: 1.1rem; font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            position: relative; 
        }
        .tab-btn .mr-2 { margin-right: 0.5rem; }
        .tab-btn:after { 
            content: ''; position: absolute; bottom: -2px; left: 0; 
            width: 100%; height: 2px; background: var(--primary-color); 
            transform: scaleX(0); transition: transform 0.3s ease; 
        }
        .tab-btn.active { color: var(--primary-color); }
        .tab-btn.active:after { 
            transform: scaleX(1); 
            box-shadow: 0 0 15px var(--primary-glow); 
        }
        .step-form { display: none; } 
        .step-form.active { display: block; }
        .form-step { animation: slideIn 0.5s cubic-bezier(0.25, 1, 0.5, 1); }

        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(50px); } 
            to { opacity: 1; transform: translateX(0); } 
        }

        .step-title { 
            font-size: 1.5rem; font-weight: 600; color: var(--text-primary); 
            margin-bottom: 1.5rem; text-align: center; display: flex; 
            align-items: center; justify-content: center; gap: 0.75rem; 
        }
        .form-group { 
            position: relative; 
            margin-bottom: 1.2rem; 
        }
        .form-input, .form-select { 
            width: 100%; padding: 12px 15px 12px 45px; 
            background-color: var(--bg-input); 
            border: 1px solid var(--border-color); border-radius: 0.5rem; 
            color: var(--text-primary); font-size: 1rem; 
            transition: all 0.3s ease; box-sizing: border-box; 
        }
        .form-input:focus, .form-select:focus { 
            outline: none; border-color: var(--primary-color); 
            box-shadow: 0 0 15px rgba(76, 250, 157, 0.2); 
        }
        .form-input::-webkit-outer-spin-button, .form-input::-webkit-inner-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        .form-input[type=number] { -moz-appearance: textfield; }
        .form-icon { 
            position: absolute; left: 15px; top: 13px; 
            color: var(--text-secondary); transition: color 0.3s ease; 
        }
        .form-input:focus ~ .form-icon { color: var(--primary-color); }
        .checkbox-group { 
            display: flex; align-items: center; gap: 0.75rem; 
            padding: 10px 15px; background-color: var(--bg-input); 
            border: 1px solid var(--border-color); border-radius: 0.5rem; 
            cursor: pointer; 
        }
        .form-checkbox { 
            width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer; 
        }
        .checkbox-group label { 
            color: var(--text-primary); cursor: pointer; font-size: 1rem; user-select: none; 
        }
        .progress-bar { 
            width: 100%; height: 6px; background-color: var(--border-color); 
            border-radius: 3px; margin: 1.5rem 0; overflow: hidden; 
        }
        .progress-bar-fill { 
            width: 0%; height: 100%; background-color: var(--primary-color); 
            border-radius: 3px; transition: width 0.4s ease; 
        }
        .step-nav { 
            display: flex; justify-content: space-between; 
            align-items: center; margin-top: 1rem; 
        }
        .nav-btn { 
            background: none; border: 2px solid var(--border-color); 
            color: var(--text-secondary); font-size: 1rem; font-weight: 600; 
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; 
            cursor: pointer; transition: all 0.3s ease; 
        }
        .nav-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .nav-btn.submit-btn { 
            border-color: var(--primary-color); background: var(--primary-color); 
            color: #000; box-shadow: 0 0 20px var(--primary-glow); 
        }
        .nav-btn.submit-btn:disabled { 
            background: var(--bg-input); border-color: var(--border-color); 
            color: var(--text-secondary); cursor: not-allowed; box-shadow: none; 
        }
        .success-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; 
            align-items: center; justify-content: center; z-index: 9999; 
            animation: fadeInSuccess 0.3s; 
        }
        @keyframes fadeInSuccess { from { opacity: 0; } to { opacity: 1; } }
        .success-animation { text-align: center; }
        .checkmark { 
            width: 100px; height: 100px; border-radius: 50%; display: block; 
            stroke-width: 4; stroke: var(--primary-color); 
            stroke-miterlimit: 10; margin: 0 auto; 
        }
        .checkmark__circle { 
            stroke-dasharray: 166; stroke-dashoffset: 166; 
            animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; 
        }
        .checkmark__check { 
            transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: -48; 
            animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; 
        }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }

        /* =================================================================== */
        /*                          LOG FORM STYLES                            */
        /* =================================================================== */
        /* --- Daily Log Form Styles --- */
        .prayer-selector { 
            display: flex; justify-content: center; align-items: center; 
            gap: 1rem; padding: 1rem 0; 
        }
        .prayer-circle { 
            width: 40px; height: 40px; border-radius: 50%; 
            background-color: var(--bg-input); border: 2px solid var(--border-color); 
            cursor: pointer; transition: all 0.3s ease; 
        }
        .prayer-circle.active { 
            background-color: var(--primary-color); 
            border-color: var(--primary-color-dark); 
            box-shadow: 0 0 15px var(--primary-glow); 
        }
        .discipline-check-group { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 12px 15px; background-color: var(--bg-input); 
            border: 1px solid var(--border-color); border-radius: 0.5rem; 
        }
        .discipline-check-group label { 
            font-weight: 500; color: var(--text-primary); 
            display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
        }
        .toggle-switch { 
            position: relative; display: inline-block; width: 50px; height: 28px; 
        }
        .toggle-switch input { display: none; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: var(--border-color); transition: .4s; border-radius: 28px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 20px; width: 20px; 
            left: 4px; bottom: 4px; background-color: var(--text-primary); 
            transition: .4s; border-radius: 50%; 
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- Practice Log Form Styles (MODIFIED) --- */
        .practice-form-section { 
            border: 1px solid var(--border-color); border-radius: 0.75rem; 
            padding: 1rem 1.25rem; margin-bottom: 1.5rem; 
        }
        .practice-form-section-header { 
            font-size: 1.1rem; font-weight: 600; color: var(--primary-color); 
            margin: 0 0 1.25rem 0; display: flex; align-items: center; gap: 0.75rem; 
        }
        .time-input-container { display: flex; gap: 1rem; align-items: center; }
        .time-input-wrapper { flex: 1; position: relative; }
        .time-input-wrapper .form-input { padding-left: 15px; text-align: center; }
        .time-input-wrapper label { 
            position: absolute; right: 15px; top: 50%; 
            transform: translateY(-50%); color: var(--text-secondary); 
        }
        .time-suggestion-chips { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        .time-suggestion-chip { 
            background-color: var(--bg-input); border: 1px solid var(--border-color); 
            color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; 
            padding: 4px 10px; border-radius: 0.5rem; cursor: pointer; 
            transition: all 0.2s ease;flex-grow: 1; 
        }
        .time-suggestion-chip:hover { border-color: var(--primary-color); color: var(--primary-color); }
        
        /* --- Arena Modal (Subject/Chapter Selection) --- */
        .arena-modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); 
            z-index: 6000; display: none; align-items: center; justify-content: center; 
        }
        .arena-modal-overlay.visible { display: flex; }
        .arena-modal-container { 
            background: var(--bg-card); border: 1px solid var(--border-color); 
            border-radius: 1rem; width: 90%; max-width: 700px; height: 70vh; max-height: 500px; 
            display: flex; overflow: hidden; position: relative; transform: scale(0.95); opacity: 0; 
            animation: popupEnter 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; 
        }
        .arena-panel { 
            padding: 1.5rem; flex-basis: 50%; 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; 
        }
        .arena-panel-header { 
            font-size: 1.5rem; font-weight: 600; color: var(--text-primary); 
            margin: 0 0 1.5rem 0; padding-bottom: 1rem; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; align-items: center; justify-content: space-between; 
        }
        #arenaSubjectsPanel { border-right: 1px solid var(--border-color); }
        #arenaChaptersPanel { 
            position: absolute; top: 0; right: 0; width: 50%; height: 100%; 
            transform: translateX(100%); background: var(--bg-card); 
        }
        .arena-modal-container.chapters-visible #arenaSubjectsPanel { transform: translateX(-100%); }
        .arena-modal-container.chapters-visible #arenaChaptersPanel { transform: translateX(0); }
        .arena-list { list-style: none; padding: 0; margin: 0; }
        .arena-list-item { 
            padding: 1rem 1.25rem; margin-bottom: 0.5rem; background: var(--bg-input); 
            border-radius: 0.5rem; border: 1px solid var(--border-color); font-weight: 500; 
            cursor: pointer; transition: all 0.2s ease; display: flex; 
            justify-content: space-between; align-items: center; 
        }
        .arena-list-item:hover { 
            border-color: var(--primary-color); background-color: rgba(76, 250, 157, 0.1); 
            color: var(--primary-color); 
        }
        .arena-list-item.selected { 
            border-color: var(--primary-color); background: var(--primary-color); color: #000; 
        }
        .btn-back-to-subjects { 
            background: none; border: none; font-size: 1rem; color: var(--text-secondary); 
            cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0; 
        }
        .btn-back-to-subjects:hover { color: var(--primary-color); }
        #arenaSelectionDisplay { 
            position: relative; width: 100%; text-align: left; 
            padding: 12px 15px; background-color: var(--bg-input); 
            border: 1px solid var(--border-color); border-radius: 0.5rem; 
            color: var(--text-primary); font-size: 1rem; cursor: pointer; 
            transition: all 0.3s ease; box-sizing: border-box; 
        }
        #arenaSelectionDisplay > i { 
            position: absolute; right: 15px; top: 50%; 
            transform: translateY(-50%); color: var(--text-secondary); 
        }
        #arenaSelectionDisplay:hover { border-color: var(--primary-color); }
        #arenaSelectionDisplay .placeholder { color: var(--text-secondary); }
        #arenaSelectionDisplay .subject-display { font-weight: 600; color: var(--primary-color); }
        #arenaSelectionDisplay .chapter-display { color: var(--text-primary); }
        
        /* ============================================== */
        /*         START: NEW REPORT ENGINE STYLES        */
        /* ============================================== */

        #reports.content-section {
            justify-content: flex-start;
            align-items: center;
            padding: 1rem; /* Reduced padding */
            box-sizing: border-box;
        }

        #report-config-wizard {
            width: 100%;
            max-width: 950px; /* Slightly wider for 4 cards */
            text-align: center;
            padding: 0 1rem;
            box-sizing: border-box;
        }

        .wizard-header {
            margin-bottom: 2rem; /* Reduced margin */
        }

        .wizard-header h2 {
            font-size: 2.2rem; /* Compact size */
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .wizard-header h2 i {
            color: var(--primary-color);
        }

        .wizard-header p {
            font-size: 1rem; /* Compact size */
            color: var(--text-secondary);
            max-width: 450px;
            margin: 0 auto;
        }

        .wizard-step {
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease forwards;
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-step h4 {
            font-size: 1.2rem; /* Compact size */
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .wizard-step h4 .step-num {
            background: var(--primary-color);
            color: #000;
            width: 28px; /* Compact size */
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .subject-selection-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 columns on desktop */
            gap: 1.5rem;
        }

        .subject-card {
            background: var(--bg-panel);
            border: 2px solid transparent; /* Transparent border for size consistency */
            border-radius: 1rem;
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .subject-card .icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .subject-card .icon-wrapper i {
            font-size: 2.2rem;
            transition: all 0.3s ease;
        }

        .subject-card.physics .icon-wrapper { background-color: rgba(96, 165, 250, 0.15); }
        .subject-card.physics .icon-wrapper i { color: #60a5fa; }
        .subject-card.chemistry .icon-wrapper { background-color: rgba(239, 68, 68, 0.15); }
        .subject-card.chemistry .icon-wrapper i { color: #f87171; }
        .subject-card.math .icon-wrapper { background-color: rgba(251, 146, 60, 0.15); }
        .subject-card.math .icon-wrapper i { color: #fb923c; }
        .subject-card.biology .icon-wrapper { background-color: rgba(76, 250, 157, 0.15); }
        .subject-card.biology .icon-wrapper i { color: var(--primary-color); }

        .subject-card span {
            font-size: 1.1rem; /* Compact size */
            font-weight: 600;
            color: var(--text-primary);
        }

        .subject-card:hover {
            transform: translateY(-8px);
            background: var(--bg-card);
        }

        .subject-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 25px var(--primary-glow);
            transform: translateY(-8px);
        }

        .chapter-selection-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem; /* Reduced gap */
        }

        .chapter-chip {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.6rem 1.2rem; /* Compact padding */
            border-radius: 50px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .chapter-chip:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        .chapter-chip.selected {
            background: var(--primary-color);
            color: #000;
            font-weight: 600;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        #report-step-actions {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .btn-generate-new {
            background: var(--primary-color);
            color: #000;
            font-weight: 600; /* Adjusted weight */
            border: none;
            padding: 0.8rem 2rem; /* Compact padding */
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px var(--primary-glow);
            font-size: 1rem; /* Compact size */
        }

        .btn-generate-new:hover {
            background: var(--primary-color-dark);
            transform: translateY(-3px);
        }

        .btn-generate-new:disabled {
            background: var(--bg-input);
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-reset-wizard {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.8rem 1.8rem; /* Compact padding */
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem; /* Compact size */
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-reset-wizard:hover {
            border-color: #f87171;
            color: #f87171;
        }

        /* Report Results View Styles */
       /* Replace the old rule with this one */
#report-results-view {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    /* The "overflow: hidden;" line is now gone. */
}
        
        #new-report-loader {
            position: absolute;
            inset: 0; /* A modern way for top: 0, left: 0, right: 0, bottom: 0 */
            background: rgba(18, 18, 18, 0.85); /* Dark, semi-transparent background */
            backdrop-filter: blur(4px);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem; /* Adds space between atom and text */
            color: var(--text-secondary);
            border-radius: 0;
        }
        
        .results-header {
            flex-shrink: 0;
            padding: 0 1rem 1.5rem 1rem;
        }

        .btn-back-to-wizard {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-back-to-wizard:hover {
            border-color: var(--primary-color);
            background: var(--bg-input);
        }

        #new-report-results-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 1rem 2rem 1rem; /* Add bottom padding */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            align-content: flex-start;
        }

        .report-insight-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            opacity: 0;
            transform: translateY(20px);
            animation: cardEnter 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }
        @keyframes cardEnter { to { opacity: 1; transform: translateY(0); } }

        .ric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .ric-title h4 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .ric-title span {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .ric-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid var(--border-color);
        }

        .ric-stat-item {
            text-align: center;
        }

        .ric-stat-item i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .ric-stat-item .fa-hourglass-half { color: #a78bfa; }
        .ric-stat-item .fa-bullseye { color: #f87171; }
        .ric-stat-item .fa-file-signature { color: #3b82f6; }
        .ric-stat-item .fa-calendar-check { color: #60a5fa; }


        .ric-stat-item .ric-stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .ric-stat-item .ric-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ric-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem 1.5rem; /* row-gap column-gap */
        }

        .ric-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .ric-detail-item label {
            color: var(--text-secondary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ric-detail-item span {
            color: var(--text-primary);
            font-weight: 600;
            background-color: var(--bg-input);
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
        }

        .report-confidence-badge { 
            padding: 0.3rem 0.8rem; 
            border-radius: 20px; 
            font-weight: 600; 
            font-size: 0.8rem; 
        }
        .confidence-Very-Confident { background-color: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .confidence-Confident { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .confidence-Somewhat-Confident { background-color: rgba(245, 158, 11, 0.2); color: #facc15; }
        .confidence-Not-Confident { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }
        .confidence-Not-Tracked { background-color: rgba(107, 114, 128, 0.2); color: #9ca3af; }

        /* ============================================== */
        /*          END: NEW REPORT ENGINE STYLES         */
        /* ============================================== */
     
        /* ============================================== */
        /*       START: NEW DASHBOARD & ANALYTICS STYLES     */
        /* ============================================== */
        
        /* --- HEY HEY ARMY! HERE ARE THE FIXES --- */

        /* FIX 1: Flex container for summary cards */
        .summary-card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            flex: 1;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* FIX 2: Dynamic height for summary chart */
        .summary-chart {
            min-height: 150px; 
            margin-top: auto;
            flex-grow: 1;
            display: flex;
            align-items: flex-end;
        }
        
        /* FIX 3: Remove bottom margin on last insight item */
        .actionable-insight-item:last-child {
            margin-bottom: 0;
        }
        
        /* --- END OF FIXES --- */

        #dashboard.content-section {
            padding: 1.5rem;
            align-items: stretch;
            justify-content: flex-start;
            box-sizing: border-box;
            height: 100%;
            overflow-y: auto;
        }
        #analytics.content-section { padding: 0; align-items: flex-start; }

        .analytics-container { 
            width: 100%; height: 100%; display: flex; 
            flex-direction: column; position: relative; 
            overflow-x: hidden; /* prevent stray horizontal scroll */
        }
        .analytics-tabs { 
            display: flex; padding: 0 2rem; gap: 0; 
            border-bottom: 1px solid var(--border-color); flex-shrink: 0; 
            width: 100%; justify-content: stretch;
        }
        .analytics-tab-btn { 
            flex: 1; text-align: center; display: flex; align-items: center; 
            justify-content: center; gap: 0.75rem; padding: 1rem 1.5rem; 
            background: none; border: none; border-bottom: 3px solid transparent; 
            color: var(--text-secondary); font-size: 1.0rem; font-weight: 600; 
            cursor: pointer; transition: all 0.3s ease; 
        }
        .analytics-tab-btn:hover { color: var(--text-primary); }
        .analytics-tab-btn.active { 
            color: var(--primary-color); 
            border-bottom-color: var(--primary-color); 
        }
        .analytics-content { 
            flex-grow: 1; overflow-y: auto; overflow-x: hidden; 
            position: relative; padding: 2rem; box-sizing: border-box;
            width: 100%;
        }
        .analytics-pane { display: none; animation: fadeIn 0.5s; }
        .analytics-pane.active {
            display: flex; width: 100%; box-sizing: border-box; overflow-x: hidden;
            flex-direction: column;
            gap: 1.5rem;
        }        

        /* Dashboard Grid Layout - 8 metric cards */
        #dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: minmax(200px, auto);
            gap: 2rem;
            width: 100%;
            max-width: 1400px;
            padding: 1rem;
            margin: 0 auto 2rem;
            box-sizing: border-box;
        }
                
        /* Base Metric Card Styles */
        .metric-card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
                
        .metric-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .metric-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover .metric-icon {
            transform: scale(1.1);
        }
        
        .metric-value-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover .metric-value {
            transform: scale(1.05);
        }
        
        .metric-value small {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .metric-chart {
            flex-grow: 1;
            position: relative;
            height: 100px;
            margin-top: auto;
        }
        
        /* Individual metric card styles */
        .metric-exam-score .metric-icon { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .metric-syllabus .metric-icon { background: rgba(76, 250, 157, 0.15); color: var(--primary-color); }
        .metric-best-subject .metric-icon { background: rgba(251, 146, 60, 0.15); color: #fb923c; }
        .metric-streak .metric-icon { background: rgba(96, 165, 250, 0.15); color: #60a5fa; }
        .metric-efficiency .metric-icon { background: rgba(167, 139, 250, 0.15); color: #a78bfa; }
        .metric-productive .metric-icon { background: rgba(76, 250, 157, 0.15); color: var(--primary-color); }
        .metric-wasted .metric-icon { background: rgba(248, 113, 113, 0.15); color: #f87171; }
        .metric-screen-time .metric-icon { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        
        /* Summary Cards Section - Enhanced */
        .summary-section {
            width: 100%;
            max-width: 1400px;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin: 0 auto;
            box-sizing: border-box;
        }
        .summary-row {
            display: flex;
            gap: 2rem;
            width: 100%;
        }
        
        .summary-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .summary-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }
        
        .summary-card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .summary-card-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .summary-card:hover .summary-card-title i {
            transform: scale(1.2);
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .summary-stat {
            text-align: center;
            flex: 1;
            padding: 1rem;
            background: var(--bg-input);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .summary-stat:hover {
            background: rgba(76, 250, 157, 0.1);
            transform: translateY(-3px);
        }
        
        .summary-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .summary-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Enhanced Actionable Insights */
        .actionable-insight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            background: var(--bg-input);
            transition: all 0.3s ease;
        }
        
        .actionable-insight-item:hover {
            background: rgba(76, 250, 157, 0.1);
            transform: translateX(5px);
        }
        
        .actionable-insight-item i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-top: 0.25rem;
        }
        
        .insight-content h5 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .insight-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* Enhanced Performance Forecast */
        .forecast-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        
        .forecast-score {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover .forecast-score {
            transform: scale(1.1);
        }
        
        .forecast-label {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .forecast-chart {
            width: 100%;
            height: 120px;
        }
        
        /* Enhanced Weekly Report */
        .weekly-report-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            background: var(--bg-input);
            transition: all 0.3s ease;
        }
        
        .weekly-report-item:hover {
            background: rgba(76, 250, 157, 0.1);
            transform: translateX(5px);
        }
        
        .weekly-report-item i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .weekly-report-item.report-focus i {
            color: #f87171;
        }
        
        .report-content {
            flex: 1;
        }
        
        .report-content h5 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .report-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Other Analytics Panes Styles */
        .analysis-grid { display: grid; grid-template-columns: 1fr 3fr; gap: 1.5rem; }
        .analysis-card { 
            background: var(--bg-card); border: none; 
            border-radius: 1rem; padding: 1.5rem; display: flex; 
            flex-direction: column; transition: all 0.3s ease; 
        }
        .analysis-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .analysis-card-header { 
            font-size: 1.2rem; font-weight: 600; color: var(--text-primary); 
            margin: 0 0 1.25rem 0; padding-bottom: 1rem; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; align-items: center; gap: 0.75rem; 
        }
        .analysis-filters { display: flex; flex-direction: column; gap: 1rem; }
        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-group label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
        .filter-group .form-select, .filter-group .form-input { 
            padding: 0.75rem 1rem; font-size: 0.9rem; 
            background-color: var(--bg-dark); border-color: #3a3a3a; padding-left: 1rem; 
        }
        .custom-date-range { display: none; gap: 1rem; align-items: center; margin-top: 0.5rem; }
        .custom-date-range.active { display: flex; flex-direction: column; gap: 0.5rem; align-items: stretch; }
        .custom-date-range input {width: 100%; box-sizing: border-box;}
        .chart-wrapper { position: relative; min-height: 450px; flex-grow: 1; display:flex; flex-direction:column; }
        .chart-wrapper-placeholder { 
            display: flex; align-items: center; justify-content: center; 
            flex-grow: 1; text-align: center; color: var(--text-secondary); 
        }
        #syllabusPieChartContainer { display: flex; justify-content: center; align-items: center; }
        .chart-spinner { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 2rem; color: var(--primary-color); 
            animation: fa-spin 1.5s infinite linear; display: none; 
        }
        .dna-metrics-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            justify-content: space-around;
        }
        .dna-metric-card {
            background: var(--bg-card);
            border: none;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
            transition: all 0.3s ease;
        }
        .dna-metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .dna-metric-card h5 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .dna-metric-card .value {
            font-size: 2rem;
            font-weight: 600;
        }
        .dna-metric-card .value.positive { color: #4ade80; }
        .dna-metric-card .value.negative { color: #f87171; }
        
        /* Styles for the new Habits/Daily Performance Tab */
        .analysis-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        #pane-analytics-habits .analysis-filters {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 1.5rem;
            padding: 1rem;
            background: var(--bg-panel);
            border-radius: .75rem;
            border: 1px solid var(--border-color);
        }
        .metric-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-left: auto;
        }
        .metric-toggle-group .checkbox-group {
            padding: 5px 10px;
            font-size: 0.9rem;
            margin-bottom: 0;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .metric-toggle-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .metric-toggle-group-vertical .checkbox-group {
            padding: 8px 12px;
            background-color: var(--bg-dark);
        }
        /* =============================================== */
        /*        END: NEW DASHBOARD & ANALYTICS STYLES    */
        /* =============================================== */
        
        /* =============================================== */
        /*    START: COMMAND CENTER ANALYTICS UI STYLES    */
        /* =============================================== */
        #analytics .analytics-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .analytics-key-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }
        .analytics-key-metrics-grid .metric-card {
            border: none;
            background: var(--bg-card); /* Solid Card Style */
        }
        .analytics-interactive-card, .analytics-recommendation-card {
            background: var(--bg-card); /* Solid Card Style */
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border: none;
        }
        .analytics-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .analytics-card-header h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .analytics-filters {
            display: flex;
            gap: 1rem;
        }
        .form-select-sm {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .analytics-chart-container {
            position: relative;
        }
        .analytics-split-container {
            display: flex;
            gap: 1.5rem;
            height: 300px;
        }
        .analytics-pie-container {
            flex: 0 0 300px;
            position: relative;
        }
        .analytics-list-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .chapter-progress-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background-color: var(--bg-input);
            border-radius: 0.5rem;
        }
        .chapter-progress-item span {
            flex: 1;
            font-weight: 500;
        }
        .chapter-progress-bar {
            width: 120px;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .chapter-progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
        }
        .recommendation-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .recommendation-list-item {
            display: flex;
            align-items: flex-start;
            gap: 1.25rem;
            padding: 1.25rem;
            background: var(--bg-input);
            border-radius: 0.75rem;
            border-left: 4px solid;
        }
        .recommendation-list-item.priority-high { border-color: #ef4444; }
        .recommendation-list-item.priority-medium { border-color: #f59e0b; }
        .recommendation-list-item.priority-low { border-color: #3b82f6; }

        .recommendation-list-item i {
            font-size: 1.5rem;
            margin-top: 0.25rem;
            width: 24px;
            text-align: center;
        }
        .recommendation-list-item.priority-high i { color: #ef4444; }
        .recommendation-list-item.priority-medium i { color: #f59e0b; }
        .recommendation-list-item.priority-low i { color: #3b82f6; }
        
        .recommendation-content h5 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        .recommendation-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        
        .time-filter-group {
    display: flex;
    gap: 0.5rem;
    background-color: var(--bg-input);
    padding: 4px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
.time-filter-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-weight: 500;
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.time-filter-btn:hover {
    background-color: var(--border-color);
    color: var(--text-primary);
}
.time-filter-btn.active {
    background-color: var(--primary-color);
    color: #000;
    font-weight: 600;
    box-shadow: 0 0 10px var(--primary-glow);
}
        /* =============================================== */
        /*      END: COMMAND CENTER ANALYTICS UI STYLES    */
        /* =============================================== */
        
 
         /* =============================================== */
        /*           START: GENERIC REUSABLE STYLES        */
        /* (These support the main section styles) */
        /* =============================================== */
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            color: #000;
            font-weight: 600;
            padding: 0.7rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-color-dark);
            transform: translateY(-2px);
        }

        
        /* =============================================== */
        /*           START: EXAMS SECTION STYLES (FINAL FIX) */
        /* =============================================== */
        
        /* Main Layout: Ensures single scroll area */
        #exams.content-section { padding: 0; align-items: flex-start; }
        .exams-container { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column;
        }
        
        /* Header: Simplified to match image */
        .section-header {
            padding: 1rem 1.5rem; /* Adjusted padding */
        }
        .btn-icon-header {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-icon-header:hover {
            background: var(--primary-color);
            color: #000;
            border-color: var(--primary-color);
        }
        
        /* Scrollable Content Area: This is the key to fixing the layout */
        .exam-list { 
            flex-grow: 1; /* Takes all available vertical space */
            overflow-y: auto; /* The ONE and ONLY vertical scrollbar for the section */
            padding: 1rem 1.5rem; 
        }
        
        /* New Metrics Scoreboard: Mobile-first (scrollable) */
        .exam-metrics-scroll-area {
            display: flex; /* Makes items sit side-by-side */
            gap: 1rem;
            overflow-x: auto; /* Enables horizontal scrolling */
            padding-bottom: 1.5rem;
            margin-bottom: 1rem;
            /* Hide scrollbar for a clean look */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .exam-metrics-scroll-area::-webkit-scrollbar { display: none; } /* Chrome, Safari, and Opera */
        
        .exam-metric-card {
            flex: 0 0 200px; /* Each card has a fixed width, forcing a scroll */
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .metric-icon-wrapper {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: #fff;
        }
        .metric-text h4 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .metric-text p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        /* Icon Color Styles */
        .style-blue { background-color: #3b82f6; }
        .style-purple { background-color: #8b5cf6; }
        .style-green { background-color: #22c55e; }
        .style-yellow { background-color: #f59e0b; }
        .trend-positive { color: #4ade80 !important; }
        .trend-negative { color: #f87171 !important; }
        
        /* Main Exam List Cards */
        .exam-list-header { 
            font-size: 1.5rem; font-weight: 600; color: var(--text-primary);
            padding-bottom: 0.75rem; margin: 1rem 0; 
            border-bottom: 1px solid var(--border-color); 
        }
        .exam-list-grid { 
            display: grid; grid-template-columns: 1fr; /* Default to single column */
            gap: 1rem; 
        }
        .exam-list-empty-message { padding: 2rem 0; text-align: center; color: var(--text-secondary); }
        .exam-card { 
            background: var(--bg-panel); border-left: 4px solid var(--primary-color); 
            border-radius: 1rem; padding: 1.25rem;
            /* other styles are the same */
            border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 1rem; transition: all 0.3s ease; 
        }
        /* ... other .exam-card styles are fine ... */
        .exam-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .exam-card-title { flex: 1; }
        .exam-card-title h4 { margin: 0; font-size: 1.2rem; color: var(--text-primary); line-height: 1.4; }
        .exam-card-title p { margin: 0.25rem 0 0; font-size: 0.9rem; color: var(--text-secondary); word-break: break-word; }
        .exam-card-date { font-weight: 500; font-size: 0.9rem; background: var(--bg-input); padding: 5px 10px; border-radius: 5px; white-space: nowrap; }
        .exam-card-body { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 1rem; flex-wrap: wrap; gap: 0.75rem; }
        .exam-score { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); white-space: nowrap; }
        .exam-score .total-marks { font-size: 1rem; font-weight: 500; color: var(--text-secondary); }
        .exam-card .btn-add-result { background: none; border: 2px solid var(--primary-color-dark); color: var(--primary-color); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; }
        .exam-card .btn-add-result:hover { background: var(--primary-color); color: #000; }
        
        /* Responsive Modal Styles */
        .exam-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 5000; display: none; align-items: center; justify-content: center; animation: fadeInSuccess 0.3s; padding: 1rem; box-sizing: border-box; }
        .exam-modal-overlay.visible { display: flex; }
        .exam-modal-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 1rem; padding: 2rem; width: 100%; max-width: 600px; position: relative; transform: scale(0.95); opacity: 0; animation: popupEnter 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; max-height: 95vh; overflow-y: auto; }
        #examResultModalOverlay .exam-modal-container { max-width: 450px; }
        .syllabus-selection-container { background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; max-height: 250px; overflow-y: auto; }
        .syllabus-subject-group { margin-bottom: 1rem; }
        .syllabus-subject-group:last-child { margin-bottom: 0; }
        .syllabus-subject-header { font-weight: 600; font-size: 1rem; color: var(--primary-color); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .syllabus-chapter-list { padding-left: 2rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .syllabus-chapter-item label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        #examForm .form-input { padding-left: 45px; }
        
        
        /* Desktop and Tablet Overrides */
        @media (min-width: 768px) {
            .exam-metrics-scroll-area {
                display: grid; /* Switch back to grid layout */
                grid-template-columns: repeat(4, 1fr);
                overflow-x: hidden; /* Disable horizontal scroll */
            }
            .exam-list-grid {
                grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            }
        }
        @media (max-width: 640px) {
            .exam-modal-container { padding: 1.5rem; max-width: 100%; }
            .exam-modal-container .step-title { font-size: 1.3rem; }
            .syllabus-selection-container { max-height: 35vh; }
        }

         /* =============================================== */
        /*          START: TOPIC TRACKER STYLES            */
        /* =============================================== */
        #topic.content-section {
            align-items: flex-start;
            padding: 0;
        }

        .tracker-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* --- DESKTOP STYLES (DEFAULT) --- */
        #topic .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            gap: 1rem;
        }

        #topic .section-filters {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .tracker-select-filters {
            display: flex;
            gap: 1rem;
        }

        .tracker-search-wrapper {
            position: relative;
        }

        .tracker-search {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            width: 250px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .tracker-search:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .tracker-search-wrapper .fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        #topic .section-filters .form-select {
            width: 180px;
            padding: 0.6rem 1rem;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
        }
        
                .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            flex-grow: 1;
            padding: 1.5rem 2rem;
        }

        .kanban-column { background-color: rgba(18, 18, 18, 0.5); border-radius: 1rem; display: flex; flex-direction: column; height: 100%; }
        .kanban-column-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .kanban-column-title { font-size: 1.1rem; font-weight: 600; }
        .kanban-column-title .topic-count { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); background: var(--bg-dark); padding: 2px 8px; border-radius: 5px; margin-left: 0.5rem; }
        .btn-add-topic { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; transition: color 0.2s ease; }
        .btn-add-topic:hover { color: var(--primary-color); }
        .kanban-cards { flex-grow: 1; padding: 1rem; overflow-y: auto; min-height: 200px; }
        .kanban-cards.drag-over { background-color: rgba(76, 250, 157, 0.05); border: 2px dashed var(--primary-color); }
        .topic-card { background: var(--bg-panel); border: 1px solid var(--border-color); border-left: 4px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; cursor: grab; transition: all 0.3s ease; }
        .topic-card.dragging { opacity: 0.5; transform: scale(1.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .topic-card:hover { border-color: var(--primary-color); transform: translateY(-2px); }
        .topic-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .topic-card-title { font-weight: 600; color: var(--text-primary); word-break: break-word; }
        .topic-card-actions { flex-shrink: 0; margin-left: 0.5rem; }
        .topic-card-actions button { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0 5px; }
        .topic-card-actions button:hover { color: var(--primary-color); }
        .topic-card-actions .btn-delete:hover { color: #f87171; }
        .topic-card-meta { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .topic-card-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .topic-tag { font-size: 0.75rem; font-weight: 500; padding: 3px 8px; border-radius: 5px; }
        .tag-difficulty-Easy { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .tag-difficulty-Medium { background: rgba(251, 191, 36, 0.2); color: #facc15; }
        .tag-difficulty-Hard { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .tag-importance-High { border: 1px solid #f87171; color: #f87171; }
        .tag-importance-Medium { border: 1px solid #facc15; color: #facc15; }
        .tag-importance-Low { border: 1px solid #6b7280; color: #6b7280; }

        /* --- MOBILE OVERRIDES FOR 3-ROW HEADER & KANBAN SCROLL --- */
        @media (max-width: 991px) {
            #topic .section-header {
                flex-direction: column;
                align-items: stretch;
                padding: 1rem 1.5rem;
                gap: 1rem;
            }
            /* FIX 1: Center align the title on mobile */
                       #topic .section-header h2 {
                text-align: center; /* This line was wrong */
                justify-content: center; /* THIS IS THE CORRECT FIX */
            }
           
            #topic .section-filters {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            .tracker-search, .tracker-select-filters, #topic .section-filters .form-select {
                width: 100%;
            }
            .tracker-select-filters {
                gap: 1rem;
            }
            #topic .section-filters .form-select {
                flex: 1;
            }
            .kanban-board {
                display: flex;
                gap: 1rem;
                padding: 0 1.5rem 1.5rem 1.5rem;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .kanban-board::-webkit-scrollbar { display: none; }
            .kanban-column {
                flex: 0 0 85%;
                max-width: 340px;
                scroll-snap-align: center;
            }
        }
        
        /* --- MODAL STYLES --- */
        /* FIX 2: Add padding to the overlay for mobile spacing */
        .topic-modal-overlay { 
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); 
            display: none; align-items: center; justify-content: center; 
            z-index: 5100; animation: fadeInSuccess 0.3s;
            padding: 1rem; /* This creates the safe space */
            box-sizing: border-box;
        }
        .topic-modal-overlay.visible { display: flex; }
        .topic-modal { 
            background: var(--bg-panel); border: 1px solid var(--border-color); 
            border-radius: 1rem; padding: 2rem; 
            width: 100%; /* Fills the padded overlay area */
            max-width: 500px; 
            animation: popupEnter 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; 
        }
        .topic-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .topic-modal-header h3 { margin: 0; font-size: 1.5rem; }
        .topic-modal-header .btn-close-modal { background:none; border:none; color: var(--text-secondary); font-size: 1.5rem; cursor:pointer; }
        .topic-modal .form-input, .topic-modal .form-select { width: 100%; padding: 12px 15px; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; box-sizing: border-box; }
        .topic-modal .form-select { 
            appearance: none; padding-right: 35px; 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%238b949e' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); 
            background-repeat: no-repeat; background-position: right .75rem center; background-size: 16px 12px;
        }
        .topic-modal .form-input { padding-left: 15px; }
        .topic-modal .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .topic-modal .nav-btn { width: 100%; margin-top: 1rem; }
        /* =============================================== */
        /*          END: TOPIC TRACKER STYLES            */
        /* =============================================== */
        

         /* =============================================== */
        /*      START: SETTINGS SECTION STYLES (FINAL FIX)   */
        /* =============================================== */

        /* This is the most important fix. It gives the entire section a solid
           background, which prevents content from other sections from showing through. */
        #settings.content-section {
            background-color: var(--bg-dark);
            align-items: flex-start;
            justify-content: flex-start;
            padding: 0;
        }

        #settings .settings-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column; /* Mobile-first layout */
            overflow: hidden;
        }

        /* --- MOBILE STYLES (To match your screenshot perfectly) --- */

        /* The top tab bar container */
        #settings .settings-nav {
            display: flex;
            flex-shrink: 0;
            width: 100%;
            border-bottom: 1px solid var(--border-color);
            padding: 0 1rem; /* Adds some space on the sides of the tabs */
            background-color: var(--bg-dark);
        }

        /* Individual tabs */
        #settings .settings-nav-btn {
            position: relative; /* For the active indicator line */
            flex: 1;
            justify-content: center;
            border: none;
            padding: 1rem 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            gap: 0.75rem;
            background: none;
            cursor: pointer;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
        }
        #settings .settings-nav-btn i {
            font-size: 1rem;
        }
        #settings .settings-nav-btn:hover {
            color: var(--text-primary);
        }
        /* Active tab style from the screenshot */
        #settings .settings-nav-btn.active {
            color: var(--primary-color);
            font-weight: 600;
        }
        /* The green underline for the active tab */
        #settings .settings-nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px; /* Sits flush with the bottom border of the nav */
            left: 10%; /* Makes the line shorter than the full tab width */
            width: 80%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        /* The scrollable content area below the tabs */
        #settings .settings-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        #settings .settings-pane {
            display: none;
            flex-direction: column;
            gap: 1.5rem; /* Space between cards */
        }
        #settings .settings-pane.active {
            display: flex;
            animation: fadeIn 0.4s ease;
        }

        /* The individual cards for each setting */
        #settings .setting-card {
            background: var(--bg-card);
            border-radius: 1rem; /* Rounded corners like the image */
            border: none;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        #settings .setting-card-content h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        #settings .setting-card-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        #settings .setting-card-action {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        #settings .setting-card-action .form-input,
        #settings .setting-card-action .form-select {
            flex-grow: 1;
            margin: 0;
        }
        #settings .setting-card-action .btn-primary {
            flex-shrink: 0;
        }
        #settings #pane-data .setting-card:last-child .setting-card-action {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        /* --- THEME & DATA PANE SPECIFIC STYLES --- */
        #settings .btn-danger {
            background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.5);
            color: #f87171; font-weight: 600; padding: 0.7rem 1.2rem; border-radius: 0.5rem;
            cursor: pointer; transition: all 0.2s ease;
        }
        #settings .btn-danger:hover { background-color: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        #settings .theme-colors { display: flex; gap: 1rem; align-items: center; }
        #settings .theme-color-option {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; transition: all 0.2s ease;
        }
        #settings .theme-color-option:hover { transform: scale(1.1); }
        #settings .theme-color-option.active { border-color: var(--primary-color); }


        /* ================================================ */
        /*          DESKTOP STYLES (Sidebar Layout)         */
        /* ================================================ */
        @media (min-width: 769px) {
            #settings .settings-container {
                flex-direction: row; /* Switch to side-by-side */
            }

            #settings .settings-nav {
                flex: 0 0 250px; /* Sidebar with fixed width */
                flex-direction: column;
                border-bottom: none;
                border-right: 1px solid var(--border-color);
                padding: 1.5rem 0;
                gap: 0.5rem;
            }

            #settings .settings-nav-btn {
                flex: none; /* Let the button size itself */
                justify-content: flex-start;
                border-bottom: none;
                border-left: 3px solid transparent; /* Prepare for active indicator */
                margin: 0 1.5rem 0 1rem;
                padding: 1rem 1.5rem;
                font-size: 1rem;
                border-radius: 8px;
            }
            
            /* Remove the mobile underline for desktop */
            #settings .settings-nav-btn.active::after {
                display: none;
            }

            /* Desktop active style */
            #settings .settings-nav-btn.active {
                color: var(--primary-color);
                background-color: rgba(76, 250, 157, 0.08);
                border-left-color: var(--primary-color);
            }

            #settings .settings-content {
                padding: 2rem;
            }

            #settings .setting-card {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 1.5rem;
            }

            #settings .setting-card-action {
                width: auto;
            }
            #settings .setting-card-action .form-input,
            #settings .setting-card-action .form-select {
                width: 250px;
            }
            #settings #pane-data .setting-card:last-child .setting-card-action {
                flex-direction: row;
                align-items: center;
                gap: 1rem;
            }
        }
        /* =============================================== */
        /*        END: SETTINGS SECTION STYLES         */
        /* =============================================== */


/* =============================================== */
/*      START: MOTIVATION SECTION STYLES (DEFINITIVE FIX)    */
/* =============================================== */

/* State Management: This is the core fix.
   The #motivation section itself is hidden by default like all other sections.
   The .active class, applied by JavaScript, makes it visible. */
   
#motivation.content-section { 
    /* We DO NOT set a display property here. We let the default
       .content-section and .content-section.active rules handle visibility. */
    padding: 0; 
    align-items: flex-start; 
}

/* By default, within the motivation section, show the grid and hide the player. */
#motivation #motivation-player-view { display: none; }
#motivation #motivation-grid-view { 
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
}

/* When the player-mode-active class is added to #motivation, flip the visibility. */
#motivation.player-mode-active #motivation-grid-view { display: none; }
#motivation.player-mode-active #motivation-player-view { 
    display: flex; 
    width: 100%;
    height: 100%;
    background: #0f0f0f; 
    overflow: hidden;
}


/* --- Video Grid View Styles (Unchanged) --- */
.motivation-grid { 
    flex-grow: 1; 
    padding: 1.5rem;
    overflow-y: auto; 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
    gap: 2rem 1.5rem;
    align-content: flex-start; 
}
.motivation-card-youtube { background: transparent; border: none; cursor: pointer; display: flex; flex-direction: column; gap: 0.75rem; }
.video-thumbnail-container { position: relative; width: 100%; aspect-ratio: 16 / 9; border-radius: 12px; overflow: hidden; background-color: var(--bg-input); transition: all 0.2s ease-in-out; }
.motivation-card-youtube:hover .video-thumbnail-container { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); border-radius: 0; }
.video-thumbnail-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
.motivation-card-youtube:hover .video-thumbnail-container img { transform: scale(1.05); }
.video-details { display: flex; gap: 0.75rem; align-items: flex-start; }
.video-icon-wrapper { flex-shrink: 0; width: 36px; height: 36px; border-radius: 50%; background-color: var(--bg-input); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
.video-meta { flex-grow: 1; min-width: 0; }
.video-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.25rem 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
.video-source { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }

/* --- Video Player View Styles --- */
.player-main-content { flex-grow: 1; display: flex; flex-direction: column; padding: 1.5rem; }
.player-video-wrapper { width: 100%; max-width: 1280px; margin: 0 auto; background-color: #000; }
#player-iframe-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; }
#player-iframe-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
.player-video-details { width: 100%; max-width: 1280px; margin: 0 auto; padding-top: 1rem; }
#player-video-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0; }
.player-channel-info { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
.player-channel-icon { width: 40px; height: 40px; border-radius: 50%; background: #c00; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
.player-channel-name p { margin: 0; font-weight: 500; color: var(--text-primary); }
.player-channel-name span { font-size: 0.8rem; color: var(--text-secondary); }
.player-close-btn { margin-left: auto; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.6rem 1.2rem; border-radius: 50px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; display: flex; align-items: center; gap: 0.5rem; }
.player-close-btn:hover { background-color: var(--border-color); }
.player-playlist-sidebar { flex: 0 0 400px; border-left: 1px solid var(--border-color); overflow-y: auto; display: flex; flex-direction: column; }
.player-playlist-header { display: none; }
#player-playlist-items { padding: 0.5rem; }
.playlist-item { display: flex; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
.playlist-item:hover, .playlist-item.is-playing { background-color: var(--bg-panel); }
.playlist-item-thumbnail { flex: 0 0 160px; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; background-color: var(--bg-input); }
.playlist-item-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
.playlist-item-meta h5 { font-size: 0.9rem; font-weight: 500; color: var(--text-primary); margin: 0 0 0.25rem 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.playlist-item-meta p { font-size: 0.8rem; color: var(--text-secondary); margin: 0; }

/* --- Add Motivation Modal Styles --- */
.motivation-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 5500; display: none; align-items: center; justify-content: center; animation: fadeInSuccess 0.3s; padding: 1rem; box-sizing: border-box; }
.motivation-modal-overlay.visible { display: flex; }
.motivation-modal-content { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 1rem; padding: 2rem; width: 100%; max-width: 420px; position: relative; transform: scale(0.95); opacity: 0; animation: popupEnter 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; box-shadow: 0 10px 40px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }

/* --- Responsive adjustments --- */
@media (max-width: 1024px) {
    #motivation.player-mode-active #motivation-player-view { flex-direction: column; }
    .player-main-content { flex-shrink: 0; overflow-y: visible; }
    .player-playlist-sidebar { border-left: none; border-top: 1px solid var(--border-color); flex-grow: 1; min-height: 0; }
    .player-channel-info { display: none; }
    #player-video-title { margin-bottom: 1rem; }
}
@media (max-width: 768px) {
    .motivation-grid { grid-template-columns: 1fr; padding: 1rem; gap: 1.5rem; }
    .player-main-content { padding: 1rem; }
    #player-video-title { font-size: 1.1rem; }
    .playlist-item { flex-direction: column; }
    .playlist-item-thumbnail { flex-basis: auto; }
}
/* =============================================== */
/*      END: MOTIVATION SECTION STYLES (DEFINITIVE FIX)        */
/* =============================================== */
        
        /* =============================================== */
        /*              START: MISC & ENHANCEMENTS         */
        /* =============================================== */
        /* Loading skeleton animation */
        .loading-skeleton {
            background: linear-gradient(90deg, #1a1a1a 25%, #2d2d2d 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.25rem;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Enhanced button styles */
        .nav-btn, .btn-primary, .btn-save {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Better focus states */
        .form-input:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(76, 250, 157, 0.3);
        }
        
        /* Animation for metric cards */
        @keyframes cardPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        .metric-card:hover { animation: cardPulse 1.5s infinite; }
        
        /* Animation for summary cards */
        @keyframes summaryCardFloat {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        .summary-card:hover { animation: summaryCardFloat 2s infinite; }
        
        /* =============================================== */
        /*           NAV UPGRADE: ADD-ON CSS               */
        /* =============================================== */
        :root {
          --easing-standard: cubic-bezier(0.2, 0.8, 0.2, 1);
          --focus-ring: 0 0 0 2px rgba(76, 250, 157, 0.45), 0 0 0 6px rgba(76, 250, 157, 0.18);
          --safe-top: env(safe-area-inset-top, 0px);
          --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* Better focus styles */
        .desktop-nav .nav-item,
        .new-mobile-nav-item,
        .center-hub-fab,
        .more-option-item,
        #close-more-panel-btn,
        #more-options-panel button {
          outline: none;
        }
        .desktop-nav .nav-item:focus-visible,
        .new-mobile-nav-item:focus-visible,
        .center-hub-fab:focus-visible,
        .more-option-item:focus-visible,
        #close-more-panel-btn:focus-visible,
        #more-options-panel button:focus-visible {
          box-shadow: var(--focus-ring);
        }

        /* Safe-area aware mobile nav */
        .new-mobile-nav-wrapper {
          padding-bottom: max(0px, var(--safe-bottom));
          height: calc(var(--nav-mobile-height) + max(0px, var(--safe-bottom)));
          transition: transform 0.35s var(--easing-standard);
        }
        .new-mobile-nav-wrapper.mobile-nav-hidden {
          transform: translateY(120%);
        }

        /* More sheet panel styles */
        .more-options-panel {
          padding-bottom: calc(1.5rem + max(0px, var(--safe-bottom)));
          touch-action: pan-y;
        }
        .sheet-drag-handle {
          width: 36px;
          height: 4px;
          border-radius: 999px;
          background: var(--border-color);
          margin: 0.5rem auto 0.75rem;
          opacity: 0.85;
        }
        .more-options-panel.dragging {
          transition: none !important;
        }
        body.more-panel-open {
          overflow: hidden;
        }

        /* Ripple effect */
        .ripple {
          position: absolute;
          pointer-events: none;
          border-radius: 999px;
          transform: scale(0);
          animation: ripple 600ms var(--easing-standard);
          background: radial-gradient(circle, rgba(76, 250, 157, 0.7) 10%, rgba(76, 250, 157, 0.35) 40%, transparent 60%);
          opacity: 0.7;
        }
        @keyframes ripple {
          to {
            transform: scale(3.5);
            opacity: 0;
          }
        }
        
        /* =================================================================== */
        /*           START: REUSABLE RESPONSIVE GRID-TO-SCROLL STYLES          */
        /* =================================================================== */

        /* This is a new, reusable class for the pattern you liked in the Exams section. */
        .responsive-scroll-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        /* =================================================================== */
        /*                    RESPONSIVE STYLES & MEDIA QUERIES                */
        /* =================================================================== */
        @media (max-width: 1280px) {
            #dashboard-grid {
                /* Keep 4 columns on tablet as per requirement */
                grid-template-columns: repeat(4, 1fr);
                grid-auto-rows: minmax(200px, auto);
                gap: 1.5rem;
            }
        }
        
        @media (max-width: 1024px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            .dna-metrics-container {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .dna-metric-card {
                flex-basis: calc(50% - 0.75rem);
            }
        }
        
        @media (max-width: 900px) {
            .subject-selection-grid {
                grid-template-columns: repeat(2, 1fr); /* 2x2 grid on tablets */
            }
        }

        @media (max-width: 768px) {
            .desktop-nav { display: none; }
            .mobile-nav { display: block; } /* This can be removed if not used */
            .new-mobile-nav-wrapper { display: block; }

            .content-container {
                padding-top: 0;
                padding-bottom: var(--nav-mobile-height);
            }
    
            .nav-item span { display: none; }

            #dashboard.content-section { padding: 1rem; }
            
            #dashboard-grid {
                /* Compact 2x2 grid on mobile */
                grid-template-columns: repeat(2, 1fr);
                grid-auto-rows: minmax(130px, auto);
                gap: 0.65rem;
            }
            /* Make metric cards denser on mobile */
            .metric-card { padding: 0.85rem; border-radius: 0.8rem; }
            .metric-header { margin-bottom: 0.5rem; }
            .metric-title { font-size: 0.78rem; gap: 0.45rem; }
            .metric-icon { width: 32px; height: 32px; font-size: 1rem; border-radius: 8px; }
            .metric-value-container { margin-bottom: 0.5rem; }
            .metric-value { font-size: 1.6rem; }
            .metric-value small { font-size: 1rem; }
            .metric-label { font-size: 0.76rem; }
            .metric-chart { height: 60px; }
            
            .summary-row { flex-direction: column; }
            
            .metric-value { font-size: 2rem; }
            .forecast-score { font-size: 3rem; }
            
            /* --- START: ANALYTICS SECTION RESPONSIVE FIX (COMPACT GRID) --- */
            
            /* General Analytics pane adjustments for mobile */
            #analytics .analytics-content {
                padding: 1rem;
                gap: 1.5rem;
            }
            #analytics .analytics-tabs { padding: 0 0.5rem; }
            .analytics-tab-btn {
                padding: 0.8rem 0.3rem; /* Reduced horizontal padding */
                font-size: 0.9rem;
                gap: 0.4rem; /* Reduced space between icon and text */
            }
            .analytics-key-metrics-grid {
                grid-template-columns: repeat(2, 1fr); /* Enforce compact 2x2 grid */
                gap: 1rem;
            }
            .analytics-key-metrics-grid .exam-metric-card {
                padding: 0.75rem; /* Make cards more compact */
                flex-direction: column; /* Stack icon and text vertically */
                text-align: center;
                gap: 0.5rem;
            }
             .analytics-key-metrics-grid .exam-metric-card .metric-text h4 {
                font-size: 1.4rem; /* Adjust font size for mobile */
            }
            .analytics-key-metrics-grid .exam-metric-card .metric-text p {
                font-size: 0.75rem;
            }
            .analytics-card-header {
                flex-direction: column; /* Stack title and filters */
                align-items: flex-start;
                gap: 1rem;
            }
            .analytics-filters {
                flex-wrap: wrap;
                width: 100%;
            }
            .form-select-sm {
                flex-grow: 1;
                flex-basis: 120px;
            }
            .analytics-split-container { 
                flex-direction: column; 
                height: auto; 
                gap: 2rem;
            }
            .analytics-pie-container { 
                flex: 0 0 250px;
            }
            /* --- END: ANALYTICS SECTION RESPONSIVE FIX --- */

            .kanban-board {
                grid-template-columns: 1fr;
                overflow-x: auto;
                overflow-y: hidden;
                padding-bottom: 1rem;
            }
            .kanban-column { min-width: 280px; }
        }
        
        @media (max-width: 640px) {
            .form-container { padding: 1.5rem; margin: 1rem; }
            .time-input-container { flex-direction: column; gap: 0.75rem; }
            .time-input-wrapper { width: 100%; }
            .practice-form-section { padding: 0.75rem; margin-bottom: 1rem; }
            .subject-selection-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }

        @media (max-width: 500px) {
            #reports.content-section { padding: 0.5rem; }
            .subject-selection-grid { gap: 1rem; }
            .subject-card { padding: 1rem 0.5rem; }
            .subject-card span { font-size: 1rem; }
            #new-report-results-container {
                grid-template-columns: 1fr; /* Single column on mobile */
                padding: 0 0.5rem 1rem 0.5rem;
            }
            .ric-stats-grid {
                grid-template-columns: repeat(2, 1fr); /* 2x2 grid for stats */
            }

            #analytics .analytics-tab-btn span {
                display: none; /* On very small phones, hide tab text, show only icons */
            }
            #analytics .analytics-tab-btn {
                font-size: 1.2rem;
            }
        }

        @media (prefers-reduced-motion: reduce) {
          .nav-item, .new-mobile-nav-item,
          .center-hub-fab, .more-option-item, .more-options-panel,
          .more-options-overlay, .new-mobile-nav-wrapper {
            transition: none !important;
          }
          .ripple { display: none !important; }
        }

        /* (Removed legacy unlock/login overlay styles) */

    </style>
</head>
<body>
<!-- =================================================================== -->
<!--                        START: LOGIN OVERLAY                         -->
<!-- =================================================================== -->
<!-- Removed legacy unlock overlay; login is handled via Supabase on login.html -->
<!-- =================================================================== -->
<!--                         END: LOGIN OVERLAY                          -->
<!-- =================================================================== -->

<!-- =================================================================== -->
<!--                 MODAL & OVERLAYS SECTION START                      -->
<!-- =================================================================== -->

    <!-- Success Animation Overlay -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-animation">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
            <p class="success-message" id="successText">Log Saved!</p>
        </div>
    </div>

    <!-- Main Form Popup (Daily & Practice Logs) -->
    <div class="form-popup-overlay" id="formPopupOverlay">
        <div class="form-container">
            <button id="closeFormPopupBtn" class="close-popup-btn">×</button>
            <div class="tab-controls">
                <button id="tabDailyLog" class="tab-btn active"><i class="fas fa-sun mr-2"></i>Daily Log</button>
                <button id="tabPractice" class="tab-btn"><i class="fas fa-crosshairs mr-2"></i>Practice</button>
            </div>
            
            <!-- Daily Log Form (FIXED) -->
            <form id="dailyLogForm" class="step-form active" novalidate>
                <div class="form-step" data-step="0">
                    <h3 class="step-title"><i class="fas fa-moon"></i> Daily Essentials</h3>
                    <div class="form-group">
                        <input type="number" id="dailySleep" class="form-input" placeholder="Sleep Hours (e.g., 7.5)">
                        <i class="form-icon fas fa-bed"></i>
                    </div>
                     <div class="form-group">
                        <input type="number" id="dailyScreenTime" class="form-input" placeholder="Screen Time (e.g., 3)">
                        <i class="form-icon fas fa-mobile-alt"></i>
                    </div>
                    <div class="progress-bar"><div class="progress-bar-fill"></div></div>
                    <div class="step-nav">
                        <div></div>
                        <button type="button" class="nav-btn next-btn">Next</button>
                    </div>
                </div>
                <div class="form-step" data-step="1" style="display: none;">
                    <h3 class="step-title"><i class="fas fa-hands-praying"></i> Habits & Notes</h3>
                    <div class="form-group">
                        <label class="form-label" style="text-align:center; display:block; margin-bottom: 0.5rem; color: var(--text-secondary);">Prayers</label>
                        <div class="prayer-selector" id="prayerSelector">
                            <div class="prayer-circle"></div>
                            <div class="prayer-circle"></div>
                            <div class="prayer-circle"></div>
                            <div class="prayer-circle"></div>
                            <div class="prayer-circle"></div>
                        </div>
                    </div>
                     <div class="form-group">
                        <div class="discipline-check-group" onclick="document.getElementById('disciplineCheck').click()">
                            <label for="disciplineCheck"><i class="fas fa-check-circle"></i> Self-Discipline Check</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="disciplineCheck">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="dailyNotes" class="form-input" placeholder="Quick Notes (optional)">
                        <i class="form-icon fas fa-pencil-alt"></i>
                    </div>
                    <div class="progress-bar"><div class="progress-bar-fill"></div></div>
                    <div class="step-nav">
                        <button type="button" class="nav-btn prev-btn">Back</button>
                        <button type="submit" class="nav-btn submit-btn">Submit</button>
                    </div>
                </div>
            </form>

            <!-- Practice Log Form (FIXED) -->
            <form id="practiceLogForm" class="step-form" novalidate>
                <input type="hidden" id="practiceSubject" name="Subject">
                <input type="hidden" id="practiceChapter" name="Chapter">
                <div class="form-step" data-step="0">
                    <h3 class="step-title"><i class="fas fa-map-marked-alt"></i> Select Your Arena</h3>
                    <div class="form-group">
                        <div id="arenaSelectionDisplay" role="button" tabindex="0">
                            <span class="placeholder">Click to select subject & chapter</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    <div class="progress-bar"><div class="progress-bar-fill"></div></div>
                    <div class="step-nav">
                        <div></div>
                        <button type="button" class="nav-btn next-btn" disabled>Next</button>
                    </div>
                </div>
                <div class="form-step" data-step="1" style="display: none;">
                    <h3 class="step-title"><i class="fas fa-chalkboard-teacher"></i> Log Lectures</h3>
                    <div class="form-group">
                        <div class="time-input-container">
                            <div class="time-input-wrapper">
                                <input type="number" id="lectureHours" class="form-input" placeholder="0" min="0">
                                <label>hr</label>
                            </div>
                            <div class="time-input-wrapper">
                                <input type="number" id="lectureMinutes" class="form-input" placeholder="0" min="0" max="59">
                                <label>min</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="time-suggestion-chips" data-target-hr="lectureHours" data-target-min="lectureMinutes">
                            <button type="button" class="time-suggestion-chip" data-min="30">+30m</button>
                            <button type="button" class="time-suggestion-chip" data-min="45">+45m</button>
                            <button type="button" class="time-suggestion-chip" data-hr="1">+1h</button>
                            <button type="button" class="time-suggestion-chip" data-min="90">+1h 30m</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <select id="lectureType" class="form-select" style="padding-left: 15px;">
                            <option>Offline</option>
                            <option>Online</option>
                        </select>
                    </div>
                    <div class="progress-bar"><div class="progress-bar-fill"></div></div>
                    <div class="step-nav">
                        <button type="button" class="nav-btn prev-btn">Back</button>
                        <button type="button" class="nav-btn next-btn">Next</button>
                    </div>
                </div>
                <div class="form-step" data-step="2" style="display: none;">
                    <h3 class="step-title"><i class="fas fa-pencil-alt"></i> Log Practice</h3>
                    <div class="form-group">
                        <div class="time-input-container">
                            <div class="time-input-wrapper"><input type="number" id="practiceMcq" class="form-input" placeholder="MCQs"></div>
                            <div class="time-input-wrapper"><input type="number" id="practiceSaq" class="form-input" placeholder="SAQs"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group" onclick="this.querySelector('input').click()">
                            <input type="checkbox" id="practiceUnique" class="form-checkbox"><label for="practiceUnique">Questions were unique (new)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: block; text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Self-Study / Practice Time</label>
                        <div class="time-input-container">
                            <div class="time-input-wrapper"><input type="number" id="practiceHours" class="form-input" placeholder="0" min="0"><label>hr</label></div>
                            <div class="time-input-wrapper"><input type="number" id="practiceMinutes" class="form-input" placeholder="0" min="0" max="59"><label>min</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="time-suggestion-chips" data-target-hr="practiceHours" data-target-min="practiceMinutes">
                           <button type="button" class="time-suggestion-chip" data-min="30">+30m</button>
                           <button type="button" class="time-suggestion-chip" data-min="45">+45m</button>
                           <button type="button" class="time-suggestion-chip" data-hr="1">+1h</button>
                           <button type="button" class="time-suggestion-chip" data-min="90">+1h 30m</button>
                        </div>
                    </div>
                    <div class="progress-bar"><div class="progress-bar-fill"></div></div>
                    <div class="step-nav">
                        <button type="button" class="nav-btn prev-btn">Back</button>
                        <button type="submit" class="nav-btn submit-btn">Submit</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Arena Modal (Subject & Chapter Selection) -->
    <div class="arena-modal-overlay" id="arenaModalOverlay">
        <div class="arena-modal-container" id="arenaModalContainer">
            <button id="closeArenaModalBtn" class="close-popup-btn">×</button>
            <div class="arena-panel generic-scrollbar" id="arenaSubjectsPanel">
                <h3 class="arena-panel-header">Select Subject</h3>
                <ul class="arena-list" id="arenaSubjectList"></ul>
            </div>
            <div class="arena-panel generic-scrollbar" id="arenaChaptersPanel">
                <h3 class="arena-panel-header">
                    <button class="btn-back-to-subjects" id="backToSubjectsBtn"><i class="fas fa-arrow-left"></i> Back</button>
                    <span id="chaptersHeaderTitle">Select Chapter</span>
                </h3>
                <ul class="arena-list" id="arenaChapterList"></ul>
            </div>
        </div>
    </div>
    
    <!-- Exam Scheduling Modal -->
    <div class="exam-modal-overlay" id="examModalOverlay">
        <div class="exam-modal-container">
            <button id="closeExamModalBtn" class="close-popup-btn">×</button>
            <form id="examForm"></form>
        </div>
    </div>

    <!-- Exam Result Entry Modal -->
    <div class="exam-modal-overlay" id="examResultModalOverlay">
        <div class="exam-modal-container" style="max-width: 450px;">
            <button id="closeExamResultModalBtn" class="close-popup-btn">×</button>
            <form id="examResultForm">
                <h3 class="step-title" id="examResultModalTitle">Add Result for Exam</h3>
                <input type="hidden" id="resultExamId" name="examId">
                <div class="form-group">
                    <input type="number" id="marksObtained" class="form-input" placeholder="Marks Obtained" required>
                    <i class="form-icon fas fa-marker"></i>
                </div>
                <div class="form-group">
                    <input type="number" id="totalMarks" class="form-input" placeholder="Total Marks" required>
                    <i class="form-icon fas fa-star"></i>
                </div>
                <button type="submit" class="nav-btn submit-btn" style="width: 100%;">Save Result</button>
            </form>
        </div>
    </div>

    <!-- Topic Creation/Editing Modal -->
 <div class="topic-modal-overlay" id="topicModal">
    <div class="topic-modal">
        <div class="topic-modal-header">
            <h3 id="topicModalTitle">Add New Topic</h3>
            <button class="btn-close-modal" id="closeTopicModal"><i class="fas fa-times"></i></button>
        </div>
        <form id="topicForm">
            <input type="hidden" id="topicId" name="TopicID">
            <div class="form-group">
                <input type="text" id="topicName" name="TopicName" class="form-input" placeholder="Topic Name" required>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <select id="topicSubject" name="Subject" class="form-select" required></select>
                </div>
                <div class="form-group">
                    <select id="topicChapter" name="Chapter" class="form-select" required></select>
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <select id="topicDifficulty" name="Difficulty" class="form-select" required>
                        <option disabled selected value="">Difficulty...</option>
                        <option>Easy</option><option>Medium</option><option>Hard</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="topicImportance" name="Importance" class="form-select" required>
                        <option disabled selected value="">Importance...</option>
                        <option>High</option><option>Medium</option><option>Low</option>
                    </select>
                </div>
            </div>
            <!-- REPLACEMENT: "Tags" input is now a "Status" select dropdown -->
            <div class="form-group">
                <select id="topicStatusSelect" name="Status" class="form-select" required>
                    <option disabled selected value="">Status...</option>
                    <option>Not Started</option>
                    <option>In Progress</option>
                    <option>Needs Review</option>
                    <option>Completed</option>
                </select>
            </div>
            <button type="submit" class="nav-btn submit-btn">Save Topic</button>
        </form>
    </div>
</div>
    
    <!-- Add Motivation Video Modal -->
    <div class="motivation-modal-overlay" id="addMotivationModal">
        <div class="exam-modal-container" style="max-width: 500px;">
             <button id="closeAddMotivationModal" class="close-popup-btn">×</button>
             <form id="addMotivationForm">
                <h3 class="step-title"><i class="fas fa-video"></i> Add Motivational Video</h3>
                <div class="form-group">
                    <input type="url" id="motivationUrl" class="form-input" placeholder="Paste YouTube Video URL" required>
                    <i class="form-icon fab fa-youtube"></i>
                </div>
                <div class="form-group">
                    <input type="text" id="motivationTitle" class="form-input" placeholder="Video Title (auto-filled on paste)">
                    <i class="form-icon fas fa-heading"></i>
                </div>
                <button type="submit" class="nav-btn submit-btn" style="width: 100%;">Add Video</button>
            </form>
        </div>
    </div>


<!-- =================================================================== -->
<!--                  MODAL & OVERLAYS SECTION END                       -->
<!-- =================================================================== -->



<!-- =================================================================== -->
<!--              MAIN LAYOUT & NAVIGATION SECTION START                 -->
<!-- =================================================================== -->
    <div class="nav-container">
        <!-- Desktop Navigation (macOS style) -->
        <nav class="desktop-nav">
            <div class="nav-menu">
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showSection('reports')">
                    <i class="fas fa-chart-pie"></i>
                    <span>Reports</span>
                </div>
                <div class="nav-item" onclick="showSection('analytics')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" onclick="showSection('topic')">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Topic</span>
                </div>
                <div class="nav-item" onclick="showSection('exams')">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Exams</span>
                </div>
                <div class="nav-item" onclick="showSection('motivation')">
                    <i class="fas fa-bolt"></i>
                    <span>Motivation</span>
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
            
            <!-- [REMOVED] Old .nav-actions div is no longer needed -->
        </nav>
        
    </div>
    
    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <div class="content-container">
            <main class="main-content">
<!-- =================================================================== -->
<!--               MAIN LAYOUT & NAVIGATION SECTION END                  -->
<!-- =================================================================== -->



<!-- =================================================================== -->
<!--                    DASHBOARD SECTION START                          -->
<!-- =================================================================== -->
                <section id="dashboard" class="content-section active generic-scrollbar">
                    <!-- Special Quote Loader for Dashboard (UNTOUCHED) -->
                    <div id="dashboard-loader" class="loader-container" style="display: none;">
                        <div class="quote-wrapper">
                            <h3 class="quote-text"></h3>
                            <p class="quote-author"></p>
                        </div>
                    </div>
                    
                    <div id="dashboard-grid">
                        <!-- Metric Card 1: Avg. Exam Score -->
                        <div class="metric-card metric-exam-score">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-percentage"></i></div>
                                    Avg. Exam Score
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">--<small>%</small></div>
                                <div class="metric-label">Current Performance</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="sparkline-score"></canvas>
                            </div>
                        </div>
                        
                        <!-- Metric Card 2: Syllabus Completion -->
                        <div class="metric-card metric-syllabus">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-tasks"></i></div>
                                    Syllabus Completion
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">--<small>%</small></div>
                                <div class="metric-label">Overall Progress</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="syllabus-pie-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Metric Card 3: Best Subject -->
                        <div class="metric-card metric-best-subject">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-trophy"></i></div>
                                    Best Subject
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">--</div>
                                <div class="metric-label">Top Performance</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="sparkline-best-subject"></canvas>
                            </div>
                        </div>
                        
                        <!-- Metric Card 4: Discipline Streak -->
                        <div class="metric-card metric-streak">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-fire"></i></div>
                                    Discipline Streak
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">-- <small>Days</small></div>
                                <div class="metric-label">Current Streak</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="sparkline-streak"></canvas>
                            </div>
                        </div>
                        
                        <!-- Metric Card 5: Today's Efficiency -->
                        <div class="metric-card metric-efficiency">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-tachometer-alt"></i></div>
                                    Today's Efficiency
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">--<small>%</small></div>
                                <div class="metric-label">Daily Performance</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="efficiency-gauge"></canvas>
                            </div>
                        </div>
                        
                        <!-- Metric Card 6: Productive Hours -->
                        <div class="metric-card metric-productive">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-clock"></i></div>
                                    Productive Hours
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">-- <small>hrs</small></div>
                                <div class="metric-label">Today's Study Time</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="productive-time-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Metric Card 7: Wasted vs Productive -->
                        <div class="metric-card metric-wasted">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-balance-scale"></i></div>
                                    Time Balance
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">--<small>ratio</small></div>
                                <div class="metric-label">Productive vs Wasted</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="time-balance-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Metric Card 8: Screen Time -->
                        <div class="metric-card metric-screen-time">
                            <div class="metric-header">
                                <div class="metric-title">
                                    <div class="metric-icon"><i class="fas fa-mobile-alt"></i></div>
                                    Screen Time
                                </div>
                            </div>
                            <div class="metric-value-container">
                                <div class="metric-value">-- <small>hrs</small></div>
                                <div class="metric-label">Today's Usage</div>
                            </div>
                            <div class="metric-chart">
                                <canvas id="screen-time-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Section -->
                    <div class="summary-section">
                        <div class="summary-row">
                            <div class="summary-card">
                                <div class="summary-card-header">
                                    <div class="summary-card-title">
                                        <i class="fas fa-book-reader"></i>
                                        Practice Summary
                                    </div>
                                </div>
                                <div class="summary-stats">
                                    <div class="summary-stat">
                                        <div class="summary-stat-value">--</div>
                                        <div class="summary-stat-label">Total MCQs</div>
                                    </div>
                                    <div class="summary-stat">
                                        <div class="summary-stat-value">--</div>
                                        <div class="summary-stat-label">Total SAQs</div>
                                    </div>
                                    <div class="summary-stat">
                                        <div class="summary-stat-value">--</div>
                                        <div class="summary-stat-label">Unique Questions</div>
                                    </div>
                                </div>
                                <div class="summary-chart">
                                    <canvas id="practice-summary-chart"></canvas>
                                </div>
                            </div>

<div class="summary-card">
    <div class="summary-card-header">
        <div class="summary-card-title">
            <i class="fas fa-lightbulb"></i>
            Actionable Insights
        </div>
    </div>
    <!-- Insights will be dynamically inserted here by JavaScript -->
    <div id="actionable-insights-container">
        <div class="actionable-insight-item">
            <i class="fas fa-spinner fa-spin"></i>
            <div class="insight-content">
                <h5>Analyzing Data...</h5>
                <p>Checking your recent performance for insights.</p>
            </div>
        </div>
    </div>
</div>

                        </div>
                        
                        <div class="summary-row">
                            <div class="summary-card">
                                <div class="summary-card-header">
                                    <div class="summary-card-title">
                                        <i class="fas fa-chart-line"></i>
                                        Performance Forecast
                                    </div>
                                </div>
                                <div class="forecast-container">
                                    <div class="forecast-score">--<small>%</small></div>
                                    <p class="forecast-label">Predicted score on next exam</p>
                                </div>
                                <div class="summary-chart">
                                    <canvas id="performance-forecast-chart"></canvas>
                                </div>
                            </div>
  <div class="summary-card">
    <div class="summary-card-header">
        <div class="summary-card-title">
            <i class="fas fa-calendar-week"></i>
            Weekly Report
        </div>
    </div>
    <!-- Weekly report items will be dynamically inserted here -->
    <div id="weekly-report-container">
        <div class="weekly-report-item">
            <i class="fas fa-spinner fa-spin"></i>
            <div class="report-content">
                <h5>Compiling Weekly Data...</h5>
                <p>Comparing this week to the last.</p>
            </div>
        </div>
    </div>
</div>                          

                        </div>
                    </div>
                </section>
<!-- =================================================================== -->
<!--                     DASHBOARD SECTION END                           -->
<!-- =================================================================== -->



<!-- =================================================================== -->
<!--                      REPORTS SECTION START                          -->
<!-- =================================================================== -->
                <section id="reports" class="content-section">
                    <!-- Report Configuration Wizard -->
                    <div id="report-config-wizard" style="display: none;">
                        <div class="wizard-header">
                            <h2><i class="fas fa-chart-pie"></i> Report Engine</h2>
                            <p>Craft a personalized performance analysis in a few clicks.</p>
                        </div>
                        <div class="wizard-step active" id="report-step-subject">
                            <h4><span class="step-num">1</span>Select a Subject</h4>
                            <div class="subject-selection-grid" id="subject-selection-container"></div>
                        </div>
                        <div class="wizard-step" id="report-step-chapter">
                             <h4><span class="step-num">2</span>Select Chapter(s)</h4>
                             <div class="chapter-selection-grid" id="chapter-selection-container"></div>
                        </div>
                        <div class="wizard-step" id="report-step-actions">
                            <button id="btn-generate-new-report" class="btn-generate-new" disabled>
                                <i class="fas fa-bolt"></i> Generate
                            </button>
                            <button id="btn-reset-report-wizard" class="btn-reset-wizard">Reset</button>
                        </div>
                    </div>

                    <!-- Report Results View -->
                    <div id="report-results-view" style="display: none;">
                        <div class="results-header">
                            <button id="btn-back-to-wizard" class="btn-back-to-wizard"><i class="fas fa-arrow-left"></i> New Report</button>
                        </div>
                        <!-- NEW HACKER LOADER FOR REPORTS -->
                        <div id="new-report-loader" class="loader-container" style="display: none;">
<div class="stretch-loader-container">
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
</div>
<p class="loader-text"></p>
                        </div>
                        <div id="new-report-results-container" class="new-report-results-grid generic-scrollbar"></div>
                        <div id="new-report-message-area" style="display:none;" class="report-placeholder"></div>
                    </div>
                </section>
<!-- =================================================================== -->
<!--                       REPORTS SECTION END                           -->
<!-- =================================================================== -->



<!-- =================================================================== -->
<!--                     ANALYTICS SECTION START (FINAL FIX)             -->
<!-- =================================================================== -->
<section id="analytics" class="content-section">
    <div class="analytics-container">
        <!-- NEW HACKER LOADER FOR ANALYTICS -->
        <div id="analytics-loader" class="loader-container" style="display: none;">
<div class="stretch-loader-container">
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
</div>
<p class="loader-text"></p>
        </div>
        
        <div class="section-header" style="padding: 0; border-bottom: none;">
            <div class="analytics-tabs" id="analyticsTabs">
                <button class="analytics-tab-btn active" data-pane="pane-analytics-exam"><i class="fas fa-chart-line"></i><span>Exams</span></button>
                <button class="analytics-tab-btn" data-pane="pane-analytics-syllabus"><i class="fas fa-book-open"></i><span>Syllabus</span></button>
                <button class="analytics-tab-btn" data-pane="pane-analytics-habits"><i class="fas fa-calendar-check"></i><span>Habits</span></button>
            </div>
        </div>
        <div class="analytics-content generic-scrollbar">
            <!-- Pane 1: Exam Analysis -->
            <div id="pane-analytics-exam" class="analytics-pane active">
                <div class="analytics-key-metrics-grid">
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-blue"><i class="fas fa-percentage"></i></div>
                        <div class="metric-text"><h4 id="exam-avg-score">--%</h4><p>Avg. Score</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-yellow"><i class="fas fa-bug"></i></div>
                        <div class="metric-text"><h4 id="exam-avg-mistake-rate">--%</h4><p>Mistake Rate</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-green"><i class="fas fa-trophy"></i></div>
                        <div class="metric-text"><h4 id="exam-best-subject">--</h4><p id="exam-best-subject-score">Best Subject</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper" style="background-color: #f87171;"><i class="fas fa-biohazard"></i></div>
                        <div class="metric-text"><h4 id="exam-worst-subject">--</h4><p id="exam-worst-subject-score">Worst Subject</p></div>
                    </div>
                </div>
                <div class="analytics-interactive-card">
                    <div class="analytics-card-header">
                        <h4>Performance Deep Dive</h4>
                        <div class="analytics-filters">
                            <select id="exam-time-filter" class="form-select-sm"><option value="all">All Time</option><option value="90">Last 90 Days</option><option value="30">Last 30 Days</option></select>
                            <select id="exam-subject-filter" class="form-select-sm"></select>
                            <select id="exam-chapter-filter" class="form-select-sm" disabled><option value="all">All Chapters</option></select>
                        </div>
                    </div>
                    <div class="analytics-chart-container" style="height: 350px;"><canvas id="interactive-exam-chart"></canvas></div>
                </div>
                <div class="analytics-recommendation-card">
                    <div class="analytics-card-header"><h4><i class="fas fa-lightbulb"></i> Actionable Intelligence</h4></div>
                    <ul class="recommendation-list" id="exam-recommendations-list"></ul>
                </div>
            </div>
            
            <!-- Pane 2: Syllabus Analysis -->
            <div id="pane-analytics-syllabus" class="analytics-pane">
                <div class="analytics-key-metrics-grid">
                     <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-green"><i class="fas fa-tasks"></i></div>
                        <div class="metric-text"><h4 id="syllabus-completion-percent">--%</h4><p>Syllabus Done</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-blue"><i class="fas fa-check-double"></i></div>
                        <div class="metric-text"><h4 id="syllabus-topics-completed">--</h4><p>Topics Completed</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-yellow"><i class="fas fa-hourglass-half"></i></div>
                        <div class="metric-text"><h4 id="syllabus-topics-review">--</h4><p>Needs Review</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-purple"><i class="fas fa-shoe-prints"></i></div>
                        <div class="metric-text"><h4 id="syllabus-topics-remaining">--</h4><p>Topics Left</p></div>
                    </div>
                </div>
                <div class="analytics-interactive-card">
                    <div class="analytics-card-header">
                        <h4>Syllabus Deep Dive</h4>
                        <div class="analytics-filters"><select id="syllabus-subject-selector" class="form-select-sm"></select></div>
                    </div>
                    <div class="analytics-split-container">
                        <div class="analytics-pie-container"><canvas id="syllabus-subject-pie-chart"></canvas></div>
                        <div class="analytics-list-container generic-scrollbar" id="syllabus-chapter-grid"></div>
                    </div>
                </div>
                 <div class="analytics-recommendation-card">
                    <div class="analytics-card-header"><h4><i class="fas fa-lightbulb"></i> Actionable Intelligence</h4></div>
                    <ul class="recommendation-list" id="syllabus-recommendations-list"></ul>
                </div>
            </div>

            <!-- Pane 3: Habits Analysis -->
            <div id="pane-analytics-habits" class="analytics-pane">
                <div class="analytics-key-metrics-grid">
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-blue"><i class="fas fa-bed"></i></div>
                        <div class="metric-text"><h4 id="habit-avg-sleep">-- hr</h4><p>Average Sleep</p></div>
                    </div>
                     <div class="exam-metric-card">
                        <div class="metric-icon-wrapper" style="background-color: #f87171;"><i class="fas fa-mobile-alt"></i></div>
                        <div class="metric-text"><h4 id="habit-avg-screen">-- hr</h4><p>Screen Time</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-yellow"><i class="fas fa-balance-scale-left"></i></div>
                        <div class="metric-text"><h4 id="habit-avg-wasted">-- hr</h4><p>Wasted Time</p></div>
                    </div>
                    <div class="exam-metric-card">
                        <div class="metric-icon-wrapper style-green"><i class="fas fa-fire"></i></div>
                        <div class="metric-text"><h4 id="habit-discipline-rate">--%</h4><p>Discipline Rate</p></div>
                    </div>
                </div>
                <div class="analytics-interactive-card">
<div class="analytics-card-header">
    <h4>Habit & Performance Correlation</h4>
<div class="time-filter-group" id="habit-time-filters">
    <button class="time-filter-btn active" data-days="7">7D</button>
    <button class="time-filter-btn" data-days="15">15D</button>
    <button class="time-filter-btn" data-days="30">30D</button>
    <button class="time-filter-btn" data-days="all">All</button>
</div>
</div>
                    <div class="analytics-chart-container" style="height: 350px;"><canvas id="habit-correlation-chart"></canvas></div>
                </div>
                <div class="analytics-recommendation-card">
                    <div class="analytics-card-header"><h4><i class="fas fa-lightbulb"></i> Actionable Intelligence</h4></div>
                    <ul class="recommendation-list" id="habit-recommendations-list"></ul>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- =================================================================== -->
<!--                      ANALYTICS SECTION END                          -->
<!-- =================================================================== -->



<!-- =================================================================== -->
<!--                        TOPIC SECTION START                          -->
<!-- =================================================================== -->
                <section id="topic" class="content-section">
                    <div class="tracker-container">
                        <!-- NEW HACKER LOADER FOR TOPICS -->
                        <div id="topic-loader" class="loader-container" style="display: none;">
<div class="stretch-loader-container">
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
</div>
<p class="loader-text"></p>
                        </div>
                        
                        <div class="section-header">
                            <h2><i class="fas fa-clipboard-list"></i> Topic Tracker</h2>
                            <div class="section-filters">
                                <div class="tracker-search-wrapper">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="topicSearch" class="tracker-search" placeholder="Search topics...">
                                </div>
                                <div class="tracker-select-filters">
                                    <select id="topicSubjectFilter" class="form-select"></select>
                                    <select id="topicChapterFilter" class="form-select" disabled></select>
                                </div>
                            </div>
                        </div>
                        <div class="kanban-board generic-scrollbar" id="kanbanBoard">
                            <div class="kanban-column" data-status="Not Started"><div class="kanban-column-header"><span class="kanban-column-title">Not Started <span class="topic-count" id="count-Not-Started">0</span></span><button class="btn-add-topic" title="Add New Topic" data-status="Not Started"><i class="fas fa-plus-circle"></i></button></div><div class="kanban-cards generic-scrollbar" id="cards-Not-Started"></div></div>
                            <div class="kanban-column" data-status="In Progress"><div class="kanban-column-header"><span class="kanban-column-title">In Progress <span class="topic-count" id="count-In-Progress">0</span></span><button class="btn-add-topic" title="Add New Topic" data-status="In Progress"><i class="fas fa-plus-circle"></i></button></div><div class="kanban-cards generic-scrollbar" id="cards-In-Progress"></div></div>
                            <div class="kanban-column" data-status="Needs Review"><div class="kanban-column-header"><span class="kanban-column-title">Needs Review <span class="topic-count" id="count-Needs-Review">0</span></span><button class="btn-add-topic" title="Add New Topic" data-status="Needs Review"><i class="fas fa-plus-circle"></i></button></div><div class="kanban-cards generic-scrollbar" id="cards-Needs-Review"></div></div>
                            <div class="kanban-column" data-status="Completed"><div class="kanban-column-header"><span class="kanban-column-title">Completed <span class="topic-count" id="count-Completed">0</span></span><button class="btn-add-topic" title="Add New Topic" data-status="Completed"><i class="fas fa-plus-circle"></i></button></div><div class="kanban-cards generic-scrollbar" id="cards-Completed"></div></div>
                        </div>
                    </div>
                </section>
<!-- =================================================================== -->
<!--                         TOPIC SECTION END                           -->
<!-- =================================================================== -->




<!-- =================================================================== -->
<!--                        EXAMS SECTION START (FINAL FIX)              -->
<!-- =================================================================== -->
<section id="exams" class="content-section">
    <div class="exams-container">
        <!-- NEW HACKER LOADER FOR EXAMS -->
        <div id="exam-loader" class="loader-container" style="display: none;">
<div class="stretch-loader-container">
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
    <div class="loader-bar"></div>
</div>
<p class="loader-text"></p>
        </div>
        
        <!-- Simplified Header to Match Image -->
        <div class="section-header">
            <h2><i class="fas fa-graduation-cap"></i> Exam Tracker</h2>
            <button id="addExamBtn" class="btn-icon-header">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <!-- The Main Scrollable Area -->
        <div class="exam-list generic-scrollbar" id="examListContainer">
        
            <!-- START: NEW SCROLLABLE METRICS SCOREBOARD -->
            <div class="exam-metrics-scroll-area">
                <div class="exam-metric-card">
                    <div class="metric-icon-wrapper style-blue">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="metric-text">
                        <h4 id="metric-total-exams">--</h4>
                        <p>Exams Taken</p>
                    </div>
                </div>
                <div class="exam-metric-card">
                    <div class="metric-icon-wrapper style-purple">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="metric-text">
                        <h4 id="metric-avg-score">--%</h4>
                        <p>Average Score</p>
                    </div>
                </div>
                <div class="exam-metric-card">
                    <div class="metric-icon-wrapper style-green">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="metric-text">
                        <h4 id="metric-score-trend">--</h4>
                        <p>Score Trend</p>
                    </div>
                </div>
                <div class="exam-metric-card">
                     <div class="metric-icon-wrapper style-yellow">
                        <i class="fas fa-trophy"></i>
                    </div>
                     <div class="metric-text">
                        <h4 id="metric-best-subject">--</h4>
                        <p id="metric-best-subject-label">Best Subject</p>
                    </div>
                </div>
            </div>
            <!-- END: NEW SCROLLABLE METRICS SCOREBOARD -->

            <h3 class="exam-list-header">Upcoming Exams</h3>
            <div class="exam-list-grid" id="upcomingExamsGrid"></div>
            <h3 class="exam-list-header">Past Exams</h3>
            <div class="exam-list-grid" id="pastExamsGrid"></div>
        </div>
    </div>
</section>
<!-- =================================================================== -->
<!--                         EXAMS SECTION END                           -->
<!-- =================================================================== -->


<!-- =================================================================== -->
<!--               MOTIVATION SECTION START (NEW LAYOUT)                 -->
<!-- =================================================================== -->
<section id="motivation" class="content-section">
    <!-- View 1: The grid of all videos (YouTube-style home) -->
    <div id="motivation-grid-view" class="motivation-container">
        <!-- Loader for this view -->
        <div id="motivation-loader" class="loader-container" style="display: none;">
            <div class="stretch-loader-container">
                <div class="loader-bar"></div>
                <div class="loader-bar"></div>
                <div class="loader-bar"></div>
                <div class="loader-bar"></div>
            </div>
            <p class="loader-text"></p>
        </div>

        <!-- Header with the "Add" button -->
        <div class="section-header">
            <h2><i class="fas fa-bolt"></i> Motivation</h2>
            <button id="addMotivationBtn" class="btn-icon-header"><i class="fas fa-plus"></i></button>
        </div>
        
        <!-- The grid where video cards will be placed -->
        <div class="motivation-grid generic-scrollbar" id="motivationGrid">
            <!-- Cards will be populated here by JavaScript -->
        </div>
    </div>

    <!-- View 2: The video player layout (hidden by default) -->
<div id="motivation-player-view" class="motivation-player-container">
        <div class="player-main-content">
            <!-- Main Video Player -->
            <div class="player-video-wrapper">
                <div id="player-iframe-container">
                    <!-- The YouTube iframe will be injected here -->
                </div>
            </div>
            <!-- Video Title and Details -->
            <div class="player-video-details">
                <h3 id="player-video-title">Video Title Goes Here</h3>
                <div class="player-channel-info">
                    <div class="player-channel-icon">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <div class="player-channel-name">
                        <p>10 Minute School</p>
                        <span>Verified Channel</span>
                    </div>
                    <button class="player-close-btn" id="player-close-btn">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
        <!-- Playlist on the side -->
        <div class="player-playlist-sidebar generic-scrollbar">
            <div class="player-playlist-header">
                <h4>Up Next</h4>
            </div>
            <div id="player-playlist-items">
                <!-- Playlist videos will be populated here by JavaScript -->
            </div>
        </div>
    </div>
</section>
<!-- =================================================================== -->
<!--                MOTIVATION SECTION END (NEW LAYOUT)                  -->
<!-- =================================================================== -->


<!-- =================================================================== -->
<!--                      SETTINGS SECTION START (NEW)                   -->
<!-- =================================================================== -->
<section id="settings" class="content-section">
    <div class="settings-container">
        <nav class="settings-nav" id="settingsNav">
            <button class="settings-nav-btn active" data-pane="pane-general"><i class="fas fa-cog"></i> General</button>
            <button class="settings-nav-btn" data-pane="pane-theme"><i class="fas fa-palette"></i> Theme</button>
        </nav>
        <div class="settings-content generic-scrollbar">
            <!-- GENERAL PANE -->
            <div id="pane-general" class="settings-pane active">
                <div class="setting-card">
                    <div class="setting-card-content">
                        <h4>Proactive Notifications</h4>
                        <p>Enable push notifications to get personalized coaching, reminders, and weekly reports delivered to your device.</p>
                    </div>
                    <div class="setting-card-action">
                        <button id="btnEnableNotifications" class="btn-primary">Enable Mentor</button>
                    </div>
                </div>
                <div class="setting-card">
                    <div class="setting-card-content">
                        <h4>Exam Countdown Date</h4>
                        <p>Set your next major exam date for the countdown on your dashboard.</p>
                    </div>
                    <div class="setting-card-action">
                        <input type="date" id="settingsExamDate" class="form-input">
                        <button id="saveExamDateBtn" class="btn-primary">Save</button>
                    </div>
                </div>
                <!-- Added: Logout Control -->
                <div class="setting-card">
                    <div class="setting-card-content">
                        <h4>Logout</h4>
                        <p>Sign out of your account and return to the login screen.</p>
                    </div>
                    <div class="setting-card-action">
                        <button id="btnLogout" class="btn-danger">Logout</button>
                    </div>
                </div>
            </div>
            <!-- THEME PANE -->
            <div id="pane-theme" class="settings-pane">
                <div class="setting-card">
                    <div class="setting-card-content">
                        <h4>Theme Color</h4>
                        <p>Personalize your dashboard by choosing your favorite accent color.</p>
                    </div>
                    <div class="setting-card-action">
                        <div class="theme-colors" id="themeColorSelector">
                            <div class="theme-color-option active" style="background-color: #4cfa9d;" data-color="#4cfa9d"></div>
                            <div class="theme-color-option" style="background-color: #38bdf8;" data-color="#38bdf8"></div>
                            <div class="theme-color-option" style="background-color: #f472b6;" data-color="#f472b6"></div>
                            <div class="theme-color-option" style="background-color: #fb923c;" data-color="#fb923c"></div>
                            <div class="theme-color-option" style="background-color: #a78bfa;" data-color="#a78bfa"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- =================================================================== -->
<!--                       SETTINGS SECTION END (NEW)                    -->
<!-- =================================================================== -->

            <!-- Added: Logout control in Settings (General pane) -->
            <script>
                // This script block intentionally left minimal; main logic added below in auth guard
            </script>

            </main>
        </div>
    </div>

    <!-- =================================================================== -->
    <!--                  NEW ACTION HUB HTML (INTEGRATED)                   -->
    <!-- =================================================================== -->
    <button class="center-hub-fab" id="centerHubFab" title="Open Actions">
        <i class="fas fa-bolt"></i>
    </button>
    <div class="center-hub-overlay" id="centerHubOverlay">
        <div class="center-hub-panel">
            <div class="center-hub-header">
                <h4>Action Hub</h4>
                <button class="close-center-hub-btn" id="closeCenterHubBtn">&times;</button>
            </div>
            <div class="hub-card-grid">
                <div class="hub-card" id="sleepTrackerCard">
                    <div id="sleepCardStatic">
                        <i class="hub-card-icon fas fa-bed"></i>
                        <span class="hub-card-title">Sleep Tracker</span>
                        <span class="hub-card-desc">Track sleep</span>
                    </div>
                    <div id="sleepCardLive" style="display: none;">
                        <span class="hub-card-title">Sleeping...</span>
                        <div class="hub-card-timer" id="sleepTimerDisplay">00:00:00</div>
                    </div>
                </div>
                <div class="hub-card" id="practiceCard">
                    <i class="hub-card-icon fas fa-crosshairs"></i>
                    <span class="hub-card-title">Practice Log</span>
                    <span class="hub-card-desc">Log a session</span>
                </div>
                <div class="hub-card" id="dailyCard">
                    <i class="hub-card-icon fas fa-sun"></i>
                    <span class="hub-card-title">Daily Log</span>
                    <span class="hub-card-desc">Log habits</span>
                </div>
            </div>
        </div>
    </div>
    <!-- =================================================================== -->
    <!--                      END: NEW ACTION HUB HTML                       -->
    <!-- =================================================================== -->

    <!-- Resilient wiring for Action Hub (desktop FAB and mobile bolt) -->
    <script>
      (function(){
        function restoreSleepState(){
          const stateKey = 'sleepTrackerState';
          const startKey = 'sleepStartTime';
          const card = document.getElementById('sleepTrackerCard');
          const staticContent = document.getElementById('sleepCardStatic');
          const liveContent = document.getElementById('sleepCardLive');
          const display = document.getElementById('sleepTimerDisplay');
          if (!card || !staticContent || !liveContent || !display) return;
          const current = localStorage.getItem(stateKey);
          if (current === 'running') {
            card.classList.add('tracking-active');
            staticContent.style.display = 'none';
            liveContent.style.display = 'flex';
            const startTime = parseInt(localStorage.getItem(startKey) || '0', 10);
            if (!isNaN(startTime) && startTime > 0) {
              if (window.__sleepLocalTimer) clearInterval(window.__sleepLocalTimer);
              window.__sleepLocalTimer = setInterval(()=>{
                const ms = Date.now() - startTime;
                const h = String(Math.floor(ms/3600000)).padStart(2,'0');
                const m = String(Math.floor((ms%3600000)/60000)).padStart(2,'0');
                const s = String(Math.floor((ms%60000)/1000)).padStart(2,'0');
                display.textContent = `${h}:${m}:${s}`;
              }, 1000);
            }
          } else {
            // Ensure UI is in static state when not running
            card.classList.remove('tracking-active');
            staticContent.style.display = 'flex';
            liveContent.style.display = 'none';
            display.textContent = '00:00:00';
            if (window.__sleepLocalTimer) { clearInterval(window.__sleepLocalTimer); window.__sleepLocalTimer = null; }
          }
        }
        function openHub(){
          const overlayEl = document.getElementById('centerHubOverlay');
          const panelEl = overlayEl?.querySelector('.center-hub-panel');
          panelEl?.classList.remove('scroll-ready');
          overlayEl?.classList.add('visible');
          document.body.classList.add('no-scroll');
          // Wait for opening animation to finish before enabling scrollbars
          setTimeout(()=>{ panelEl?.classList.add('scroll-ready'); }, 420);
          // Ensure sleep state is reflected when hub becomes visible
          restoreSleepState();
        }
        function closeHub(){
          const overlayEl = document.getElementById('centerHubOverlay');
          const panelEl = overlayEl?.querySelector('.center-hub-panel');
          overlayEl?.classList.remove('visible');
          panelEl?.classList.remove('scroll-ready');
          document.body.classList.remove('no-scroll');
          // Reduce background timer churn while hidden
          if (window.__sleepLocalTimer) { clearInterval(window.__sleepLocalTimer); window.__sleepLocalTimer = null; }
        }
        function wire(){
          const fab = document.getElementById('centerHubFab');
          const actionBtn = document.getElementById('actionButton');
          const closeBtn = document.getElementById('closeCenterHubBtn');
          const overlay = document.getElementById('centerHubOverlay');
          const sleepCard = document.getElementById('sleepTrackerCard');
          const practiceCard = document.getElementById('practiceCard');
          const dailyCard = document.getElementById('dailyCard');
          const formPopup = document.getElementById('formPopupOverlay');
          fab?.addEventListener('click', openHub);
          actionBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openHub(); });
          closeBtn?.addEventListener('click', closeHub);
          overlay?.addEventListener('click', (e)=>{ if (e.target === overlay) closeHub(); });

          // Fallback actions if main initializer didn't bind
          sleepCard?.addEventListener('click', ()=>{
            try {
              if (window.handleTrackerClick) { window.handleTrackerClick('sleep'); return; }
            } catch(_){}
            // Local fallback if core functions aren't ready
            const stateKey = 'sleepTrackerState';
            const startKey = 'sleepStartTime';
            const card = document.getElementById('sleepTrackerCard');
            const staticContent = document.getElementById('sleepCardStatic');
            const liveContent = document.getElementById('sleepCardLive');
            const display = document.getElementById('sleepTimerDisplay');
            if (!card || !staticContent || !liveContent || !display) return;
            const current = localStorage.getItem(stateKey);
            if (current === 'running') {
              // stop
              const startTime = parseInt(localStorage.getItem(startKey) || '0', 10);
              const durationMs = Date.now() - (isNaN(startTime) ? 0 : startTime);
              localStorage.removeItem(stateKey);
              localStorage.removeItem(startKey);
              card.classList.remove('tracking-active');
              staticContent.style.display = 'flex';
              liveContent.style.display = 'none';
              display.textContent = '00:00:00';
              if (window.__sleepLocalTimer) { clearInterval(window.__sleepLocalTimer); window.__sleepLocalTimer = null; }
            } else {
              // start
              localStorage.setItem(stateKey, 'running');
              localStorage.setItem(startKey, String(Date.now()));
              card.classList.add('tracking-active');
              staticContent.style.display = 'none';
              liveContent.style.display = 'flex';
              const startTime = parseInt(localStorage.getItem(startKey) || '0', 10);
              let timer = window.__sleepLocalTimer;
              if (timer) clearInterval(timer);
              window.__sleepLocalTimer = setInterval(()=>{
                const ms = Date.now() - startTime;
                const h = String(Math.floor(ms/3600000)).padStart(2,'0');
                const m = String(Math.floor((ms%3600000)/60000)).padStart(2,'0');
                const s = String(Math.floor((ms%60000)/1000)).padStart(2,'0');
                display.textContent = `${h}:${m}:${s}`;
              }, 1000);
            }
          });
          practiceCard?.addEventListener('click', ()=>{
            closeHub();
            setTimeout(()=>{
              formPopup?.classList.add('visible');
              document.getElementById('tabPractice')?.click();
            }, 300);
          });
          dailyCard?.addEventListener('click', ()=>{
            closeHub();
            setTimeout(()=>{
              formPopup?.classList.add('visible');
              document.getElementById('tabDailyLog')?.click();
            }, 300);
          });
          // Initial restoration at load
          restoreSleepState();
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wire); else wire();
      })();
    </script>

    <script>
    // ===================================================================
    //                        CONFIGURATION & STATE
    // ===================================================================
const SUPABASE_URL = 'https://wivtgqflsutzqexuigyy.supabase.co'; // Correct URL
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpdnRncWZsc3V0enFleHVpZ3l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTk0NDQsImV4cCI6MjA3MDczNTQ0NH0.QqnyKKgJm55lKyrzCaxIOP4mr79Q6eqRyJ5T5oVqvhs';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // Correct initialization
    
    // NOTE: This is hardcoded syllabus data, as it was in the original file.
    const chapterData = { "Physics": ["ভেক্টর", "নিউটনীয় বলবিদ্যা", "কাজ, শক্তি ও ক্ষমতা", "মহাকর্ষ ও অভিকর্ষ", "পদার্থের গাঠনিক ধর্ম", "পর্যায়বৃত্তিক গতি", "আদর্শ গ্যাস ও গ্যাসের গতিতত্ত্ব", "তাপগতিবিদ্যা", "স্থির তড়িৎ", "চল তড়িৎ", "ভৌত আলোকবিজ্ঞান", "আধুনিক পদার্থবিজ্ঞানের সূচনা", "পরমাণু মডেল ও নিউ্লিয়ার পদার্থবিজ্ঞান", "সেমিকন্ডাক্টর ও ইলেকট্রনিক্স"], "Chemistry": ["ল্যাবরেটরির নিরাপদ ব্যবহার", "গুণগত রসায়ন", "মৌলের পর্যায়বৃত্ত ধর্ম ও রাসায়নিক বন্ধন", "রাসায়নিক পরিবর্তন", "কর্মমুখী রসায়ন", "পরিবেশ রসায়ন", "জৈব রসায়ন", "পরিমাণগত রসায়ন", "তড়িৎ রসায়ন"], "Math": ["ম্যাট্রিক্স ও নির্ণায়ক", "সরলরেখা", "বৃত্ত", "সংযুক্ত কোণের ত্রিকোণমিতিক অনুপাত", "অন্তরীকরণ", "যোগজীকরণ", "জটিল সংখ্যা", "বহুপদী ও বহুপদী সমীকরণ", "কণিক", "বিপরীত ত্রিকোণমিতিক ফাংশন ও ত্রিকোণমিতিক সমীকরণ", "স্থিতিবিদ্যা", "সমতলে বস্তুকণার গতি"], "Biology": ["কোষ ও এর গঠন", "কোষ বিভাজন", "অণুজীব", "নগ্নবীজী ও আবৃতবীজী উদ্ভিদ", "টিস্যু ও টিস্যুতন্ত্র", "উদ্ভিদ শারীরতত্ত্ব", "জীবপ্রযুক্তি", "প্রাণির বিভিন্নতা ও শ্রেণিবিন্যাস", "প্রাণির পরিচিতি", "পরিপাক ও শোষণ", "রক্ত ও সঞ্চালন", "শ্বসন ও শ্বাসক্রিয়া", "চলন ও অঙ্গচালনা", "জিনতত্ত্ব ও বিবর্তন"] };

    const subjectColors = { "Physics": "#60a5fa", "Chemistry": "#f87171", "Math": "#fb923c", "Biology": "#4cfa9d", "N/A": "#8b949e" };
    
        const QUOTES = [
        // --- Original 8 Quotes ---
        { quote: "The secret of getting ahead is getting started.", author: "Mark Twain" },
        { quote: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
        { quote: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
        { quote: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
        { quote: "Success is the sum of small efforts, repeated day-in and day-out.", author: "Robert Collier" },
        { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
        { quote: "The harder I work, the luckier I get.", author: "Samuel Goldwyn" },
        { quote: "Strive for progress, not perfection.", author: "Unknown" },

        // --- New Additions (80+ Quotes) ---
        
        // --- On Self-Knowledge & Introspection ---
        { quote: "Knowing yourself is the beginning of all wisdom.", author: "Aristotle" },
        { quote: "To know thyself is the beginning of wisdom.", author: "Socrates" },
        { quote: "The unexamined life is not worth living.", author: "Socrates" },
        { quote: "Who looks outside, dreams; who looks inside, awakes.", author: "Carl Jung" },
        { quote: "Your vision will become clear only when you can look into your own heart.", author: "Carl Jung" },
        { quote: "Everything that irritates us about others can lead us to an understanding of ourselves.", author: "Carl Jung" },
        { quote: "Mastering others is strength. Mastering yourself is true power.", author: "Lao Tzu" },
        { quote: "Waste no more time arguing about what a good man should be. Be one.", author: "Marcus Aurelius" },

        // --- On Discipline & Habits ---
        { quote: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.", author: "Aristotle" },
        { quote: "Discipline is the bridge between goals and accomplishment.", author: "Jim Rohn" },
        { quote: "You do not rise to the level of your goals. You fall to the level of your systems.", author: "James Clear" },
        { quote: "Every action you take is a vote for the type of person you wish to become.", author: "James Clear" },
        { quote: "The successful warrior is the average man, with laser-like focus.", author: "Bruce Lee" },
        { quote: "I fear not the man who has practiced 10,000 kicks once, but I fear the man who has practiced one kick 10,000 times.", author: "Bruce Lee" },
        { quote: "Discipline is choosing between what you want now and what you want most.", author: "Abraham Lincoln" },
        { quote: "The first and best victory is to conquer self.", author: "Plato" },
        { quote: "Motivation is what gets you started. Habit is what keeps you going.", author: "Jim Rohn" },
        { quote: "It is not that we have a short time to live, but that we waste a lot of it.", author: "Seneca" },
        
        // --- On Learning & Knowledge ---
        { quote: "An investment in knowledge pays the best interest.", author: "Benjamin Franklin" },
        { quote: "The beautiful thing about learning is that no one can take it away from you.", author: "B.B. King" },
        { quote: "What we learn with pleasure we never forget.", author: "Alfred Mercier" },
        { quote: "Live as if you were to die tomorrow. Learn as if you were to live forever.", author: "Mahatma Gandhi" },
        { quote: "The expert in anything was once a beginner.", author: "Helen Hayes" },
        { quote: "Intellectual growth should commence at birth and cease only at death.", author: "Albert Einstein" },
        { quote: "Tell me and I forget. Teach me and I remember. Involve me and I learn.", author: "Benjamin Franklin" },
        { quote: "The learning process is something you can incite, literally incite, like a riot.", author: "Audre Lorde" },
        { quote: "Develop a passion for learning. If you do, you will never cease to grow.", author: "Anthony J. D'Angelo" },
        { quote: "Nothing in life is to be feared, it is only to be understood. Now is the time to understand more, so that we may fear less.", author: "Marie Curie" },

        // --- On Perseverance & Resilience ---
        { quote: "The journey of a thousand miles begins with a single step.", author: "Lao Tzu" },
        { quote: "The man who moves a mountain begins by carrying away small stones.", author: "Confucius" },
        { quote: "Fall seven times, stand up eight.", author: "Japanese Proverb" },
        { quote: "I have not failed. I've just found 10,000 ways that won't work.", author: "Thomas A. Edison" },
        { quote: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
        { quote: "Perseverance is not a long race; it is many short races one after the other.", author: "Walter Elliot" },
        { quote: "It's hard to beat a person who never gives up.", author: "Babe Ruth" },
        { quote: "The impediment to action advances action. What stands in the way becomes the way.", author: "Marcus Aurelius" },
        { quote: "A river cuts through rock, not because of its power, but because of its persistence.", author: "Jim Watkins" },
        { quote: "I've missed more than 9000 shots in my career. I've lost almost 300 games. 26 times I've been trusted to take the game winning shot and missed. I've failed over and over and over again in my life. And that is why I succeed.", author: "Michael Jordan" },

        // --- On Action & Procrastination ---
        { quote: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
        { quote: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
        { quote: "Your future is created by what you do today, not tomorrow.", author: "Robert Kiyosaki" },
        { quote: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
        { quote: "A year from now you may wish you had started today.", author: "Karen Lamb" },
        { quote: "Amateurs sit and wait for inspiration, the rest of us just get up and go to work.", author: "Stephen King" },
        { quote: "Do the hard jobs first. The easy jobs will take care of themselves.", author: "Dale Carnegie" },
        { quote: "Action is the foundational key to all success.", author: "Pablo Picasso" },
        { quote: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
        { quote: "If you want to make an easy job seem mighty hard, just keep putting off doing it.", author: "Olin Miller" },
        
        // --- On Focus & Time Management ---
        { quote: "Focus on being productive instead of busy.", author: "Tim Ferriss" },
        { quote: "The key is not to prioritize what's on your schedule, but to schedule your priorities.", author: "Stephen Covey" },
        { quote: "What gets measured gets managed.", author: "Peter Drucker" },
        { quote: "Concentrate all your thoughts upon the work in hand. The sun's rays do not burn until brought to a focus.", author: "Alexander Graham Bell" },
        { quote: "Ordinary people think merely of spending time, great people think of using it.", author: "Arthur Schopenhauer" },
        { quote: "You will never find time for anything. If you want time, you must make it.", author: "Charles Buxton" },
        { quote: "The shorter the deadline, the more likely you are to get it done.", author: "N. R. Narayana Murthy" },
        { quote: "Lack of direction, not lack of time, is the problem. We all have twenty-four hour days.", author: "Zig Ziglar" },

        // --- On Potential & Growth ---
        { quote: "He who has a why to live for can bear almost any how.", author: "Friedrich Nietzsche" },
        { quote: "Genius is one percent inspiration and ninety-nine percent perspiration.", author: "Thomas Edison" },
        { quote: "The only limit to our realization of tomorrow is our doubts of today.", author: "Franklin D. Roosevelt" },
        { quote: "Whether you think you can, or you think you can't – you're right.", author: "Henry Ford" },
        { quote: "What you get by achieving your goals is not as important as what you become by achieving your goals.", author: "Zig Ziglar" },
        { quote: "Continuous improvement is better than delayed perfection.", author: "Mark Twain" },
        { quote: "A man's mind, stretched by a new idea, can never go back to its original dimensions.", author: "Oliver Wendell Holmes Jr." },
        { quote: "Smooth seas do not make skillful sailors.", author: "African Proverb" },
        { quote: "Be not afraid of growing slowly; be afraid only of standing still.", author: "Chinese Proverb" },
        { quote: "If you are not willing to learn, no one can help you. If you are determined to learn, no one can stop you.", author: "Zig Ziglar" },
        { quote: "If you get one percent better each day for one year, you’ll end up thirty-seven times better by the time you’re done.", author: "James Clear" },
        { quote: "One can choose to go back toward safety or forward toward growth.", author: "Abraham Maslow" },
        { quote: "Absorb what is useful, discard what is not, add what is uniquely your own.", author: "Bruce Lee" },
        { quote: "Do not go where the path may lead, go instead where there is no path and leave a trail.", author: "Ralph Waldo Emerson" },
        { quote: "It is in the moment of decision that your destiny is shaped.", author: "Tony Robbins" },
        { quote: "The mind is not a vessel to be filled, but a fire to be kindled.", author: "Plutarch" }
    ];


    let allTopics = [], allExams = [], allPracticeLogs = [], allDailyLogs = [], allMotivationVideos = [];
    let dataCache = { dashboard: false, reports: false, analytics: false, topic: false, exams: false, motivation: false, settings: false };
    window.myCharts = {};
    window.dashboardData = {}; 
    window.activeTimers = { sleep: null }; // For new Action Hub
    const chartDefaultOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e0e0e0', padding: 20 } }, title: { display: false } }, scales: { x: { ticks: { color: '#8b949e' }, grid: { color: 'rgba(255,255,255,0.05)' } }, y: { ticks: { color: '#8b949e' }, grid: { color: 'rgba(255,255,255,0.1)' } } } };

    // ===================================================================
    //                        HELPER & CORE FUNCTIONS
    // ===================================================================
    /**
     * A helper function to handle supabaseClient responses, throwing an error if one exists.
     * @param {Promise} promise - The supabaseClient query promise.
     * @returns {Promise<any>} The data from the successful response.
     */
    async function handlesupabaseClientResponse(promise) {
        const { data, error } = await promise;
        if (error) {
            console.error('supabaseClient Error:', error);
            throw new Error(error.message);
        }
        return data;
    }

    function formatHoursToHoursMinutes(totalMinutes) {
        if (!totalMinutes || totalMinutes < 1) return '0m';
        totalMinutes = Number(totalMinutes);
        const h = Math.floor(totalMinutes / 60);
        const m = Math.round(totalMinutes % 60);
        let parts = [];
        if (h > 0) parts.push(`${h}h`);
        if (m > 0 || h === 0) parts.push(`${m}m`);
        return parts.join(' ').trim() || '0m';
    }
    
    function showSuccessAnimation(message) { 
        const overlay = document.getElementById('successOverlay'); 
        document.getElementById('successText').textContent = message; 
        overlay.style.display = 'flex'; 
        setTimeout(() => { 
            overlay.style.display = 'none'; 
        }, 2500); 
    }

    function startStretchLoader(loaderId, text) {
        const loader = document.getElementById(loaderId);
        if (!loader) return;
        
        const textElement = loader.querySelector('.loader-text');
        if (textElement) textElement.textContent = text;
        
        loader.style.display = 'flex';
    }

    // Main Initializer on DOM Content Loaded
    document.addEventListener('DOMContentLoaded', () => { 

// REPLACE with this updated function
window.showSection = async function(sectionId) { 
    // This is the CRITICAL BUG FIX
    document.querySelectorAll('.content-section.active').forEach(s => {
        // If we are leaving the motivation section, reset its player view.
        if (s.id === 'motivation') {
            closeVideoPlayerLayout();
        }
        s.classList.remove('active');
    });

    document.getElementById(sectionId).classList.add('active'); 
    
    const sectionsInMorePanel = ['reports', 'exams', 'motivation', 'settings'];

    document.querySelectorAll('.desktop-nav .nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('onclick').includes(sectionId)) {
            item.classList.add('active');
        }
    });
    
    // [MODIFIED] Simplified mobile nav logic to remove spacer reference
    document.querySelectorAll('.new-mobile-nav-wrapper .new-mobile-nav-item').forEach(item => {
        item.classList.remove('active');
        const onclickAttr = item.getAttribute('onclick');
        
        if (sectionsInMorePanel.includes(sectionId) && item.id === 'more-btn') {
            item.classList.add('active');
        } 
        else if (onclickAttr && onclickAttr.includes(sectionId)) {
            item.classList.add('active');
        }
    });
    
    if (dataCache[sectionId] && sectionId !== 'dashboard') return; 
    
    switch (sectionId) { 
        case 'dashboard': await fetchAndPopulateDashboard(); break; 
        case 'reports': await fetchReportPrerequisites(); initReportWizard(); break; 
        case 'analytics': await loadAnalyticsData(); break; 
        case 'topic': await fetchTopics(); break; 
        case 'exams': await fetchExams(); break; 
        case 'motivation': await fetchMotivationVideos(); break; 
        case 'settings': loadSettings(); break; 
    } 
    dataCache[sectionId] = true; 
}; 
        
        // [REMOVED] Old popup button listeners
        
        initLogForms(); 
        initExamModal(); 
        initArenaModal(); 
        initAnalyticsPanes(); 
        initMotivationModals(); 
        initSettings(); 
        showSection('dashboard'); 
        initNewMobileNav();
        initActionHub(); // [ADDED] Initialize the new Action Hub
    });
    
    // ===================================================================
    //                        DASHBOARD LOGIC
    // ===================================================================
 async function fetchAndPopulateDashboard() {
        // --- NEW: CONFIGURATION FOR LOADER TIMING ---
        // Set the minimum time in milliseconds you want the quote to be visible.
        // 2500ms = 2.5 seconds. Adjust this value to your liking.
        const MINIMUM_QUOTE_DISPLAY_TIME = 5000;

        const loader = document.getElementById('dashboard-loader');
        const quoteTextEl = loader.querySelector('.quote-text');
        const authorTextEl = loader.querySelector('.quote-author');
        const dashboardSection = document.getElementById('dashboard');

        // Show the loader immediately
        const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        quoteTextEl.innerHTML = `&ldquo;${randomQuote.quote}&rdquo;`;
        authorTextEl.textContent = `— ${randomQuote.author}`;
        dashboardSection.classList.add('no-scroll');
        loader.style.display = 'flex';

        try {
            // --- NEW LOGIC: START BOTH TASKS AT THE SAME TIME ---
            // Task 1: A promise that resolves after our minimum display time has passed.
            const minimumTimePromise = new Promise(resolve => setTimeout(resolve, MINIMUM_QUOTE_DISPLAY_TIME));

            // Task 2: The original promise to fetch all data from Supabase.
            const fetchDataPromise = Promise.all([
                handlesupabaseClientResponse(supabaseClient.from('DailyLogs').select('*')),
                handlesupabaseClientResponse(supabaseClient.from('PracticeLogs').select('*')),
                handlesupabaseClientResponse(supabaseClient.from('Exams').select('*')),
                handlesupabaseClientResponse(supabaseClient.from('Topics').select('*'))
            ]);

            // --- WAIT FOR BOTH TO COMPLETE ---
            // Promise.all waits for the slowest promise to finish.
            // If data loads in 500ms, it will wait for the 2500ms timer.
            // If data takes 3000ms to load, it will wait for the data.
            // This guarantees the loader is shown for at least MINIMUM_QUOTE_DISPLAY_TIME.
            const [fetchedData] = await Promise.all([fetchDataPromise, minimumTimePromise]);
            
            // Destructure the data we fetched
            const [dailyLogs, practiceLogs, exams, topics] = fetchedData;
            
            allDailyLogs = dailyLogs || [];
            allPracticeLogs = practiceLogs || [];
            allExams = exams || [];
            allTopics = topics || [];
            
            // Now that we have the data and the time has passed, populate the page
            populateDashboardValues();
            renderDashboardCharts();
            
            // This part remains the same
            if (document.getElementById('formPopupOverlay').classList.contains('visible') && document.getElementById('tabDailyLog').classList.contains('active')) {
                loadTodaysDailyLog();
            }
            
        } catch (error) {
            console.error("Could not fetch dashboard data:", error);
            document.querySelectorAll('.metric-value').forEach(el => {
                el.textContent = '--';
            });
        } finally {
            // The loader is now hidden in the finally block without an extra timeout,
            // because we already waited for the minimum time in the try block.
            loader.style.display = 'none';
            dashboardSection.classList.remove('no-scroll');
        }
    }

    function populateDashboardValues() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toLocaleDateString('en-CA');

        const todayDailyLog = allDailyLogs.find(log => new Date(log.Date).toLocaleDateString('en-CA') === todayStr);
        const todayPracticeLogs = allPracticeLogs.filter(log => new Date(log.Date).toLocaleDateString('en-CA') === todayStr);

        const sleepHours = todayDailyLog ? (Number(todayDailyLog.sleepHours) || 0) : 0;
        const screenTime = todayDailyLog ? (Number(todayDailyLog.screenTime) || 0) : 0;
        const disciplineStreak = calculateDisciplineStreak(allDailyLogs);

        let totalProductiveMinutesToday = 0;
        todayPracticeLogs.forEach(log => {
            totalProductiveMinutesToday += (Number(log.timeSpent) || 0) + ((Number(log.classTime) || 0) * 60);
        });
        const productiveHoursToday = totalProductiveMinutesToday / 60;
        const awakeHoursToday = 24 - sleepHours;
        const wastedHoursToday = Math.max(0, awakeHoursToday - productiveHoursToday);
        const efficiencyToday = awakeHoursToday > 0 ? (productiveHoursToday / awakeHoursToday) * 100 : 0;

        const completedExams = allExams.filter(e => e.Status === 'Completed' && e.Score != null && e.TotalMarks > 0);
        const avgExamScore = completedExams.length > 0
            ? (completedExams.reduce((sum, e) => sum + (Number(e.Score) / Number(e.TotalMarks)), 0) / completedExams.length * 100).toFixed(1)
            : 'N/A';

        const totalTopics = allTopics.length;
        const completedTopicsCount = allTopics.filter(t => t.Status === 'Completed').length;
        const syllabusCompletion = totalTopics > 0 ? (completedTopicsCount / totalTopics * 100).toFixed(0) : 'N/A';

        const subjectPerformance = calculateSubjectPerformance(completedExams);
        let bestSubject = 'N/A';
        let maxAvgScore = -1;

        for (const subject in subjectPerformance) {
            if (subjectPerformance[subject].count > 0 && subjectPerformance[subject].avgScore > maxAvgScore) {
                maxAvgScore = subjectPerformance[subject].avgScore;
                bestSubject = subject;
            }
        }

        const elExam = document.querySelector('.metric-exam-score .metric-value');
        const elSyllabus = document.querySelector('.metric-syllabus .metric-value');
        const elBest = document.querySelector('.metric-best-subject .metric-value');
        const elStreak = document.querySelector('.metric-streak .metric-value');
        const elEff = document.querySelector('.metric-efficiency .metric-value');
        const elProd = document.querySelector('.metric-productive .metric-value');

        if (elExam) elExam.innerHTML = `${avgExamScore === 'N/A' ? 'N/A' : avgExamScore}<small>${avgExamScore === 'N/A' ? '' : '%'}</small>`;
        if (elSyllabus) elSyllabus.innerHTML = `${syllabusCompletion === 'N/A' ? 'N/A' : syllabusCompletion}<small>${syllabusCompletion === 'N/A' ? '' : '%'}</small>`;
        if (elBest) elBest.textContent = bestSubject;
        if (elStreak) elStreak.innerHTML = `${disciplineStreak} <small>Days</small>`;
        if (elEff) elEff.innerHTML = `${isFinite(efficiencyToday) ? efficiencyToday.toFixed(0) : 0}<small>%</small>`;
        if (elProd) elProd.innerHTML = `${isFinite(productiveHoursToday) ? productiveHoursToday.toFixed(1) : 0} <small>hrs</small>`;
        
        let timeBalanceRatio = '0:0';
        if (productiveHoursToday > 0 || wastedHoursToday > 0) {
            const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
            const commonDivisor = gcd(Math.round(productiveHoursToday * 10), Math.round(wastedHoursToday * 10));
            if (commonDivisor > 0) { timeBalanceRatio = `${(productiveHoursToday * 10 / commonDivisor).toFixed(0)}:${(wastedHoursToday * 10 / commonDivisor).toFixed(0)}`;
            } else if (productiveHoursToday > 0) { timeBalanceRatio = '1:0';
            } else if (wastedHoursToday > 0) { timeBalanceRatio = '0:1'; }
        }
        const elWasted = document.querySelector('.metric-wasted .metric-value');
        const elScreen = document.querySelector('.metric-screen-time .metric-value');
        if (elWasted) elWasted.innerHTML = `${timeBalanceRatio}<small>ratio</small>`;
        if (elScreen) elScreen.innerHTML = `${isFinite(screenTime) ? screenTime.toFixed(1) : '0.0'} <small>hrs</small>`;

        // Debug logs to verify bindings update the on-screen elements
        try {
            console.debug('[Dashboard] Values set:', {
                exam: elExam?.innerText, syllabus: elSyllabus?.innerText, best: elBest?.innerText,
                streak: elStreak?.innerText, eff: elEff?.innerText, prod: elProd?.innerText,
                balance: elWasted?.innerText, screen: elScreen?.innerText
            });
        } catch (_) {}

        window.dashboardData = { avgExamScore, syllabusCompletion, bestSubject, disciplineStreak, efficiencyToday, productiveHoursToday, wastedHoursToday, screenTime, allExams, allTopics, allPracticeLogs, allDailyLogs };

        const totalMCQs = allPracticeLogs.reduce((sum, log) => sum + (Number(log.mcqCount) || 0), 0);
        const totalSAQs = allPracticeLogs.reduce((sum, log) => sum + (Number(log.saqCount) || 0), 0);
        const uniquePercentage = allPracticeLogs.length > 0 ? (allPracticeLogs.filter(log => log.isUnique).length / allPracticeLogs.length * 100).toFixed(0) : '0';
        document.querySelector('.summary-stat:nth-child(1) .summary-stat-value').textContent = totalMCQs;
        document.querySelector('.summary-stat:nth-child(2) .summary-stat-value').textContent = totalSAQs;
        document.querySelector('.summary-stat:nth-child(3) .summary-stat-value').textContent = `${uniquePercentage}%`;

        const insights = generateActionableInsights(window.dashboardData);
        displayActionableInsights(insights);

        const weeklyReportInsights = generateWeeklyReportData(window.dashboardData);
        displayWeeklyReport(weeklyReportInsights);
    }

    function generateActionableInsights(dashboardData) {
        const { allDailyLogs, efficiencyToday, productiveHoursToday, wastedHoursToday } = dashboardData;
        let insights = [];
        const todayStr = new Date().toLocaleDateString('en-CA');
        const todayDailyLog = allDailyLogs.find(log => new Date(log.Date).toLocaleDateString('en-CA') === todayStr);
        let sleepScreenInsight;
        if (todayDailyLog) {
            const sleepHours = Number(todayDailyLog.sleepHours) || 0;
            const screenTime = Number(todayDailyLog.screenTime) || 0;
            if (screenTime > 10) {
                sleepScreenInsight = { icon: 'fa-triangle-exclamation', color: '#ef4444', title: 'Critical Screen Time', text: `Over ${screenTime.toFixed(0)} hours is severely impacting your focus and health. Drastic reduction is needed.` };
            } else if (sleepHours > 0 && sleepHours < 6.5) {
                sleepScreenInsight = { icon: 'fa-bed', color: '#f59e0b', title: 'Sleep Deprived', text: `Only ${sleepHours.toFixed(1)} hours of sleep. This will negatively affect memory and concentration.` };
            } else if (screenTime > 6) {
                sleepScreenInsight = { icon: 'fa-mobile-screen-button', color: '#f59e0b', title: 'High Screen Time', text: `Your screen time of ${screenTime.toFixed(1)} hours is high. Be mindful of digital distractions.` };
            } else if (sleepHours > 9) {
                 sleepScreenInsight = { icon: 'fa-bed-pulse', color: '#3b82f6', title: 'Potential Oversleeping', text: `You logged ${sleepHours.toFixed(1)} hours. While rest is good, oversleeping can also lead to grogginess.` };
            } else {
                sleepScreenInsight = { icon: 'fa-shield-halved', color: '#4ade80', title: 'Life Balance: Good', text: `Sleep (${sleepHours.toFixed(1)}h) and Screen Time (${screenTime.toFixed(1)}h) are well-managed today.` };
            }
        } else {
            sleepScreenInsight = { icon: 'fa-question-circle', color: '#8b949e', title: 'Log Your Habits', text: 'No sleep or screen time data logged for today. Fill in your daily log for feedback.' };
        }
        insights.push(sleepScreenInsight);
        let prayerDisciplineInsight;
        if (todayDailyLog) {
            const discipline = todayDailyLog.discipline;
            const prayers = Number(todayDailyLog.prayers) || 0;

            if (discipline === false) {
                prayerDisciplineInsight = { icon: 'fa-user-slash', color: '#ef4444', title: 'Discipline Broken', text: 'You marked a lapse in discipline. Reflect on the cause and recommit now.' };
            } else if (prayers < 4) {
                prayerDisciplineInsight = { icon: 'fa-hands-praying', color: '#f59e0b', title: 'Habits Check-in', text: `You logged ${prayers} of 5 prayers. Staying consistent with small habits builds momentum.` };
            } else {
                prayerDisciplineInsight = { icon: 'fa-award', color: '#4ade80', title: 'Commitment: Strong', text: 'Discipline maintained and all habits logged. Excellent consistency!' };
            }
        } else {
            prayerDisciplineInsight = { icon: 'fa-question-circle', color: '#8b949e', title: 'Log Your Discipline', text: 'No discipline or prayer data logged for today. Update your daily log.' };
        }
        insights.push(prayerDisciplineInsight);
        let timeEfficiencyInsight;
        if (productiveHoursToday > 0 || wastedHoursToday > 0) {
            if (efficiencyToday < 35) {
                timeEfficiencyInsight = { icon: 'fa-arrow-trend-down', color: '#ef4444', title: 'Efficiency Critical', text: `Only ${efficiencyToday.toFixed(0)}% efficiency. Identify and eliminate your main distractions.` };
            } else if (wastedHoursToday > productiveHoursToday) {
                timeEfficiencyInsight = { icon: 'fa-balance-scale-right', color: '#f59e0b', title: 'Time Balance Off', text: `Wasted time (${wastedHoursToday.toFixed(1)}h) is greater than productive time (${productiveHoursToday.toFixed(1)}h).` };
            } else if (productiveHoursToday > 0 && productiveHoursToday < 2) {
                timeEfficiencyInsight = { icon: 'fa-hourglass-start', color: '#3b82f6', title: 'Low Study Volume', text: `Only ${productiveHoursToday.toFixed(1)} hours studied. It's a start, but aim for more dedicated time.` };
            } else {
                timeEfficiencyInsight = { icon: 'fa-rocket', color: '#4ade80', title: 'Efficiency: Excellent', text: `Productive time is high and efficiency is at ${efficiencyToday.toFixed(0)}%. You're in the zone!` };
            }
        } else {
            timeEfficiencyInsight = { icon: 'fa-book', color: '#8b949e', title: 'Ready to Study?', text: 'No productive time has been logged yet for today. Start a session to see feedback here.' };
        }
        insights.push(timeEfficiencyInsight);
        return insights;
    }

    function generateWeeklyReportData(dashboardData) {
        const { allPracticeLogs } = dashboardData;
        let insights = [];
        const today = new Date();
        const getLogsForPeriod = (daysAgoStart, daysAgoEnd) => {
            const startDate = new Date(today); startDate.setDate(today.getDate() - daysAgoStart); startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(today); endDate.setDate(today.getDate() - daysAgoEnd); endDate.setHours(23, 59, 59, 999);
            return allPracticeLogs.filter(log => {
                const logDate = new Date(log.Date);
                return logDate >= startDate && logDate <= endDate;
            });
        };
        const calculateSubjectHours = (logs) => {
            const subjectHours = {};
            Object.keys(chapterData).forEach(sub => { subjectHours[sub] = 0; });
            logs.forEach(log => {
                const subject = log.Subject || 'Other';
                if(subjectHours.hasOwnProperty(subject)) {
                    const hours = ((Number(log.timeSpent) || 0) / 60) + (Number(log.classTime) || 0);
                    subjectHours[subject] += hours;
                }
            });
            return subjectHours;
        };
        const getTrendText = (current, previous) => {
            if (previous > 0) {
                const percentChange = ((current - previous) / previous) * 100;
                return `which is ${percentChange >= 0 ? 'up' : 'down'} ${Math.abs(percentChange).toFixed(0)}% from last week.`;
            } else if (current > 0) {
                return 'A great start to tracking your weekly progress!';
            }
            return 'Log more to see your trends.';
        };
        const lastWeekLogs = getLogsForPeriod(6, 0); 
        const previousWeekLogs = getLogsForPeriod(13, 7); 
        const lastWeekHours = lastWeekLogs.reduce((sum, log) => sum + ((Number(log.timeSpent) || 0) / 60) + (Number(log.classTime) || 0), 0);
        const previousWeekHours = previousWeekLogs.reduce((sum, log) => sum + ((Number(log.timeSpent) || 0) / 60) + (Number(log.classTime) || 0), 0);
        
        let performanceInsight;
        const trendText = getTrendText(lastWeekHours, previousWeekHours);
        if (lastWeekHours < 7) {
            performanceInsight = { icon: 'fa-battery-quarter', color: '#ef4444', title: `Low Volume: ${lastWeekHours.toFixed(1)} hours`, text: `This is less than 1 hour/day on average. ${trendText}` };
        } else if (lastWeekHours < 14) {
            performanceInsight = { icon: 'fa-battery-half', color: '#f59e0b', title: `Moderate Volume: ${lastWeekHours.toFixed(1)} hours`, text: `A good start, but aim for 2+ hours/day. ${trendText}` };
        } else {
            performanceInsight = { icon: 'fa-battery-full', color: '#4ade80', title: `Strong Volume: ${lastWeekHours.toFixed(1)} hours`, text: `Excellent work, you're putting in the time. ${trendText}` };
        }
        insights.push(performanceInsight);
        
        let topSubjectInsight;
        const thisWeekSubjectHours = calculateSubjectHours(lastWeekLogs);
        const sortedSubjects = Object.entries(thisWeekSubjectHours).sort((a,b) => b[1] - a[1]);
        if (sortedSubjects.length > 0 && sortedSubjects[0][1] > 0) {
            const [topSubject, topHours] = sortedSubjects[0];
            if (topHours > 10) {
                 topSubjectInsight = { icon: 'fa-trophy', color: '#4ade80', title: `Dominant Focus: ${topSubject}`, text: `You dedicated over ${topHours.toFixed(0)} hours here, making it your clear priority.` };
            } else {
                 topSubjectInsight = { icon: 'fa-star', color: '#3b82f6', title: `Highest Practice: ${topSubject}`, text: `This subject received the most attention with ${topHours.toFixed(1)} hours.` };
            }
        } else {
            topSubjectInsight = { icon: 'fa-question-circle', color: '#8b949e', title: 'No Top Subject Yet', text: 'Log some practice sessions to find your strongest area this week.' };
        }
        insights.push(topSubjectInsight);
        
        let focusInsight;
        const prevWeekSubjectHours = calculateSubjectHours(previousWeekLogs);
        let neglectedSubject = null;
        for (const subject in prevWeekSubjectHours) {
            if (prevWeekSubjectHours[subject] > 0.5 && thisWeekSubjectHours[subject] === 0) {
                neglectedSubject = subject;
                break;
            }
        }
        if (neglectedSubject) {
            focusInsight = { icon: 'fa-magnifying-glass', color: '#f59e0b', title: `Focus On: ${neglectedSubject}`, text: `This subject was practiced last week but got no attention this week. Revisit it!` };
        } else if (sortedSubjects.length > 0 && sortedSubjects[sortedSubjects.length-1][1] > 0) {
            const [leastPracticed] = sortedSubjects[sortedSubjects.length-1];
            focusInsight = { icon: 'fa-bullseye', color: '#3b82f6', title: `Improve: ${leastPracticed}`, text: 'This subject received the least amount of practice time this week.' };
        } else {
            focusInsight = { icon: 'fa-book-open', color: '#8b949e', title: 'Start Your Week', text: 'Begin studying to identify areas for improvement and track your progress.' };
        }
        insights.push(focusInsight);
        return insights;
    }

    function displayActionableInsights(insights) {
        const container = document.getElementById('actionable-insights-container');
        if (!container) return;
        if (!insights || insights.length === 0) {
            container.innerHTML = `<div class="actionable-insight-item"><i class="fas fa-spinner fa-spin"></i><div class="insight-content"><h5>Analyzing Data...</h5><p>Checking your recent performance for insights.</p></div></div>`;
            return;
        }
        container.innerHTML = insights.map(insight => `<div class="actionable-insight-item"><i class="fas ${insight.icon}" style="color: ${insight.color};"></i><div class="insight-content"><h5>${insight.title}</h5><p>${insight.text}</p></div></div>`).join('');
    }

    function displayWeeklyReport(insights) {
        const container = document.getElementById('weekly-report-container');
        if (!container) return;
        if (!insights || insights.length === 0) {
            container.innerHTML = `<div class="weekly-report-item"><i class="fas fa-spinner fa-spin"></i><div class="report-content"><h5>Compiling Weekly Data...</h5><p>Comparing this week to the last.</p></div></div>`;
            return;
        }
        container.innerHTML = insights.map(insight => `<div class="weekly-report-item"><i class="fas ${insight.icon}" style="color: ${insight.color};"></i><div class="report-content"><h5>${insight.title}</h5><p>${insight.text}</p></div></div>`).join('');
    }

    function calculateDisciplineStreak(dailyLogs) {
        if (!dailyLogs || dailyLogs.length === 0) return 0;
        const sortedLogs = [...dailyLogs].sort((a, b) => new Date(b.Date) - new Date(a.Date));
        let streak = 0;
        let currentDate = new Date();
        currentDate.setHours(0, 0, 0, 0);
        let logIndex = 0;
        while (logIndex < sortedLogs.length) {
            const log = sortedLogs[logIndex];
            const logDate = new Date(log.Date);
            logDate.setHours(0, 0, 0, 0);

            if (logDate.getTime() > currentDate.getTime()) {
                logIndex++;
                continue;
            }
            if (logDate.getTime() === currentDate.getTime()) {
                if (log.discipline) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                    logIndex++;
                } else {
                    break; 
                }
            } else {
                break;
            }
        }
        return streak;
    }
        
    function renderDashboardCharts() {
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
        const primaryGlow = getComputedStyle(document.documentElement).getPropertyValue('--primary-glow').trim();
        const data = window.dashboardData || {};
        const sparklineOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: false } }, scales: { x: { display: false }, y: { display: false } } };
        
        const examScores = data.allExams?.filter(e => e.Status === 'Completed' && e.Score && e.TotalMarks).sort((a,b) => new Date(a.ExamDate) - new Date(b.ExamDate)).map(e => (Number(e.Score) / Number(e.TotalMarks) * 100)) || [];
        renderChart('sparkline-score', 'line', { labels: examScores.map((_, i) => i + 1), datasets: [{ data: examScores.length > 0 ? examScores : [0,0,0,0,0,0,0], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', fill: true, tension: 0.4, pointRadius: 0 }] }, sparklineOptions);

        const topicStatusCounts = { 'Completed': 0, 'In Progress': 0, 'Needs Review': 0, 'Not Started': 0 };
        data.allTopics?.forEach(t => { const status = t.Status || 'Not Started'; if (topicStatusCounts.hasOwnProperty(status)) topicStatusCounts[status]++; });
        // AFTER
renderChart('syllabus-pie-chart', 'doughnut', { labels: Object.keys(topicStatusCounts), datasets: [{ data: Object.values(topicStatusCounts), backgroundColor: [ primaryColor, '#3b82f6', '#f59e0b', '#6b7280' ], borderWidth: 0 }] }, { cutout: '70%', plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } });

        const bestSubjectName = data.bestSubject || 'N/A';
        const bestSubjectScores = getScoresForSubject(bestSubjectName);
        const bestSubjectColor = subjectColors[bestSubjectName.split(" ")[0]] || subjectColors["N/A"];
        renderChart('sparkline-best-subject', 'line', { labels: bestSubjectScores.map((_,i)=>i+1), datasets: [{ data: bestSubjectScores, borderColor: bestSubjectColor, backgroundColor: `${bestSubjectColor}4D`, fill: true, tension: 0.4, pointRadius: 0 }] }, sparklineOptions);

        const disciplineSparklineData = [];
        const today = new Date();
        for (let i = 6; i >= 0; i--) { let d = new Date(today); d.setDate(d.getDate() - i); const dateStr = d.toLocaleDateString('en-CA'); const log = allDailyLogs.find(l => new Date(l.Date).toLocaleDateString('en-CA') === dateStr); disciplineSparklineData.push(log && log.discipline ? 1 : 0); }
        renderChart('sparkline-streak', 'line', { labels: [1, 2, 3, 4, 5, 6, 7], datasets: [{ data: disciplineSparklineData, borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.3)', fill: true, tension: 0.4, pointRadius: 0, stepped: true }] }, sparklineOptions);
        
        // AFTER
renderChart('efficiency-gauge', 'doughnut', { labels: ['Efficiency', 'Remaining'], datasets: [{ data: [data.efficiencyToday || 0, 100 - (data.efficiencyToday || 0)], backgroundColor: [ '#a78bfa', 'rgba(167, 139, 250, 0.2)' ], borderWidth: 0 }] }, { cutout: '75%', circumference: 180, rotation: 270, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } });
        
        const productiveHoursLast7Days = [], datesLast7Days = [];
        for (let i = 6; i >= 0; i--) { let d = new Date(); d.setDate(d.getDate() - i); const dateStr = d.toLocaleDateString('en-CA'); datesLast7Days.push(d.toLocaleDateString('en-US', { weekday: 'short' })); const dailyMetrics = calculateDailyMetricsForChart(dateStr); productiveHoursLast7Days.push(dailyMetrics.productive); }
        renderChart('productive-time-chart', 'bar', { labels: datesLast7Days, datasets: [{ label: 'Hours', data: productiveHoursLast7Days, backgroundColor: primaryColor, borderRadius: 5 }] }, { scales: { y: { beginAtZero: true, max: 10, grid: { display: false }, ticks: { display: false } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } });
        
        // AFTER
renderChart('time-balance-chart', 'pie', { labels: ['Productive', 'Wasted'], datasets: [{ data: [data.productiveHoursToday || 0, data.wastedHoursToday || 0], backgroundColor: [ primaryColor, '#f87171' ], borderWidth: 0 }] }, { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } });
        
        const screenTimeLast7Days = [];
        for (let i = 6; i >= 0; i--) { let d = new Date(); d.setDate(d.getDate() - i); const dateStr = d.toLocaleDateString('en-CA'); const dailyLog = allDailyLogs.find(log => new Date(log.Date).toLocaleDateString('en-CA') === dateStr); screenTimeLast7Days.push(dailyLog ? (Number(dailyLog.screenTime) || 0) : 0); }
        renderChart('screen-time-chart', 'line', { labels: datesLast7Days, datasets: [{ label: 'Hours', data: screenTimeLast7Days, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.2)', fill: true, tension: 0.4, pointRadius: 0 }] }, { scales: { y: { beginAtZero: true, max: 8, grid: { display: false }, ticks: { display: false } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } });
        
        const practiceBySubject = {};
        data.allPracticeLogs?.forEach(log => {
            const subjectKey = log.Subject || 'Uncategorized';
            if (!practiceBySubject[subjectKey]) { practiceBySubject[subjectKey] = { mcq: 0, saq: 0 }; }
            practiceBySubject[subjectKey].mcq += Number(log.mcqCount) || 0;
            practiceBySubject[subjectKey].saq += Number(log.saqCount) || 0;
        });
        const practiceLabels = Object.keys(practiceBySubject).filter(key => key && key !== 'Subject' && key !== 'undefined' && key !== 'Uncategorized');
        renderChart('practice-summary-chart', 'bar', { labels: practiceLabels, datasets: [ { label: 'MCQs', data: practiceLabels.map(s => practiceBySubject[s].mcq), backgroundColor: '#3b82f6', borderRadius: 5 }, { label: 'SAQs', data: practiceLabels.map(s => practiceBySubject[s].saq), backgroundColor: '#60a5fa', borderRadius: 5 } ] }, { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#8b949e' }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#8b949e' }, grid: { display: false } } }, plugins: { legend: { labels: { color: '#e0e0e0' } } } });

        const forecast = calculatePerformanceForecast() || { prediction: 0, historicalData: [] };
        const forecastScoreEl = document.querySelector('.forecast-score');
        if (forecastScoreEl) forecastScoreEl.innerHTML = `${isFinite(forecast.prediction) ? forecast.prediction : 0}<small>%</small>`;
        const histAll = Array.isArray(forecast.historicalData) ? forecast.historicalData : [];
        const forecastHistoricalData = histAll.slice(-9);
        const forecastLabels = forecastHistoricalData.map((_, i) => `Exam ${i + 1}`);
        const padLen = Math.max(0, forecastHistoricalData.length - 1);
        const predictionData = new Array(padLen).fill(null);
        if (forecastHistoricalData.length > 0) {
            predictionData.push(forecastHistoricalData[forecastHistoricalData.length - 1]);
        }
        predictionData.push(isFinite(forecast.prediction) ? forecast.prediction : 0);
        renderChart('performance-forecast-chart', 'line', { labels: [...forecastLabels, 'Forecast'], datasets: [
            { label: 'Past Scores', data: forecastHistoricalData, borderColor: primaryColor, backgroundColor: primaryGlow, fill: false, tension: 0.4 },
            { label: 'Forecast', data: predictionData, borderColor: primaryColor, borderDash: [5, 5], fill: false, tension: 0.4 }
        ] }, { scales: { y: { beginAtZero: false, min: 40, max: 100, grid: { display: false }, ticks: { display: false } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } });
    }

    function calculateDailyMetricsForChart(dateStr) {
        const dailyLog = allDailyLogs.find(log => new Date(log.Date).toLocaleDateString('en-CA') === dateStr);
        const practiceLogsForDate = allPracticeLogs.filter(log => new Date(log.Date).toLocaleDateString('en-CA') === dateStr);
        const totalSleep = dailyLog ? (Number(dailyLog.sleepHours) || 0) : 0;
        const productiveMinutes = practiceLogsForDate.reduce((sum, log) => sum + (Number(log.timeSpent) || 0) + ((Number(log.classTime) || 0) * 60), 0);
        const productiveHours = productiveMinutes / 60;
        const awakeHours = 24 - totalSleep;
        const wastedHours = Math.max(0, awakeHours - productiveHours);
        const efficiency = awakeHours > 0 ? (productiveHours / awakeHours) * 100 : 0;
        return { efficiency, productive: productiveHours, wasted: wastedHours, sleep: totalSleep };
    }


// ===================================================================
//                         LOG FORMS LOGIC
// ===================================================================
    function initLogForms() { const overlay = document.getElementById('formPopupOverlay'); document.getElementById('closeFormPopupBtn')?.addEventListener('click', () => overlay.classList.remove('visible')); overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('visible'); }); const tabDaily = document.getElementById('tabDailyLog'), tabPractice = document.getElementById('tabPractice'); const dailyForm = document.getElementById('dailyLogForm'), practiceForm = document.getElementById('practiceLogForm'); tabDaily.addEventListener('click', () => { tabDaily.classList.add('active'); tabPractice.classList.remove('active'); dailyForm.classList.add('active'); practiceForm.classList.remove('active'); loadTodaysDailyLog(); }); tabPractice.addEventListener('click', () => { tabPractice.classList.add('active'); tabDaily.classList.remove('active'); practiceForm.classList.add('active'); dailyForm.classList.remove('active'); }); setupMultiStepForm('dailyLogForm'); setupMultiStepForm('practiceLogForm'); document.getElementById('dailyLogForm').addEventListener('submit', handleDailyLogSubmit); document.getElementById('practiceLogForm').addEventListener('submit', handlePracticeLogSubmit); document.getElementById('prayerSelector').addEventListener('click', e => { if (e.target.classList.contains('prayer-circle')) e.target.classList.toggle('active'); }); document.getElementById('arenaSelectionDisplay').addEventListener('click', () => document.getElementById('arenaModalOverlay').classList.add('visible')); initTimeSuggestionChips(); }
    function loadTodaysDailyLog() { const form = document.getElementById('dailyLogForm'); form.reset(); form.querySelectorAll('.prayer-circle.active').forEach(c => c.classList.remove('active')); const todayStr = new Date().toLocaleDateString('en-CA'); const log = allDailyLogs.find(l => new Date(l.Date).toLocaleDateString('en-CA') === todayStr); if (log) { document.getElementById('dailySleep').value = log.sleepHours || ''; document.getElementById('dailyScreenTime').value = log.screenTime || ''; document.getElementById('dailyNotes').value = log.notes || ''; document.getElementById('disciplineCheck').checked = log.discipline; const circles = form.querySelectorAll('.prayer-circle'); for(let i=0; i < (parseInt(log.prayers) || 0); i++) if(circles[i]) circles[i].classList.add('active'); } }
    function initTimeSuggestionChips() { document.querySelectorAll('.time-suggestion-chips').forEach(container => container.addEventListener('click', e => { if (e.target.matches('.time-suggestion-chip')) { e.preventDefault(); const btn = e.target, hrIn = document.getElementById(container.dataset.targetHr), minIn = document.getElementById(container.dataset.targetMin); let totalMins = (parseInt(hrIn.value) || 0) * 60 + (parseInt(minIn.value) || 0); totalMins += (parseInt(btn.dataset.hr) || 0) * 60 + (parseInt(btn.dataset.min) || 0); hrIn.value = Math.floor(totalMins / 60); minIn.value = totalMins % 60; } })); }
    function setupMultiStepForm(formId) {
        const form = document.getElementById(formId);
        const steps = form.querySelectorAll('.form-step');
        let currentStep = 0;

        const updateUI = () => {
            steps.forEach((step, i) => {
                step.style.display = i === currentStep ? 'block' : 'none';
                const bar = step.querySelector('.progress-bar-fill');
                if (bar) bar.style.width = `${((currentStep + 1) / steps.length) * 100}%`;
            });
        };

        // Handle click on Next/Back buttons
        form.addEventListener('click', e => {
            if (e.target.classList.contains('next-btn')) {
                if (currentStep < steps.length - 1) currentStep++;
                updateUI();
            } else if (e.target.classList.contains('prev-btn')) {
                if (currentStep > 0) currentStep--;
                updateUI();
            }
        });

        // Make Enter key behave like Next until last step, then submit
        form.addEventListener('keydown', e => {
            if (e.key !== 'Enter') return;
            const isLastStep = currentStep === steps.length - 1;
            const currentStepEl = steps[currentStep];
            const nextBtn = currentStepEl.querySelector('.next-btn');

            if (!isLastStep) {
                // Prevent accidental submit on intermediate steps
                e.preventDefault();
                // Only advance if Next is available and enabled
                if (nextBtn && !nextBtn.disabled) {
                    currentStep++;
                    updateUI();
                }
            } else {
                // On last step, allow normal submit via Enter
                // Do not preventDefault here
            }
        });

        updateUI();
    }
    
    async function handleDailyLogSubmit(e) { 
        e.preventDefault(); 
        const form = e.target, btn = form.querySelector('.submit-btn'); 
        btn.disabled = true; 
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`; 
        try { 
            const { data: { session } } = await supabaseClient.auth.getSession();
            const user_id = session?.user?.id;
            if (!user_id) throw new Error('No active session');
            const payload = {
                user_id,
                Date: new Date().toLocaleDateString('en-CA'),
                sleepHours: form.querySelector('#dailySleep').value || 0,
                screenTime: form.querySelector('#dailyScreenTime').value || 0,
                prayers: form.querySelectorAll('.prayer-circle.active').length,
                discipline: form.querySelector('#disciplineCheck').checked,
                notes: form.querySelector('#dailyNotes').value
            };
            // Use upsert to add or update the log based on the unique 'Date' field
            await handlesupabaseClientResponse(supabaseClient.from('DailyLogs').upsert(payload, { onConflict: 'user_id,Date' }));
            showSuccessAnimation('Daily Log Saved!'); 
            form.reset(); 
            form.querySelectorAll('.prayer-circle.active').forEach(c => c.classList.remove('active')); 
            setupMultiStepForm('dailyLogForm'); 
            fetchAndPopulateDashboard(); 
        } catch (err) { 
            alert('Failed to save log: ' + err.message); 
        } finally { 
            btn.disabled = false; 
            btn.innerHTML = 'Submit'; 
            document.getElementById('formPopupOverlay').classList.remove('visible');
        } 
    }

    async function handlePracticeLogSubmit(e) { 
        e.preventDefault(); 
        const form = e.target, btn = form.querySelector('.submit-btn'); 
        btn.disabled = true; 
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`; 
        const subject = form.querySelector('#practiceSubject').value;
        const chapter = form.querySelector('#practiceChapter').value;
        const date = new Date().toLocaleDateString('en-CA');
        const lecHrs = parseFloat(form.querySelector('#lectureHours').value) || 0;
        const lecMins = parseFloat(form.querySelector('#lectureMinutes').value) || 0;
        const totalLecHrs = lecHrs + (lecMins / 60);
        const pracHrs = parseInt(form.querySelector('#practiceHours').value) || 0;
        const pracMins = parseInt(form.querySelector('#practiceMinutes').value) || 0;
        const totalPracMins = (pracHrs * 60) + pracMins;
        const mcq = form.querySelector('#practiceMcq').value || 0;
        const saq = form.querySelector('#practiceSaq').value || 0;
        const isUnique = form.querySelector('#practiceUnique').checked;

        const tasksToInsert = [];
        const { data: { session } } = await supabaseClient.auth.getSession();
        const user_id = session?.user?.id;
        if (!user_id) { alert('No active session. Please log in again.'); btn.disabled = false; btn.innerHTML = 'Submit'; return; }
        if (totalLecHrs > 0) {
            tasksToInsert.push({ user_id, Date: date, Subject: subject, Chapter: chapter, mcqCount: 0, saqCount: 0, isUnique: false, classTime: totalLecHrs, classType: form.querySelector('#lectureType').value, timeSpent: 0 });
        }
        if (mcq > 0 || saq > 0 || totalPracMins > 0) {
            tasksToInsert.push({ user_id, Date: date, Subject: subject, Chapter: chapter, mcqCount: mcq, saqCount: saq, isUnique: isUnique, classTime: 0, classType: '', timeSpent: totalPracMins });
        }

        if (tasksToInsert.length === 0) { 
            alert("Nothing to log."); 
            btn.disabled = false; 
            btn.innerHTML = 'Submit'; 
            return; 
        } 
        
        try { 
            await handlesupabaseClientResponse(supabaseClient.from('PracticeLogs').insert(tasksToInsert));
            showSuccessAnimation('Practice Log Saved!'); 
            form.reset(); 
            form.querySelector('#arenaSelectionDisplay').innerHTML = `<span class="placeholder">Click to select subject & chapter</span><i class="fas fa-chevron-right"></i>`; 
            form.querySelector('.nav-btn.next-btn').disabled = true; 
            setupMultiStepForm('practiceLogForm'); 
            fetchAndPopulateDashboard(); 
        } catch (err) { 
            alert('Failed to save log: ' + err.message); 
        } finally { 
            btn.disabled = false; 
            btn.innerHTML = 'Submit'; 
            document.getElementById('formPopupOverlay').classList.remove('visible'); 
        } 
    }

    function initArenaModal() { const overlay = document.getElementById('arenaModalOverlay'), container = document.getElementById('arenaModalContainer'), subjectList = document.getElementById('arenaSubjectList'), chapterList = document.getElementById('arenaChapterList'); document.getElementById('closeArenaModalBtn').addEventListener('click', () => overlay.classList.remove('visible')); document.getElementById('backToSubjectsBtn').addEventListener('click', () => container.classList.remove('chapters-visible')); subjectList.innerHTML = Object.keys(chapterData).map(s => `<li class="arena-list-item" data-subject="${s}">${s} <i class="fas fa-chevron-right"></i></li>`).join(''); subjectList.addEventListener('click', (e) => { const item = e.target.closest('.arena-list-item'); if (!item) return; const subject = item.dataset.subject; document.getElementById('practiceSubject').value = subject; document.getElementById('chaptersHeaderTitle').textContent = subject; chapterList.innerHTML = chapterData[subject].map(ch => `<li class="arena-list-item" data-chapter="${ch}">${ch}</li>`).join(''); container.classList.add('chapters-visible'); }); chapterList.addEventListener('click', (e) => { const item = e.target.closest('.arena-list-item'); if (!item) return; const chapter = item.dataset.chapter; const subject = document.getElementById('practiceSubject').value; document.getElementById('practiceChapter').value = chapter; document.getElementById('arenaSelectionDisplay').innerHTML = `<div><span class="subject-display">${subject}</span> > <span class="chapter-display">${chapter}</span></div><i class="fas fa-edit"></i>`; document.querySelector('#practiceLogForm .nav-btn.next-btn').disabled = false; overlay.classList.remove('visible'); setTimeout(() => container.classList.remove('chapters-visible'), 400); }); }
    
    // ===================================================================
    //                      REPORT ENGINE LOGIC
    // ===================================================================
    const subjectIcons = { "Physics": "fa-atom", "Chemistry": "fa-flask-vial", "Math": "fa-calculator", "Biology": "fa-dna" };
    let reportSelectedSubject = null;
    let reportSelectedChapters = [];

    async function fetchReportPrerequisites() {
        // This ensures the data needed for the report is available if the user navigates directly here.
        if (allTopics.length === 0 || allExams.length === 0 || allPracticeLogs.length === 0) {
            startStretchLoader('new-report-loader', 'Loading Report Data...');
            try {
                const [topics, exams, practiceLogs] = await Promise.all([
                    handlesupabaseClientResponse(supabaseClient.from('Topics').select('*')),
                    handlesupabaseClientResponse(supabaseClient.from('Exams').select('*')),
                    handlesupabaseClientResponse(supabaseClient.from('PracticeLogs').select('*'))
                ]);
                allTopics = topics || [];
                allExams = exams || [];
                allPracticeLogs = practiceLogs || [];
            } catch (error) {
                console.error("Failed to load report prerequisites", error);
                showReportMessage("Could not load necessary data. Please try again.", "error");
            } finally {
                document.getElementById('new-report-loader').style.display = 'none';
            }
        }
    }

    function initReportWizard() {
        document.getElementById('report-config-wizard').style.display = 'block';
        document.getElementById('report-results-view').style.display = 'none';
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
        document.getElementById('report-step-subject').classList.add('active');
        reportSelectedSubject = null;
        reportSelectedChapters = [];
        document.getElementById('btn-generate-new-report').disabled = true;

        const subjectContainer = document.getElementById('subject-selection-container');
        subjectContainer.innerHTML = Object.keys(chapterData).map(subject => `
            <div class="subject-card ${subject.toLowerCase()}" data-subject="${subject}">
                <div class="icon-wrapper">
                    <i class="fas ${subjectIcons[subject] || 'fa-book'}"></i>
                </div>
                <span>${subject}</span>
            </div>
        `).join('');

        subjectContainer.querySelectorAll('.subject-card').forEach(card => card.addEventListener('click', handleSubjectSelection));
        document.getElementById('btn-reset-report-wizard').addEventListener('click', initReportWizard);
        document.getElementById('btn-back-to-wizard').addEventListener('click', initReportWizard);
        document.getElementById('btn-generate-new-report').addEventListener('click', generateReport);
    }

    function handleSubjectSelection(e) {
        const selectedCard = e.currentTarget;
        reportSelectedSubject = selectedCard.dataset.subject;
        document.querySelectorAll('#subject-selection-container .subject-card').forEach(c => c.classList.remove('active'));
        selectedCard.classList.add('active');
        populateChapterChips(reportSelectedSubject);
        document.getElementById('report-step-subject').classList.remove('active');
        document.getElementById('report-step-chapter').classList.add('active');
        document.getElementById('report-step-actions').classList.add('active');
        document.getElementById('btn-generate-new-report').disabled = true;
    }

    function populateChapterChips(subject) {
        const chapterContainer = document.getElementById('chapter-selection-container');
        chapterContainer.innerHTML = (chapterData[subject] || []).map(chapter => `<div class="chapter-chip" data-chapter="${chapter}">${chapter}</div>`).join('');
        chapterContainer.querySelectorAll('.chapter-chip').forEach(chip => chip.addEventListener('click', handleChapterSelection));
        reportSelectedChapters = [];
    }

    function handleChapterSelection(e) {
        const selectedChip = e.currentTarget;
        const chapter = selectedChip.dataset.chapter;
        selectedChip.classList.toggle('selected');
        const chapterIndex = reportSelectedChapters.indexOf(chapter);
        if (chapterIndex > -1) {
            reportSelectedChapters.splice(chapterIndex, 1);
        } else {
            reportSelectedChapters.push(chapter);
        }
        document.getElementById('btn-generate-new-report').disabled = reportSelectedChapters.length === 0;
    }
    
    /**
     * Replicates the backend Apps Script logic for generating reports, but on the client-side.
     * @param {string[]} chapters - Array of chapter names to generate reports for.
     * @param {object[]} topics - The `allTopics` data array.
     * @param {object[]} exams - The `allExams` data array.
     * @param {object[]} practiceLogs - The `allPracticeLogs` data array.
     * @returns {object[]} An array of report objects for the selected chapters.
     */
    function generateAggregatedReport_JS(chapters, topics, exams, practiceLogs) {
        return chapters.map(chapterName => {
            const topicInfo = topics.find(t => t.Chapter === chapterName);
            const practiceForChapter = practiceLogs.filter(p => p.Chapter === chapterName);

            const classTimeMins = practiceForChapter
                .filter(p => (p.classTime || 0) > 0)
                .reduce((sum, p) => sum + ((p.classTime || 0) * 60), 0);

            const practiceTimeMins = practiceForChapter
                .filter(p => (p.timeSpent || 0) > 0 || (p.mcqCount || 0) > 0 || (p.saqCount || 0) > 0)
                .reduce((sum, p) => sum + (p.timeSpent || 0), 0);

            const chapterInfo = {
                Chapter: chapterName,
                Subject: (topicInfo && topicInfo.Subject) ? topicInfo.Subject : (reportSelectedSubject || "N/A"),
                TimeSpent: classTimeMins + practiceTimeMins,
                ClassTime: classTimeMins,
                PracticeTime: practiceTimeMins,
                TotalMCQs: practiceForChapter.reduce((sum, p) => sum + (p.mcqCount || 0), 0),
                TotalSAQs: practiceForChapter.reduce((sum, p) => sum + (p.saqCount || 0), 0),
                Confidence: "Not Tracked", 
                LastReviewed: "N/A",
                ExamAppearances: 0,
                MistakeRate: 0
            };

            if (topicInfo) {
                if (topicInfo.Status === 'Completed') chapterInfo.Confidence = 'Very Confident';
                else if (topicInfo.Status === 'Needs Review') chapterInfo.Confidence = 'Somewhat Confident';
                else if (topicInfo.Status === 'In Progress') chapterInfo.Confidence = 'Confident';
                else chapterInfo.Confidence = 'Not Confident';
            }

            const lastPractice = practiceForChapter.sort((a,b) => new Date(b.Date) - new Date(a.Date))[0];
            if(lastPractice) chapterInfo.LastReviewed = new Date(lastPractice.Date).toLocaleDateString();

            let examAppearances = 0, totalScoreSum = 0, totalMarksSum = 0;
            exams.forEach(exam => {
                if (exam.Status === 'Completed' && (exam.ChaptersCovered || '').includes(chapterName) && exam.Score != null && exam.TotalMarks > 0) {
                    examAppearances++;
                    totalScoreSum += parseFloat(exam.Score);
                    totalMarksSum += parseFloat(exam.TotalMarks);
                }
            });

            chapterInfo.ExamAppearances = examAppearances;
            if (examAppearances > 0) {
                chapterInfo.MistakeRate = (1 - (totalScoreSum / totalMarksSum)) * 100;
            }
            return chapterInfo;
        });
    }


    async function generateReport() {
        if (reportSelectedChapters.length === 0) return;
        document.getElementById('report-config-wizard').style.display = 'none';
        document.getElementById('report-results-view').style.display = 'block';
        const loader = document.getElementById('new-report-loader');
        const resultsContainer = document.getElementById('new-report-results-container');
        const messageArea = document.getElementById('new-report-message-area');
        resultsContainer.innerHTML = '';
        messageArea.style.display = 'none';
        
        startStretchLoader('new-report-loader', 'Analyzing Performance Data...');

        try {
            // Ensure data is loaded before proceeding
            await fetchReportPrerequisites();

            const reportData = generateAggregatedReport_JS(reportSelectedChapters, allTopics, allExams, allPracticeLogs);
            
            if (reportData.length > 0) {
                displayGeneratedReports(reportData);
            } else {
                showReportMessage('No relevant data found for the selected chapters.');
            }
        } catch (error) {
            showReportMessage(`Error: ${error.message}`, 'error');
        } finally {
            loader.style.display = 'none';
        }
    }

    function showReportMessage(message, type = 'info') {
        const messageArea = document.getElementById('new-report-message-area');
        messageArea.innerHTML = `<div class="report-placeholder" style="height: auto; padding: 2rem 0;">
            <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'}" style="opacity:1;"></i>
            <h3>${message}</h3>
        </div>`;
        messageArea.style.display = 'block';
        document.getElementById('new-report-results-container').innerHTML = '';
    }

    function displayGeneratedReports(data) {
        const resultsContainer = document.getElementById('new-report-results-container');
        resultsContainer.innerHTML = '';
        data.forEach((chapter, index) => {
            const confidenceClass = `confidence-${(chapter.Confidence || "Not-Tracked").replace(' ', '-')}`;
            
            const card = document.createElement('div');
            card.className = 'report-insight-card';
            card.style.animationDelay = `${index * 100}ms`;

            card.innerHTML = `
                <div class="ric-header">
                    <div class="ric-title">
                        <h4>${chapter.Chapter}</h4>
                        <span>${chapter.Subject}</span>
                    </div>
                    <span class="report-confidence-badge ${confidenceClass}">${chapter.Confidence}</span>
                </div>

                <div class="ric-stats-grid">
                    <div class="ric-stat-item">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="ric-stat-value">${formatHoursToHoursMinutes(chapter.TimeSpent)}</div>
                        <div class="ric-stat-label">Total Study Time</div>
                    </div>
                    <div class="ric-stat-item">
                        <i class="fas fa-bullseye"></i>
                        <div class="ric-stat-value">${chapter.ExamAppearances > 0 ? chapter.MistakeRate.toFixed(0) + '%' : 'N/A'}</div>
                        <div class="ric-stat-label">Mistake Rate</div>
                    </div>
                    <div class="ric-stat-item">
                        <i class="fas fa-file-signature"></i>
                        <div class="ric-stat-value">${chapter.ExamAppearances}</div>
                        <div class="ric-stat-label">Exams Appeared</div>
                    </div>
                    <div class="ric-stat-item">
                        <i class="fas fa-calendar-check"></i>
                        <div class="ric-stat-value">${chapter.LastReviewed}</div>
                        <div class="ric-stat-label">Last Reviewed</div>
                    </div>
                </div>

                <div class="ric-details-grid">
                    <div class="ric-detail-item">
                        <label><i class="fas fa-list-ol"></i> Total MCQs</label>
                        <span>${chapter.TotalMCQs}</span>
                    </div>
                    <div class="ric-detail-item">
                        <label><i class="fas fa-pen-alt"></i> Total SAQs</label>
                        <span>${chapter.TotalSAQs}</span>
                    </div>
                    <div class="ric-detail-item">
                        <label><i class="fas fa-chalkboard-teacher"></i> Class Time</label>
                        <span>${formatHoursToHoursMinutes(chapter.ClassTime)}</span>
                    </div>
                    <div class="ric-detail-item">
                        <label><i class="fas fa-book-reader"></i> Practice Time</label>
                        <span>${formatHoursToHoursMinutes(chapter.PracticeTime)}</span>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(card);
        });
    }


    // ===================================================================
    //                         EXAMS SECTION LOGIC
    // ===================================================================
    async function fetchExams() {
        startStretchLoader('exam-loader', 'Fetching Exams...');
        try {
            const data = await handlesupabaseClientResponse(supabaseClient.from('Exams').select('*'));
            allExams = data || [];
            populateExamList(allExams);
            populateExamMetrics(allExams);
        } catch (e) {
            console.error('Error fetching exams:', e);
            document.getElementById('examListContainer').innerHTML = `<p class="exam-list-empty-message">Could not load exams. Please try again.</p>`;
        } finally {
            document.getElementById('exam-loader').style.display = 'none';
        }
    }

    function populateExamMetrics(exams) {
        const totalExamsEl = document.getElementById('metric-total-exams');
        const avgScoreEl = document.getElementById('metric-avg-score');
        const scoreTrendEl = document.getElementById('metric-score-trend');
        const bestSubjectEl = document.getElementById('metric-best-subject');
        const bestSubjectLabelEl = document.getElementById('metric-best-subject-label');

        const completedExams = exams.filter(e => e.Status === 'Completed' && e.Score != null && e.TotalMarks != null && e.TotalMarks > 0);
        
        if (completedExams.length === 0) {
            totalExamsEl.textContent = '0';
            avgScoreEl.textContent = 'N/A';
            scoreTrendEl.textContent = 'N/A';
            bestSubjectEl.textContent = 'N/A';
            bestSubjectLabelEl.textContent = 'Best Subject';
            return;
        }

        totalExamsEl.textContent = completedExams.length;

        const totalScore = completedExams.reduce((sum, exam) => sum + (parseFloat(exam.Score) / parseFloat(exam.TotalMarks)), 0);
        const avgScore = (totalScore / completedExams.length) * 100;
        avgScoreEl.textContent = `${avgScore.toFixed(0)}%`;

        completedExams.sort((a, b) => new Date(a.ExamDate) - new Date(b.ExamDate));
        const lastFive = completedExams.slice(-5);
        if (lastFive.length > 1) {
            const firstScore = (parseFloat(lastFive[0].Score) / parseFloat(lastFive[0].TotalMarks)) * 100;
            const lastScore = (parseFloat(lastFive[lastFive.length - 1].Score) / parseFloat(lastFive[lastFive.length - 1].TotalMarks)) * 100;
            const trend = lastScore - firstScore;
            
            scoreTrendEl.textContent = `${trend >= 0 ? '+' : ''}${trend.toFixed(1)}%`;
            scoreTrendEl.className = '';
            if (trend > 1) scoreTrendEl.classList.add('trend-positive');
            else if (trend < -1) scoreTrendEl.classList.add('trend-negative');
            
        } else {
            scoreTrendEl.textContent = 'N/A';
            scoreTrendEl.className = '';
        }

        const subjectPerformance = calculateSubjectPerformance(completedExams);
        let bestSubject = { name: 'N/A', score: -1 };
        for (const subject in subjectPerformance) {
            if (subjectPerformance[subject].count > 0 && subjectPerformance[subject].avgScore > bestSubject.score) {
                bestSubject = { name: subject, score: subjectPerformance[subject].avgScore };
            }
        }
        
        bestSubjectEl.textContent = bestSubject.name;
        bestSubjectLabelEl.textContent = bestSubject.score > -1 ? `${bestSubject.score.toFixed(0)}% Avg` : 'Best Subject';
    }

    function initExamModal() { 
        const examForm = document.getElementById('examForm'); 
        examForm.innerHTML = `<h3 class="step-title"><i class="fas fa-file-alt"></i> Schedule New Exam</h3><div class="form-group"><input type="text" id="examName" class="form-input" placeholder="Exam Name (e.g., Physics Midterm)" required><i class="form-icon fas fa-signature"></i></div><div class="form-group"><input type="date" id="examDate" class="form-input" style="padding-right: 15px;" required><i class="form-icon fas fa-calendar-alt"></i></div><div class="form-group"><div id="examSyllabus" class="syllabus-selection-container generic-scrollbar"></div></div><button type="submit" class="nav-btn submit-btn" style="width: 100%;">Schedule Exam</button>`; 
        document.getElementById('addExamBtn')?.addEventListener('click', () => { 
            populateSyllabusSelector(); 
            document.getElementById('examModalOverlay').classList.add('visible'); 
        }); 
        document.getElementById('closeExamModalBtn')?.addEventListener('click', () => document.getElementById('examModalOverlay').classList.remove('visible')); 
        document.getElementById('closeExamResultModalBtn')?.addEventListener('click', () => document.getElementById('examResultModalOverlay').classList.remove('visible')); 
        examForm.addEventListener('submit', handleExamFormSubmit); 
        document.getElementById('examResultForm').addEventListener('submit', handleExamResultSubmit); 
    }

    function populateExamList(exams) { 
        const upcomingContainer = document.getElementById('upcomingExamsGrid'); 
        const pastContainer = document.getElementById('pastExamsGrid'); 
        upcomingContainer.innerHTML = ''; 
        pastContainer.innerHTML = ''; 
        const today = new Date(); 
        today.setHours(0, 0, 0, 0); 
        const upcomingExams = exams.filter(e => new Date(e.ExamDate) >= today); 
        const pastExams = exams.filter(e => new Date(e.ExamDate) < today); 
        upcomingExams.sort((a,b) => new Date(a.ExamDate) - new Date(b.ExamDate)); 
        pastExams.sort((a,b) => new Date(b.ExamDate) - new Date(a.ExamDate)); 
        
        const createCard = (exam) => { 
            const score = parseFloat(exam.Score); 
            const totalMarks = parseFloat(exam.TotalMarks); 
            const scorePercentage = (totalMarks > 0) ? (score / totalMarks * 100).toFixed(1) : 0; 
            const card = document.createElement('div'); 
            card.className = 'exam-card'; 
            card.innerHTML = `<div class="exam-card-header"><div class="exam-card-title"><h4>${exam.ExamName}</h4><p>${(exam.ChaptersCovered || '').length > 80 ? exam.ChaptersCovered.substring(0,80) + '...' : exam.ChaptersCovered}</p></div><span class="exam-card-date">${new Date(exam.ExamDate).toLocaleDateString()}</span></div><div class="exam-card-body">${exam.Status === 'Completed' ? `<div class="exam-score">${score} <span class="total-marks">/ ${totalMarks} (${scorePercentage}%)</span></div>` : `<span>${new Date(exam.ExamDate) < new Date() ? 'Result Pending' : 'Upcoming'}</span>`} <button class="btn-add-result" data-exam-id="${exam.ExamID}" data-exam-name="${exam.ExamName}">${exam.Status === 'Completed' ? 'Update' : 'Add'} Result</button></div>`; 
            return card; 
        }; 
        
        if (upcomingExams.length > 0) { 
            upcomingExams.forEach(exam => upcomingContainer.appendChild(createCard(exam))); 
        } else { 
            upcomingContainer.innerHTML = `<p class="exam-list-empty-message">No upcoming exams scheduled.</p>`; 
        } 
        if (pastExams.length > 0) { 
            pastExams.forEach(exam => pastContainer.appendChild(createCard(exam))); 
        } else { 
            pastContainer.innerHTML = `<p class="exam-list-empty-message">No past exam data yet.</p>`; 
        } 
        document.querySelectorAll('.btn-add-result').forEach(btn => btn.addEventListener('click', openExamResultModal)); 
    }

    function openExamResultModal(e) { 
        e.stopPropagation(); 
        const examId = e.target.dataset.examId; 
        const examName = e.target.dataset.examName; 
        document.getElementById('resultExamId').value = examId; 
        document.getElementById('examResultModalTitle').textContent = `Result for ${examName}`; 
        document.getElementById('examResultModalOverlay').classList.add('visible'); 
    }

    function populateSyllabusSelector() { 
        const container = document.getElementById('examSyllabus'); 
        container.innerHTML = Object.entries(chapterData).map(([subject, chapters]) => `<div class="syllabus-subject-group"><label class="syllabus-subject-header"><input type="checkbox" class="form-checkbox" data-subject-checkbox="${subject}"> ${subject}</label><div class="syllabus-chapter-list">${chapters.map(chapter => `<label class="syllabus-chapter-item"><input type="checkbox" class="form-checkbox" name="examChapters" value="${chapter}" data-subject="${subject}"> ${chapter}</label>`).join('')}</div></div>`).join(''); 
        container.querySelectorAll('[data-subject-checkbox]').forEach(cb => { 
            cb.addEventListener('change', (e) => { 
                const subject = e.target.dataset.subjectCheckbox; 
                container.querySelectorAll(`input[data-subject="${subject}"]`).forEach(chapterCb => { 
                    chapterCb.checked = e.target.checked; 
                }); 
            }); 
        }); 
    }

    async function handleExamFormSubmit(e) { 
        e.preventDefault(); 
        const btn = e.target.querySelector('.submit-btn'); 
        btn.disabled = true; 
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Scheduling...`; 
        const examName = document.getElementById('examName').value; 
        const examDate = document.getElementById('examDate').value; 
        const examChapters = [...document.querySelectorAll('#examSyllabus input[name="examChapters"]:checked')].map(cb => cb.value).join(', '); 
        if (!examChapters) { 
            alert('Please select at least one chapter.'); 
            btn.disabled = false; 
            btn.innerHTML = 'Schedule Exam'; 
            return; 
        } 
        try { 
            const { data: { session } } = await supabaseClient.auth.getSession();
            const user_id = session?.user?.id;
            if (!user_id) throw new Error('No active session');
            const newExam = {
                user_id,
                ExamName: examName,
                ExamDate: examDate,
                ChaptersCovered: examChapters,
                Status: 'Upcoming'
            };
            await handlesupabaseClientResponse(supabaseClient.from('Exams').insert(newExam));
            showSuccessAnimation('Exam Scheduled!'); 
            document.getElementById('examModalOverlay').classList.remove('visible'); 
            await fetchExams(); 
            dataCache.analytics = false; 
        } catch (err) { 
            alert(`Failed to add exam: ${err.message}`); 
        } finally { 
            btn.disabled = false; 
            btn.innerHTML = 'Schedule Exam'; 
        } 
    }

    async function handleExamResultSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`;
        try {
            const examId = document.getElementById('resultExamId').value;
            const score = document.getElementById('marksObtained').value;
            const totalMarks = document.getElementById('totalMarks').value;
            
            const updatedData = {
                Score: score,
                TotalMarks: totalMarks,
                Status: 'Completed'
            };
            await handlesupabaseClientResponse(supabaseClient.from('Exams').update(updatedData).eq('ExamID', examId));

            showSuccessAnimation('Result Saved!');
            await fetchExams();
            document.getElementById('examResultModalOverlay').classList.remove('visible');
            dataCache.analytics = false;
        } catch (err) {
            alert(`Failed to save result: ${err.message}`);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Save Result';
        }
    }


    // ===================================================================
    //                      TOPIC TRACKER LOGIC
    // ===================================================================
    async function fetchTopics() {
        startStretchLoader('topic-loader', 'Organizing Topics...');
        try {
            const data = await handlesupabaseClientResponse(supabaseClient.from('Topics').select('*'));
            allTopics = data || [];
            populateTracker(allTopics);
            populateSubjectFilters();
        } catch (e) {
            console.error('Error fetching topics:', e);
            document.getElementById('kanbanBoard').innerHTML = `<p class="exam-list-empty-message">Could not load topics. Please try again.</p>`;
        } finally {
            document.getElementById('topic-loader').style.display = 'none';
        }
    }

    function populateTracker(topics) { 
        document.querySelectorAll('.kanban-cards').forEach(col => col.innerHTML = ''); 
        topics.forEach(topic => { 
            const status = topic.Status || 'Not Started'; 
            const column = document.getElementById(`cards-${status.replace(/ /g, '-')}`); 
            if (column) column.appendChild(createTopicCard(topic)); 
        }); 
        updateColumnCounts(); 
    }

    function createTopicCard(topic) { 
        const card = document.createElement('div'); 
        card.className = 'topic-card'; 
        card.dataset.id = topic.TopicID; 
        card.draggable = true; 
        card.innerHTML = `<div class="topic-card-header"><span class="topic-card-title">${topic.TopicName}</span><div class="topic-card-actions"><button class="btn-edit" title="Edit Topic"><i class="fas fa-pencil-alt"></i></button><button class="btn-delete" title="Delete Topic"><i class="fas fa-trash-alt"></i></button></div></div><div class="topic-card-meta">${topic.Subject} > ${topic.Chapter}</div><div class="topic-card-tags"><span class="topic-tag tag-difficulty-${topic.Difficulty}">${topic.Difficulty}</span><span class="topic-tag tag-importance-${topic.Importance}">${topic.Importance} Imp.</span></div>`; 
        card.querySelector('.btn-edit').addEventListener('click', (e) => { e.stopPropagation(); openTopicModal(topic); }); 
        card.querySelector('.btn-delete').addEventListener('click', (e) => { e.stopPropagation(); deleteTopicHandler(topic.TopicID); }); 
        card.addEventListener('dragstart', () => card.classList.add('dragging')); 
        card.addEventListener('dragend', () => card.classList.remove('dragging')); 
        return card; 
    }

    function updateColumnCounts() { 
        document.querySelectorAll('.kanban-column').forEach(column => { 
            column.querySelector('.topic-count').textContent = column.querySelector('.kanban-cards').children.length; 
        }); 
    }

    function populateSubjectFilters() { 
        const subjects = [...new Set(allTopics.map(t => t.Subject))].filter(Boolean).sort(); 
        const topicSubjectFilter = document.getElementById('topicSubjectFilter'); 
        topicSubjectFilter.innerHTML = '<option value="all">All Subjects</option>' + subjects.map(s => `<option value="${s}">${s}</option>`).join(''); 
        const modalSubjectSelect = document.getElementById('topicSubject'); 
        modalSubjectSelect.innerHTML = '<option disabled selected value="">Select Subject...</option>' + Object.keys(chapterData).map(s => `<option value="${s}">${s}</option>`).join(''); 
    }

    document.getElementById('topicSubjectFilter').addEventListener('change', () => { 
        const selectedSubject = document.getElementById('topicSubjectFilter').value; 
        const chapterFilter = document.getElementById('topicChapterFilter'); 
        if (selectedSubject === 'all') { 
            chapterFilter.innerHTML = '<option value="all">All Chapters</option>'; 
            chapterFilter.disabled = true; 
        } else { 
            chapterFilter.disabled = false; 
            chapterFilter.innerHTML = '<option value="all">All Chapters</option>' + (chapterData[selectedSubject] || []).map(ch => `<option value="${ch}">${ch}</option>`).join(''); 
        } 
        applyFilters(); 
    });

    function applyFilters() { 
        const searchTerm = document.getElementById('topicSearch').value.toLowerCase(); 
        const selectedSubject = document.getElementById('topicSubjectFilter').value; 
        const selectedChapter = document.getElementById('topicChapterFilter').value; 
        const filteredTopics = allTopics.filter(topic => 
            (topic.TopicName.toLowerCase().includes(searchTerm)) && 
            (selectedSubject === 'all' || topic.Subject === selectedSubject) && 
            (selectedChapter === 'all' || topic.Chapter === selectedChapter)
        ); 
        populateTracker(filteredTopics); 
    }

    [document.getElementById('topicSearch'), document.getElementById('topicChapterFilter')].forEach(el => el.addEventListener('input', applyFilters));
    document.getElementById('kanbanBoard').addEventListener('dragover', e => { e.preventDefault(); const column = e.target.closest('.kanban-cards'); if (column) column.classList.add('drag-over'); });
    document.getElementById('kanbanBoard').addEventListener('dragleave', e => { const column = e.target.closest('.kanban-cards'); if (column) column.classList.remove('drag-over'); });

    document.getElementById('kanbanBoard').addEventListener('drop', async e => {
        e.preventDefault();
        const columnEl = e.target.closest('.kanban-column');
        if (!columnEl) return;

        columnEl.querySelector('.kanban-cards').classList.remove('drag-over');
        const newStatus = columnEl.dataset.status;
        const draggingCard = document.querySelector('.dragging');
        const topicId = parseInt(draggingCard.dataset.id, 10);

        const topicIndex = allTopics.findIndex(t => t.TopicID == topicId);
        if (topicIndex === -1) {
            alert('Could not find topic data. Please refresh.');
            return;
        }
        allTopics[topicIndex].Status = newStatus;

        columnEl.querySelector('.kanban-cards').appendChild(draggingCard);
        updateColumnCounts();

        try {
            await handlesupabaseClientResponse(supabaseClient.from('Topics').update({ Status: newStatus }).eq('TopicID', topicId));
            showSuccessAnimation('Status Updated!');
            dataCache.analytics = false;
        } catch (error) {
            console.error("Failed to update status:", error);
            alert('Failed to update status. The page will refresh to sync data.');
            fetchTopics(); 
        }
    });

    function openTopicModal(topic = null) { 
        const topicForm = document.getElementById('topicForm'); 
        topicForm.reset(); 
        const topicModal = document.getElementById('topicModal'); 
        if (topic) { 
            topicModal.querySelector('#topicModalTitle').textContent = 'Edit Topic'; 
            topicModal.querySelector('#topicId').value = topic.TopicID; 
            topicModal.querySelector('#topicName').value = topic.TopicName; 
            topicModal.querySelector('#topicSubject').value = topic.Subject; 
            topicModal.querySelector('#topicSubject').dispatchEvent(new Event('change')); 
            setTimeout(() => topicModal.querySelector('#topicChapter').value = topic.Chapter, 0); 
            topicModal.querySelector('#topicDifficulty').value = topic.Difficulty; 
            topicModal.querySelector('#topicImportance').value = topic.Importance; 
            topicModal.querySelector('#topicStatusSelect').value = topic.Status || 'Not Started';
        } else { 
            topicModal.querySelector('#topicModalTitle').textContent = 'Add New Topic'; 
            topicModal.querySelector('#topicId').value = ''; 
            const defaultStatus = event.target.closest('.btn-add-topic').dataset.status; 
            topicModal.querySelector('#topicStatusSelect').value = defaultStatus;
            topicModal.querySelector('#topicChapter').innerHTML = '<option disabled selected value="">Select Subject First</option>'; 
        } 
        topicModal.classList.add('visible'); 
    }

    document.getElementById('closeTopicModal').addEventListener('click', () => document.getElementById('topicModal').classList.remove('visible'));
    document.getElementById('topicModal').addEventListener('click', (e) => { if (e.target.id === 'topicModal') e.target.classList.remove('visible'); });
    document.querySelectorAll('.btn-add-topic').forEach(btn => btn.addEventListener('click', (e) => openTopicModal(null, e)));
    document.getElementById('topicSubject').addEventListener('change', (e) => { 
        const chapterSelect = document.getElementById('topicChapter'); 
        const chapters = chapterData[e.target.value] || []; 
        chapterSelect.innerHTML = '<option disabled selected value="">Select Chapter...</option>'; 
        chapters.forEach(ch => chapterSelect.innerHTML += `<option value="${ch}">${ch}</option>`); 
    });

    document.getElementById('topicForm').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const submitBtn = e.target.querySelector('.nav-btn.submit-btn'); 
        submitBtn.disabled = true; 
        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`; 
        
        const formData = new FormData(e.target);
        const topicData = {
            Subject: formData.get('Subject'),
            Chapter: formData.get('Chapter'),
            TopicName: formData.get('TopicName'),
            Difficulty: formData.get('Difficulty'),
            Importance: formData.get('Importance'),
            Status: formData.get('Status')
        };
        const topicId = formData.get('TopicID');

        try { 
            if (topicId) {
                await handlesupabaseClientResponse(supabaseClient.from('Topics').update(topicData).eq('TopicID', topicId));
                showSuccessAnimation('Topic Updated!');
            } else {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const user_id = session?.user?.id;
                if (!user_id) throw new Error('No active session');
                await handlesupabaseClientResponse(supabaseClient.from('Topics').insert({ ...topicData, user_id }));
                showSuccessAnimation('Topic Added!');
            }
            document.getElementById('topicModal').classList.remove('visible'); 
            await fetchTopics(); 
            dataCache.analytics = false; 
        } catch (error) { 
            alert(`Failed to save: ${error.message}`); 
        } finally { 
            submitBtn.disabled = false; 
            submitBtn.innerHTML = 'Save Topic'; 
        } 
    });

    async function deleteTopicHandler(topicId) { 
        if (!confirm('Are you sure you want to delete this topic permanently?')) return; 
        document.querySelector(`.topic-card[data-id="${topicId}"]`)?.remove(); 
        updateColumnCounts(); 
        try { 
            await handlesupabaseClientResponse(supabaseClient.from('Topics').delete().eq('TopicID', topicId));
            showSuccessAnimation('Topic Deleted!'); 
            allTopics = allTopics.filter(t => t.TopicID != topicId); 
            dataCache.analytics = false; 
        } catch (error) { 
            alert('Failed to delete. Please refresh.'); 
            fetchTopics(); 
        } 
    }
    
// ===================================================================
//                MOTIVATION SECTION LOGIC (FINAL FIX)
// ===================================================================
async function fetchMotivationVideos() {
    startStretchLoader('motivation-loader', 'Loading Videos...');
    try {
        const data = await handlesupabaseClientResponse(supabaseClient.from('Motivation').select('*'));
        allMotivationVideos = data || [];
        populateMotivationGrid(allMotivationVideos);
    } catch(e) {
        console.error('Error fetching motivation videos:', e);
        document.getElementById('motivationGrid').innerHTML = '<p class="exam-list-empty-message">Could not load videos.</p>';
    } finally {
        document.getElementById('motivation-loader').style.display = 'none';
    }
}

function populateMotivationGrid(videos) { 
    const grid = document.getElementById('motivationGrid'); 
    if (!grid) return;
    if (videos.length === 0) { 
        grid.innerHTML = `<p class="exam-list-empty-message" style="grid-column: 1 / -1;">No videos added yet. Click the <i class="fas fa-plus"></i> to start.</p>`; 
        return; 
    } 
    
    grid.innerHTML = videos.map(video => { 
        const videoId = getYouTubeID(video.URL); 
        const thumbnailUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : ''; 
        return `
        <div class="motivation-card-youtube" data-video-id="${videoId}">
            <div class="video-thumbnail-container">
                <img src="${thumbnailUrl}" alt="${video.Title}" loading="lazy">
            </div>
            <div class="video-details">
                <div class="video-icon-wrapper">
                    <i class="fab fa-youtube" style="color:#c00"></i>
                </div>
                <div class="video-meta">
                    <h4 class="video-title">${video.Title}</h4>
                    <p class="video-source">Motivation</p>
                </div>
            </div>
        </div>`; 
    }).join(''); 

    grid.querySelectorAll('.motivation-card-youtube').forEach(card => { 
        card.addEventListener('click', () => { 
            const videoId = card.dataset.videoId; 
            if (videoId) {
                renderVideoPlayerLayout(videoId);
            } 
        }); 
    }); 
}

function renderVideoPlayerLayout(videoIdToPlay) {
    const motivationSection = document.getElementById('motivation');
    
    // Use a class to manage state, not inline styles
    motivationSection.classList.add('player-mode-active');

    const videoData = allMotivationVideos.find(v => getYouTubeID(v.URL) === videoIdToPlay);
    document.getElementById('player-iframe-container').innerHTML = `<iframe src="https://www.youtube.com/embed/${videoIdToPlay}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    document.getElementById('player-video-title').textContent = videoData ? videoData.Title : 'Video';

    const playlistContainer = document.getElementById('player-playlist-items');
    playlistContainer.innerHTML = allMotivationVideos.map(video => {
        const videoId = getYouTubeID(video.URL);
        const isPlaying = videoId === videoIdToPlay;
        return `
            <div class="playlist-item ${isPlaying ? 'is-playing' : ''}" data-video-id="${videoId}">
                <div class="playlist-item-thumbnail">
                    <img src="https://i.ytimg.com/vi/${videoId}/mqdefault.jpg" loading="lazy">
                </div>
                <div class="playlist-item-meta">
                    <h5>${video.Title}</h5>
                    <p>Motivation Channel</p>
                </div>
            </div>
        `;
    }).join('');

    playlistContainer.querySelectorAll('.playlist-item').forEach(item => {
        item.addEventListener('click', () => {
            const newVideoId = item.dataset.videoId;
            if (newVideoId !== videoIdToPlay) {
                renderVideoPlayerLayout(newVideoId);
            }
        });
    });
}

function closeVideoPlayerLayout() {
    const motivationSection = document.getElementById('motivation');
    
    // Stop the video by clearing the iframe
    document.getElementById('player-iframe-container').innerHTML = '';

    // Simply remove the class to revert to the grid view
    motivationSection.classList.remove('player-mode-active');
}

// REPLACE with this robust version
window.showSection = async function(sectionId) {
    // This is the safety net that fixes the "sticking player" bug.
    // It finds the currently active section. If that section is 'motivation',
    // it calls the function to reset its view BEFORE switching to the new section.
    const currentActiveSection = document.querySelector('.content-section.active');
    if (currentActiveSection && currentActiveSection.id === 'motivation') {
        closeVideoPlayerLayout();
    }

    // Now, proceed with the normal section switching logic.
    document.querySelectorAll('.content-section.active').forEach(s => s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');

    const sectionsInMorePanel = ['reports', 'exams', 'motivation', 'settings'];
    document.querySelectorAll('.desktop-nav .nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('onclick').includes(sectionId)) {
            item.classList.add('active');
        }
    });
    document.querySelectorAll('.new-mobile-nav-item').forEach(item => {
        item.classList.remove('active');
        const onclickAttr = item.getAttribute('onclick');
        if (sectionsInMorePanel.includes(sectionId) && item.id === 'more-btn') {
            item.classList.add('active');
        } else if (onclickAttr && onclickAttr.includes(sectionId)) {
            item.classList.add('active');
        }
    });

    // Prevent re-fetching data if it's already cached.
    if (dataCache[sectionId] && sectionId !== 'dashboard') return;

    // Fetch data for the new section.
    switch (sectionId) {
        case 'dashboard': await fetchAndPopulateDashboard(); break;
        case 'reports': await fetchReportPrerequisites(); initReportWizard(); break;
        case 'analytics': await loadAnalyticsData(); break;
        case 'topic': await fetchTopics(); break;
        case 'exams': await fetchExams(); break;
        case 'motivation': await fetchMotivationVideos(); break;
        case 'settings': loadSettings(); break;
    }
    dataCache[sectionId] = true;
};

function initMotivationModals() {
    const addModal = document.getElementById('addMotivationModal');
    const urlInput = document.getElementById('motivationUrl');
    const titleInput = document.getElementById('motivationTitle');

    document.getElementById('addMotivationBtn').addEventListener('click', () => {
        addModal.classList.add('visible');
        document.getElementById('addMotivationForm').reset();
    });
    document.getElementById('closeAddMotivationModal').addEventListener('click', () => addModal.classList.remove('visible'));
    document.getElementById('player-close-btn').addEventListener('click', closeVideoPlayerLayout);

    urlInput.addEventListener('paste', async (e) => {
        e.preventDefault();
        const pastedUrl = (e.clipboardData || window.clipboardData).getData('text');
        urlInput.value = pastedUrl;
        if (getYouTubeID(pastedUrl)) {
            titleInput.placeholder = "Fetching title...";
            try {
                const response = await fetch(`https://noembed.com/embed?url=${pastedUrl}`);
                if (!response.ok) throw new Error(`Service response was not ok: ${response.statusText}`);
                const data = await response.json();
                if (data.title) {
                    titleInput.value = data.title;
                } else {
                    throw new Error("Could not find title.");
                }
            } catch (error) {
                console.error("Could not fetch YouTube title:", error);
                titleInput.placeholder = "Couldn't fetch title, please enter manually";
            }
        }
    });

    document.getElementById('addMotivationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const url = urlInput.value;
        const title = titleInput.value;
        if (!url || !title || !getYouTubeID(url)) {
            alert("Please provide a valid YouTube URL and a title.");
            return;
        }
        const btn = e.target.querySelector('.submit-btn');
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Adding...`;
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const user_id = session?.user?.id;
            if (!user_id) throw new Error('No active session');
            const newVideo = { user_id, URL: url, Title: title };
            await handlesupabaseClientResponse(supabaseClient.from('Motivation').insert(newVideo));
            showSuccessAnimation('Video Added!');
            addModal.classList.remove('visible');
            await fetchMotivationVideos();
        } catch (err) {
            alert(`Failed to add video: ${err.message}`);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Add Video';
        }
    });
}

function getYouTubeID(url) { 
    if(!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; 
    const match = url.match(regExp); 
    return (match && match[2].length === 11) ? match[2] : null; 
}


    // ===================================================================
    //                  ANALYTICS COMMAND CENTER LOGIC (FINAL FIX)
    // ===================================================================
    function renderChart(canvasId, type, data, options) { const ctx = document.getElementById(canvasId)?.getContext('2d'); if (!ctx) return; if (window.myCharts && window.myCharts[canvasId]) { window.myCharts[canvasId].destroy(); } window.myCharts[canvasId] = new Chart(ctx, { type, data, options: { ...chartDefaultOptions, ...options } }); }
    
    async function loadAnalyticsData() {
        startStretchLoader('analytics-loader', 'Analyzing Battlefield Data...');
        try {
             const [exams, practiceLogs, topics, dailyLogs] = await Promise.all([
                handlesupabaseClientResponse(supabaseClient.from('Exams').select('*')),
                handlesupabaseClientResponse(supabaseClient.from('PracticeLogs').select('*')),
                handlesupabaseClientResponse(supabaseClient.from('Topics').select('*')),
                handlesupabaseClientResponse(supabaseClient.from('DailyLogs').select('*'))
            ]);
            allExams = exams || [];
            allPracticeLogs = practiceLogs || [];
            allTopics = topics || [];
            allDailyLogs = dailyLogs || [];
            
            initAnalyticsPanes();
            renderFullAnalyticsDashboard();
            generateAllAnalyticsIntelligence();

        } catch (e) {
            console.error("Failed to load analytics data", e);
        } finally {
            document.getElementById('analytics-loader').style.display = 'none';
        }
    }

    function initAnalyticsPanes() {
        document.getElementById('analyticsTabs').addEventListener('click', (e) => {
            const btn = e.target.closest('.analytics-tab-btn');
            if (btn) {
                document.querySelector('#analyticsTabs .active').classList.remove('active');
                btn.classList.add('active');
                document.querySelectorAll('.analytics-pane').forEach(p => p.classList.toggle('active', p.id === btn.dataset.pane));
            }
        });
        document.querySelectorAll('#exam-time-filter, #exam-subject-filter, #exam-chapter-filter').forEach(el => el.addEventListener('change', updateInteractiveExamChart));
        document.getElementById('syllabus-subject-selector').addEventListener('change', e => updateSyllabusSubjectView(e.target.value));
    }

    function renderFullAnalyticsDashboard() {
        renderExamAnalyticsPane();
        renderSyllabusAnalyticsPane();
        renderHabitsAnalyticsPane();
    }

    function renderExamAnalyticsPane() {
        const completedExams = allExams.filter(e => e.Status === 'Completed' && e.Score && e.TotalMarks);
        const subjectPerformance = calculateSubjectPerformance(completedExams);
        let bestSubject = { name: '--', score: -1 };
        let worstSubject = { name: '--', score: 101 };

        if (completedExams.length > 0) {
            Object.entries(subjectPerformance).forEach(([subject, data]) => {
                if (data.count > 0) {
                    if (data.avgScore > bestSubject.score) bestSubject = { name: subject, score: data.avgScore };
                    if (data.avgScore < worstSubject.score) worstSubject = { name: subject, score: data.avgScore };
                }
            });
            const overallAvgScore = completedExams.reduce((sum, e) => sum + (parseFloat(e.Score) / parseFloat(e.TotalMarks) * 100), 0) / completedExams.length;
            const overallMistakeRate = 100 - overallAvgScore;
            
            document.getElementById('exam-avg-score').textContent = `${overallAvgScore.toFixed(0)}%`;
            document.getElementById('exam-avg-mistake-rate').textContent = `${overallMistakeRate.toFixed(0)}%`;
        } else {
            document.getElementById('exam-avg-score').textContent = `N/A`;
            document.getElementById('exam-avg-mistake-rate').textContent = `N/A`;
        }
        
        document.getElementById('exam-best-subject').textContent = bestSubject.name;
        document.getElementById('exam-best-subject-score').textContent = bestSubject.score > -1 ? `${bestSubject.score.toFixed(0)}% Avg` : 'Best Subject';

        document.getElementById('exam-worst-subject').textContent = worstSubject.name;
        document.getElementById('exam-worst-subject-score').textContent = worstSubject.score < 101 ? `${worstSubject.score.toFixed(0)}% Avg` : 'Worst Subject';
        
        const subjects = Object.keys(chapterData);
        const subjectFilter = document.getElementById('exam-subject-filter');
        subjectFilter.innerHTML = `<option value="all">All Subjects</option>${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}`;
        
        subjectFilter.addEventListener('change', (e) => {
            const chapterFilter = document.getElementById('exam-chapter-filter');
            const chapters = chapterData[e.target.value] || [];
            chapterFilter.innerHTML = '<option value="all">All Chapters</option>' + chapters.map(c => `<option value="${c}">${c}</option>`).join('');
            chapterFilter.disabled = e.target.value === 'all';
        });

        updateInteractiveExamChart();
    }

    function renderSyllabusAnalyticsPane() {
        const total = allTopics.length;
        const completed = allTopics.filter(t => t.Status === 'Completed').length;
        const needsReview = allTopics.filter(t => t.Status === 'Needs Review').length;
        const remaining = total - completed;

        document.getElementById('syllabus-completion-percent').textContent = `${total > 0 ? (completed / total * 100).toFixed(0) : 0}%`;
        document.getElementById('syllabus-topics-completed').textContent = completed;
        document.getElementById('syllabus-topics-review').textContent = needsReview;
        document.getElementById('syllabus-topics-remaining').textContent = remaining;

        const subjectSelector = document.getElementById('syllabus-subject-selector');
        if (subjectSelector) {
            subjectSelector.innerHTML = Object.keys(chapterData).map(s => `<option value="${s}">${s}</option>`).join('');
            updateSyllabusSubjectView(subjectSelector.value);
        }
    }

    function updateHabitCorrelationChart(days = 7) {
        const logs = days === 'all' ? allDailyLogs : allDailyLogs.filter(log => {
            const logDate = new Date(log.Date);
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            return logDate >= cutoff;
        });

        if (logs.length === 0) {
            renderChart('habit-correlation-chart', 'line', { labels: [], datasets: [] });
            return;
        }

        const labels = [], productiveData = [], sleepData = [], screenData = [];

        logs.forEach(log => {
            const d = new Date(log.Date);
            labels.push(d);
            const dateStr = d.toLocaleDateString('en-CA');
            
            const practiceLogsToday = allPracticeLogs.filter(l => new Date(l.Date).toLocaleDateString('en-CA') === dateStr);
            const productiveMinutes = practiceLogsToday.reduce((sum, practiceLog) => sum + (practiceLog.timeSpent || 0) + ((practiceLog.classTime || 0) * 60), 0);
            
            productiveData.push(productiveMinutes / 60);
            sleepData.push(log.sleepHours || 0);
            screenData.push(log.screenTime || 0);
        });

        renderChart('habit-correlation-chart', 'line', {
                labels,
                datasets: [
                    { label: 'Productive (hr)', data: productiveData, borderColor: '#2ecc71', tension: 0.4, yAxisID: 'y', pointBackgroundColor: '#2ecc71', pointBorderColor: '#fff', pointRadius: 3 },
                    { label: 'Sleep (hr)', data: sleepData, borderColor: '#3b82f6', tension: 0.4, yAxisID: 'y1', pointBackgroundColor: '#3b82f6', pointBorderColor: '#fff', pointRadius: 3 },
                    { label: 'Screen Time (hr)', data: screenData, borderColor: '#ef4444', tension: 0.4, yAxisID: 'y1', pointBackgroundColor: '#ef4444', pointBorderColor: '#fff', pointRadius: 3 }
                ]
            }, { scales: { x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#8b949e' } }, y: { position: 'left', title: { display: true, text: 'Productive Hours', color: '#8b949e' }, ticks: { color: '#8b949e' }, grid: { color: 'rgba(255,255,255,0.05)' } }, y1: { position: 'right', title: { display: true, text: 'Habit Hours', color: '#8b949e' }, grid: { drawOnChartArea: false }, ticks: { color: '#8b949e' } } } });
    }

    function renderHabitsAnalyticsPane() {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - 30);
        const logs = allDailyLogs.filter(l => new Date(l.Date) >= cutoff);

        if (logs.length === 0) {
            document.getElementById('habit-avg-sleep').textContent = 'N/A';
            document.getElementById('habit-avg-screen').textContent = 'N/A';
            document.getElementById('habit-avg-wasted').textContent = 'N/A';
            document.getElementById('habit-discipline-rate').textContent = 'N/A';
            updateHabitCorrelationChart(7); 
            return;
        };

        const logCount = logs.length;
        const avgSleep = logs.reduce((sum, log) => sum + (Number(log.sleepHours) || 0), 0) / logCount;
        const avgScreen = logs.reduce((sum, log) => sum + (Number(log.screenTime) || 0), 0) / logCount;
        const disciplineRate = (logs.filter(l => l.discipline).length / logCount) * 100;
        
        let totalWastedHours = 0;
        logs.forEach(log => {
            const dateStr = new Date(log.Date).toLocaleDateString('en-CA');
            const practiceLogsToday = allPracticeLogs.filter(l => new Date(l.Date).toLocaleDateString('en-ca') === dateStr);
            const productiveMinutes = practiceLogsToday.reduce((sum, pl) => sum + (Number(pl.timeSpent) || 0) + ((Number(pl.classTime) || 0) * 60), 0);
            const sleepHours = Number(log.sleepHours) || 0;
            const awakeHours = 24 - sleepHours;
            const productiveHours = productiveMinutes / 60;
            totalWastedHours += Math.max(0, awakeHours - productiveHours);
        });
        const avgWasted = totalWastedHours / logCount;

        document.getElementById('habit-avg-sleep').textContent = `${avgSleep.toFixed(1)} hr`;
        document.getElementById('habit-avg-screen').textContent = `${avgScreen.toFixed(1)} hr`;
        document.getElementById('habit-avg-wasted').textContent = `${avgWasted.toFixed(1)} hr`;
        document.getElementById('habit-discipline-rate').textContent = `${disciplineRate.toFixed(0)}%`;

        const filterContainer = document.getElementById('habit-time-filters');
        if (filterContainer.querySelector('.active')) filterContainer.querySelector('.active').classList.remove('active');
        filterContainer.querySelector('[data-days="7"]').classList.add('active');

        if (!filterContainer.dataset.listenerAttached) {
            filterContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.time-filter-btn');
                if (btn) {
                    filterContainer.querySelector('.active').classList.remove('active');
                    btn.classList.add('active');
                    const days = btn.dataset.days === 'all' ? 'all' : parseInt(btn.dataset.days, 10);
                    updateHabitCorrelationChart(days);
                }
            });
            filterContainer.dataset.listenerAttached = 'true';
        }
        updateHabitCorrelationChart(7);
    }
        
    function updateInteractiveExamChart() { 
        let filteredExams = allExams.filter(e => e.Status === 'Completed' && e.Score && e.TotalMarks); 
        const time = document.getElementById('exam-time-filter').value; 
        const subject = document.getElementById('exam-subject-filter').value; 
        const chapter = document.getElementById('exam-chapter-filter').value; 
        if (time !== 'all') { 
            const cutoff = new Date(); 
            cutoff.setDate(cutoff.getDate() - parseInt(time)); 
            filteredExams = filteredExams.filter(e => new Date(e.ExamDate) >= cutoff); 
        } 
        if (subject !== 'all') { 
            filteredExams = filteredExams.filter(e => (e.ChaptersCovered || '').split(', ').some(c => chapterData[subject]?.includes(c))); 
            if (chapter !== 'all') { 
                filteredExams = filteredExams.filter(e => (e.ChaptersCovered || '').includes(chapter)); 
            } 
        } 
        filteredExams.sort((a, b) => new Date(a.ExamDate) - new Date(b.Date)); 
        const labels = filteredExams.map(e => new Date(e.ExamDate)); 
        const scoreData = filteredExams.map(e => (parseFloat(e.Score) / parseFloat(e.TotalMarks) * 100)); 
        const mistakeData = scoreData.map(s => 100 - s); 
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(); 
        renderChart('interactive-exam-chart', 'line', { labels, datasets: [ { label: 'Score (%)', data: scoreData, borderColor: primaryColor, tension: 0.4, fill: false, yAxisID: 'y' }, { label: 'Mistake Rate (%)', data: mistakeData, borderColor: '#ef4444', tension: 0.4, fill: false, yAxisID: 'y' } ] }, { scales: { x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#8b949e' } }, y: { beginAtZero: true, max: 100, ticks: { color: '#8b949e' } } } }); 
    }

    function updateSyllabusSubjectView(subject) { 
        const topicsInSubject = allTopics.filter(t => t.Subject === subject); 
        const statusCounts = { 'Completed': 0, 'In Progress': 0, 'Needs Review': 0, 'Not Started': 0 }; 
        topicsInSubject.forEach(t => statusCounts[t.Status || 'Not Started']++); 
        renderChart('syllabus-subject-pie-chart', 'doughnut', { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#6b7280'], borderColor: 'var(--bg-card)', borderWidth: 4 }] }, { cutout: '60%' }); 
        const chapterGrid = document.getElementById('syllabus-chapter-grid'); 
        chapterGrid.innerHTML = (chapterData[subject] || []).map(chapter => { 
            const topicsInChapter = topicsInSubject.filter(t => t.Chapter === chapter); 
            const completedInChapter = topicsInChapter.filter(t => t.Status === 'Completed').length; 
            const progress = topicsInChapter.length > 0 ? (completedInChapter / topicsInChapter.length * 100) : 0; 
            return ` <div class="chapter-progress-item"> <span>${chapter}</span> <div class="chapter-progress-bar"><div class="chapter-progress-fill" style="width: ${progress}%;"></div></div> <small>${progress.toFixed(0)}%</small> </div> `; 
        }).join(''); 
    }

    function generateAllAnalyticsIntelligence() {
        generateExamIntelligence();
        generateSyllabusIntelligence();
        generateHabitIntelligence();
    }

    function generateExamIntelligence() {
        let recommendations = [];
        const completedExams = allExams.filter(e => e.Status === 'Completed' && e.Score && e.TotalMarks > 0);

        if (completedExams.length < 3) {
            recommendations.push({ priority: 'low', icon: 'fa-file-signature', title: "More Data Needed", text: "Take more exams to unlock detailed performance insights and recommendations." });
        } else {
            const subjectPerformance = calculateSubjectPerformance(completedExams);
            const worstSubject = Object.entries(subjectPerformance).filter(s => s[1].count > 0).sort((a,b) => a[1].avgScore - b[1].avgScore)[0];
            
            if (worstSubject && worstSubject[1].avgScore < 60) {
                recommendations.push({ priority: 'high', icon: 'fa-triangle-exclamation', title: `Priority Focus: ${worstSubject[0]}`, text: `Your average score in this subject is ${worstSubject[1].avgScore.toFixed(0)}%. Dedicate focused review sessions to its fundamental concepts.` });
            }

            const chapterPerformance = calculateChapterPerformance(completedExams);
            const weakChapters = Object.entries(chapterPerformance)
                .filter(([ch, data]) => data.count > 0 && data.mistakeRate > 40)
                .sort((a,b) => b[1].mistakeRate - a[1].mistakeRate);
                
            if (weakChapters.length > 0) {
                 recommendations.push({ priority: 'medium', icon: 'fa-magnifying-glass-chart', title: `Chapter Review: ${weakChapters[0][0]}`, text: `This chapter has a high mistake rate of ${weakChapters[0][1].mistakeRate.toFixed(0)}%. Re-practice problems from this chapter.` });
            }
        }
        
        if (recommendations.length === 0) {
             recommendations.push({ priority: 'low', icon: 'fa-check-circle', title: "Performance Stable", text: "No critical performance issues detected in your exam history. Keep up the consistent effort!" });
        }

        displayRecommendations('exam-recommendations-list', recommendations);
    }

    function generateSyllabusIntelligence() {
        let recommendations = [];
        const today = new Date();
        const staleTopics = allTopics.filter(t => t.Status === 'Completed' && new Date(t.LastReviewed || '2000-01-01') < new Date(today.getTime() - 21 * 24 * 60 * 60 * 1000));
        if (staleTopics.length > 0) {
            staleTopics.sort((a, b) => new Date(a.LastReviewed || '2000-01-01') - new Date(b.LastReviewed || '2000-01-01'));
            recommendations.push({ priority: 'medium', icon: 'fa-book-reader', title: "Spaced Repetition", text: `It's been over 3 weeks since you reviewed "${staleTopics[0].TopicName}". A quick review will strengthen your memory.`});
        }
        const stuckTopics = allTopics.filter(t => t.Status === 'In Progress' && new Date(t.LastReviewed || t.created_at) < new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000));
         if (stuckTopics.length > 0) {
            stuckTopics.sort((a, b) => new Date(a.LastReviewed || a.created_at) - new Date(b.LastReviewed || b.created_at));
            recommendations.push({ priority: 'high', icon: 'fa-circle-exclamation', title: "Stuck in Progress?", text: `The topic "${stuckTopics[0].TopicName}" has been 'In Progress' for over 10 days. Plan to complete or review it soon.`});
        }
        if (recommendations.length === 0) {
             recommendations.push({ priority: 'low', icon: 'fa-check-circle', title: "Syllabus on Track", text: "Your topic progress is looking good. No stale or stuck topics detected." });
        }
        displayRecommendations('syllabus-recommendations-list', recommendations);
    }

    function generateHabitIntelligence() {
        let recommendations = [];
        const today = new Date();
        const last14DaysLogs = allDailyLogs.filter(l => new Date(l.Date) > new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000));
        if (last14DaysLogs.length > 5) {
            const avgSleep = last14DaysLogs.reduce((s,l) => s + (l.sleepHours || 0), 0) / last14DaysLogs.length;
            const avgScreen = last14DaysLogs.reduce((s,l) => s + (l.screenTime || 0), 0) / last14DaysLogs.length;
            const disciplineBreaks = last14DaysLogs.filter(l => l.discipline === false).length;
            if(avgSleep < 6.5) {
                recommendations.push({ priority: 'high', icon: 'fa-bed', title: "Consistent Low Sleep", text: `Your average sleep of ${avgSleep.toFixed(1)} hours over the last 2 weeks is impacting your cognitive ability. Prioritize getting 7-8 hours.` });
            }
            if(avgScreen > 7) {
                recommendations.push({ priority: 'medium', icon: 'fa-mobile-alt', title: "Habitual High Screen Time", text: `Your screen time is consistently high (${avgScreen.toFixed(1)}h/day). This habit is likely draining your focus. Set app timers.` });
            }
            if(disciplineBreaks > 2) {
                recommendations.push({ priority: 'medium', icon: 'fa-user-slash', title: "Discipline Pattern", text: `You've had ${disciplineBreaks} discipline breaks recently. Identify the triggers to build a stronger routine.` });
            }
        }
        if (recommendations.length === 0) {
             recommendations.push({ priority: 'low', icon: 'fa-check-circle', title: "Habits are Solid", text: "Your recent daily habits show good consistency. Keep it up!" });
        }
        displayRecommendations('habit-recommendations-list', recommendations);
    }

    function displayRecommendations(containerId, recs) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (recs.length === 0) {
            container.innerHTML = `<li class="recommendation-list-item priority-low"><i class="fas fa-check-circle" style="color:#22c55e;"></i><div class="recommendation-content"><h5>All Systems Go!</h5><p>No high-priority recommendations at this time. Keep up the great work!</p></div></li>`;
            return;
        }
        container.innerHTML = recs.map(r => `
            <li class="recommendation-list-item priority-${r.priority}">
                <i class="fas ${r.icon}"></i>
                <div class="recommendation-content">
                    <h5>${r.title}</h5>
                    <p>${r.text}</p>
                </div>
            </li>
        `).join('');
    }

    function calculateSubjectPerformance(exams) { const performance = {}; Object.keys(chapterData).forEach(s => performance[s] = { scores: [], totalMarks: [], count: 0, avgScore: 0 }); exams.forEach(exam => { const examSubjects = new Set((exam.ChaptersCovered || '').split(', ').map(ch => Object.keys(chapterData).find(s => chapterData[s].includes(ch))).filter(Boolean)); examSubjects.forEach(s => { performance[s].scores.push(parseFloat(exam.Score)); performance[s].totalMarks.push(parseFloat(exam.TotalMarks)); performance[s].count++; }); }); Object.keys(performance).forEach(s => { const sumScores = performance[s].scores.reduce((a,b) => a+b, 0); const sumMarks = performance[s].totalMarks.reduce((a,b) => a+b, 0); performance[s].avgScore = sumMarks > 0 ? (sumScores / sumMarks * 100) : 0; }); return performance; }
    function calculateChapterPerformance(exams) { const performance = {}; exams.forEach(exam => { const chapters = (exam.ChaptersCovered || '').split(', '); const scorePerMark = parseFloat(exam.Score) / parseFloat(exam.TotalMarks); chapters.forEach(ch => { if (!performance[ch]) performance[ch] = { scores: [], counts: 0 }; performance[ch].scores.push(scorePerMark); performance[ch].counts++; }); }); const avgPerformance = {}; Object.entries(performance).forEach(([chapter, data]) => { const avgScore = (data.scores.reduce((a,b) => a+b, 0) / data.counts) * 100; avgPerformance[chapter] = { mistakeRate: 100 - avgScore, count: data.counts }; }); return avgPerformance; }
    
// ===================================================================
//            SETTINGS & NOTIFICATION LOGIC (FINAL COMPLETE VERSION)
// ===================================================================

// Your VAPID Public Key (provided by user)
const VAPID_PUBLIC_KEY = "BMB6icJmtt4nyI3XSnIZqIj1Os3mZaw1e5t2MCfs5cAJNcBV9gnNAmPVBUEFx0YHeaGO1nn1J5-VrLfIUowCF0Y";

// Helper function to convert the VAPID key.
function urlB64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

function withTimeout(promise, ms, label = 'operation') {
    return new Promise((resolve, reject) => {
        const t = setTimeout(() => reject(new Error(`${label} timed out after ${ms}ms`)), ms);
        promise.then(v => { clearTimeout(t); resolve(v); }).catch(e => { clearTimeout(t); reject(e); });
    });
}

async function ensureServiceWorkerReady() {
    if (!('serviceWorker' in navigator)) throw new Error('Service worker unsupported');
    // If no controller yet, try to register proactively
    if (!navigator.serviceWorker.controller) {
        try { await navigator.serviceWorker.register('./sw.js'); } catch (e) { console.warn('SW register failed:', e); }
    }
    // Wait for ready with timeout to avoid hanging UI
    return await withTimeout(navigator.serviceWorker.ready, 8000, 'serviceWorker.ready');
}

// The correct subscription function using the secure Edge Function
async function subscribeUserToPush() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('Sorry, Push Notifications are not supported by your browser.');
        return;
    }
    const btn = document.getElementById('btnEnableNotifications');
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Enabling...`;

    try {
        // Request user permission explicitly first
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            btn.disabled = false;
            btn.textContent = 'Enable Mentor';
            alert('Notifications permission was not granted.');
            return;
        }
        const swRegistration = await ensureServiceWorkerReady();
        let subscription = await swRegistration.pushManager.getSubscription();

        if (subscription === null) {
            console.log('No subscription found, creating new one.');
            const applicationServerKey = urlB64ToUint8Array(VAPID_PUBLIC_KEY);
            subscription = await withTimeout(swRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: applicationServerKey
            }), 8000, 'pushManager.subscribe');
        }

        console.log('User is subscribed:', subscription);

        // Send the subscription to our secure Supabase Edge Function
        const { error } = await withTimeout(
            supabaseClient.functions.invoke('save-subscription', { body: JSON.stringify(subscription) }),
            8000,
            'save-subscription'
        );

        if (error) {
            throw new Error('Supabase function failed: ' + error.message);
        }
        
        console.log('Subscription successfully sent to Supabase function.');
        alert('You have enabled notifications!');
        btn.textContent = 'Mentor Enabled!';

    } catch (error) {
        console.error('Failed to subscribe the user:', error);
        alert('Failed to enable notifications. Please check the console for errors.');
        btn.disabled = false;
        btn.textContent = 'Enable Mentor';

        if (Notification.permission === 'denied') {
            alert("You have blocked notifications. Please enable them in your browser's site settings.");
        }
    }
}

// Main function to set up all the buttons and actions in the Settings page
function initSettings() {
    document.getElementById('settingsNav').addEventListener('click', (e) => { 
        if (e.target.tagName === 'BUTTON') { 
            document.querySelector('#settingsNav .active').classList.remove('active'); 
            e.target.classList.add('active'); 
            document.querySelectorAll('.settings-pane').forEach(pane => pane.classList.toggle('active', pane.id === e.target.dataset.pane)); 
        } 
    }); 
    
    document.getElementById('btnEnableNotifications').addEventListener('click', subscribeUserToPush);
    
    document.getElementById('saveExamDateBtn').addEventListener('click', () => { 
        const newDate = document.getElementById('settingsExamDate').value; 
        if (newDate) { 
            localStorage.setItem('examCountdownDate', newDate); 
            showSuccessAnimation('Exam Date Saved!'); 
        } else { 
            alert('Please select a valid date.'); 
        } 
    }); 
    
    document.getElementById('themeColorSelector').addEventListener('click', (e) => { 
        if (e.target.classList.contains('theme-color-option')) { 
            const newColor = e.target.dataset.color; 
            applyThemeColor(newColor); 
            localStorage.setItem('themeColor', newColor); 
        } 
    }); 
}

// RESTORED FUNCTION 2: Loads settings when the page is viewed
function loadSettings() { 
    const savedExamDate = localStorage.getItem('examCountdownDate'); 
    if (savedExamDate) document.getElementById('settingsExamDate').value = savedExamDate; 
    const savedThemeColor = localStorage.getItem('themeColor'); 
    if (savedThemeColor) applyThemeColor(savedThemeColor); 
    else applyThemeColor('#4cfa9d'); 
}

// RESTORED FUNCTION 3: Applies the selected theme color
function applyThemeColor(color) { 
    const r = parseInt(color.substring(1, 3), 16); 
    const g = parseInt(color.substring(3, 5), 16); 
    const b = parseInt(color.substring(5, 7), 16); 
    const newGlow = `rgba(${r}, ${g}, ${b}, 0.3)`; 
    document.documentElement.style.setProperty('--primary-color', color); 
    document.documentElement.style.setProperty('--primary-glow', newGlow); 
    document.querySelector('#themeColorSelector .active')?.classList.remove('active'); 
    document.querySelector(`#themeColorSelector [data-color="${color}"]`)?.classList.add('active'); 
    if (dataCache.analytics) { renderFullAnalyticsDashboard(); } 
    if (document.getElementById('dashboard').classList.contains('active')) { renderDashboardCharts(); } 
}
    
    // ===================================================================
    //                      MOBILE NAVIGATION LOGIC
    // ===================================================================
    function initNewMobileNav() { const moreBtn = document.getElementById('more-btn'); const overlay = document.getElementById('more-options-overlay'); const panel = document.getElementById('more-options-panel'); const closeBtn = document.getElementById('close-more-panel-btn'); const toggleMorePanel = (show) => { const isOpen = document.body.classList.contains('more-panel-open'); if (show === true || (show !== false && !isOpen)) { document.body.classList.add('more-panel-open'); } else { document.body.classList.remove('more-panel-open'); } }; moreBtn.addEventListener('click', () => toggleMorePanel(true)); overlay.addEventListener('click', () => toggleMorePanel(false)); closeBtn.addEventListener('click', () => toggleMorePanel(false)); panel.querySelectorAll('.more-option-item').forEach(item => { item.addEventListener('click', () => { toggleMorePanel(false); }); }); }
  
    // ===================================================================
    //              ADVANCED DYNAMIC DASHBOARD LOGIC (V2)
    // ===================================================================
    function linearRegression(y) {
        const n = y.length;
        if (n === 0) return { slope: 0 };
        let sum_x = 0, sum_y = 0, sum_xy = 0, sum_xx = 0;
        for (let i = 0; i < n; i++) {
            const x = i;
            const score = y[i];
            sum_x += x;
            sum_y += score;
            sum_xy += (x * score);
            sum_xx += (x * x);
        }
        const slope = (n * sum_xy - sum_x * sum_y) / (n * sum_xx - sum_x * sum_x);
        return { slope: isNaN(slope) ? 0 : slope };
    }

    function calculatePerformanceForecast() {
        const completedExams = (window.dashboardData.allExams || [])
            .filter(e => e.Status === 'Completed' && e.Score != null && e.TotalMarks > 0)
            .sort((a, b) => new Date(a.ExamDate) - new Date(b.ExamDate));
        if (completedExams.length === 0) return { prediction: 'N/A', historicalData: [] };
        const scores = completedExams.map(e => (parseFloat(e.Score) / parseFloat(e.TotalMarks) * 100));
        if (scores.length < 2) return { prediction: scores[0].toFixed(0), historicalData: scores };
        let weightedScoreSum = 0;
        let weightSum = 0;
        scores.forEach((score, index) => {
            const weight = index + 1;
            weightedScoreSum += score * weight;
            weightSum += weight;
        });
        const weightedAvg = weightedScoreSum / weightSum;
        const trend = linearRegression(scores);
        const trendModifier = Math.max(-10, Math.min(10, trend.slope * 2.5));
        const today = new Date();
        let studyDays = new Set();
        (window.dashboardData.allPracticeLogs || []).forEach(log => {
            const logDate = new Date(log.Date);
            const daysAgo = (today - logDate) / (1000 * 60 * 60 * 24);
            if (daysAgo <= 14) {
                studyDays.add(log.Date);
            }
        });
        const consistency = (studyDays.size / 14);
        const consistencyModifier = (consistency - 0.5) * 10;
        let finalPrediction = (weightedAvg * 0.6) + ((weightedAvg + trendModifier) * 0.2) + ((weightedAvg + consistencyModifier) * 0.2);
        finalPrediction = Math.max(0, Math.min(100, finalPrediction));
        return {
            prediction: finalPrediction.toFixed(0),
            historicalData: scores
        };
    }

    function getScoresForSubject(subjectName) {
        if (!subjectName || subjectName === 'N/A') return [0,0,0,0,0];
        const subjectChapters = new Set(chapterData[subjectName] || []);
        const subjectExams = (window.dashboardData.allExams || [])
            .filter(exam => {
                const examChapters = (exam.ChaptersCovered || '').split(', ');
                return examChapters.some(ch => subjectChapters.has(ch));
            })
            .filter(e => e.Status === 'Completed' && e.Score != null && e.TotalMarks > 0)
            .sort((a, b) => new Date(a.ExamDate) - new Date(b.ExamDate));
        if (subjectExams.length === 0) return [0,0,0,0,0];
        return subjectExams.map(e => (parseFloat(e.Score) / parseFloat(e.TotalMarks) * 100));
    }

    // ===================================================================
    //                 NEW ACTION HUB LOGIC (INTEGRATED)
    // ===================================================================
    function initActionHub() {
        const fab = document.getElementById('centerHubFab');
        const overlay = document.getElementById('centerHubOverlay');
        const closeBtn = document.getElementById('closeCenterHubBtn');
        const sleepCard = document.getElementById('sleepTrackerCard');
        const practiceCard = document.getElementById('practiceCard');
        const dailyCard = document.getElementById('dailyCard');
        const formPopup = document.getElementById('formPopupOverlay');

        const togglePanel = (show) => {
            overlay.classList.toggle('visible', show);
        };

        fab.addEventListener('click', () => togglePanel(true));
        closeBtn.addEventListener('click', () => togglePanel(false));
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) { togglePanel(false); }
        });

        sleepCard.addEventListener('click', () => handleTrackerClick('sleep'));
        
        practiceCard.addEventListener('click', () => {
            togglePanel(false);
            setTimeout(() => {
                // Open main form and switch to Practice tab
                formPopup.classList.add('visible');
                document.getElementById('tabPractice').click();
            }, 400); // Wait for panel animation
        });

        dailyCard.addEventListener('click', () => {
            togglePanel(false);
            setTimeout(() => {
                // Open main form and switch to Daily tab
                formPopup.classList.add('visible');
                document.getElementById('tabDailyLog').click();
            }, 400); // Wait for panel animation
        });

        checkTrackerStateOnLoad('sleep');
    }

    function handleTrackerClick(trackerType) {
        const currentState = localStorage.getItem(`${trackerType}TrackerState`);
        if (currentState === 'running') { stopTracker(trackerType); } 
        else { startTracker(trackerType); }
    }

    function startTracker(trackerType) {
        const startTime = Date.now();
        localStorage.setItem(`${trackerType}TrackerState`, 'running');
        localStorage.setItem(`${trackerType}StartTime`, startTime);
        updateTrackerUI(trackerType, 'running');
    }

    async function stopTracker(trackerType) {
        const startTime = parseInt(localStorage.getItem(`${trackerType}StartTime`), 10);
        if (!startTime) return;

        const durationMs = Date.now() - startTime;
        const sleepHours = durationMs / (1000 * 60 * 60);

        // Clear local storage first
        localStorage.removeItem(`${trackerType}TrackerState`);
        localStorage.removeItem(`${trackerType}StartTime`);
        updateTrackerUI(trackerType, 'idle');

        // Now, save to Supabase
        try {
            const todayStr = new Date().toLocaleDateString('en-CA');
            const { data: { session } } = await supabaseClient.auth.getSession();
            const user_id = session?.user?.id;
            if (!user_id) throw new Error('No active session for saving sleep log.');

            // Find today's log to update it, or prepare a new one
            const { data: existingLog } = await supabaseClient.from('DailyLogs').select('*').eq('user_id', user_id).eq('Date', todayStr).single();

            const payload = {
                user_id,
                Date: todayStr,
                sleepHours: sleepHours.toFixed(2),
                // Preserve existing data if it exists
                screenTime: existingLog?.screenTime || 0,
                prayers: existingLog?.prayers || 0,
                discipline: existingLog?.discipline || false,
                notes: existingLog?.notes || ''
            };

            await handlesupabaseClientResponse(
                supabaseClient.from('DailyLogs').upsert(payload, { onConflict: 'user_id,Date' })
            );

            showSuccessAnimation(`Sleep logged: ${sleepHours.toFixed(1)} hours`);
            // Refresh dashboard data in the background
            fetchAndPopulateDashboard();
        } catch (error) {
            console.error('Failed to save sleep data to Supabase:', error);
            alert('Could not save sleep data. Please check your connection.');
        }
    }

    function updateTrackerUI(trackerType, state) {
        const card = document.getElementById(`${trackerType}TrackerCard`);
        const display = document.getElementById(`${trackerType}TimerDisplay`);
        const staticContent = document.getElementById(`${trackerType}CardStatic`);
        const liveContent = document.getElementById(`${trackerType}CardLive`);

        if (state === 'running') {
            card.classList.add('tracking-active');
            staticContent.style.display = 'none';
            liveContent.style.display = 'flex';
            const startTime = parseInt(localStorage.getItem(`${trackerType}StartTime`), 10);
            window.activeTimers[trackerType] = setInterval(() => {
                if(display) display.textContent = formatMilliseconds(Date.now() - startTime);
            }, 1000);
        } else {
            card.classList.remove('tracking-active');
            staticContent.style.display = 'flex';
            liveContent.style.display = 'none';
            clearInterval(window.activeTimers[trackerType]);
            window.activeTimers[trackerType] = null;
            if(display) display.textContent = "00:00:00";
        }
    }

    function checkTrackerStateOnLoad(trackerType) {
        if (localStorage.getItem(`${trackerType}TrackerState`) === 'running') {
            updateTrackerUI(trackerType, 'running');
        }
    }

    function formatMilliseconds(ms) {
        let seconds = Math.floor(ms / 1000);
        let hours = Math.floor(seconds / 3600);
        let minutes = Math.floor((seconds % 3600) / 60);
        seconds = seconds % 60;
        return [hours, minutes, seconds].map(v => v.toString().padStart(2, '0')).join(':');
    }
  </script>

// ===================================================================
//                ADVANCED PUSH NOTIFICATION LOGIC (NEW)
// ===================================================================

// This helper function is required by the push API
// Removed duplicate legacy notification functions with placeholder key.

    <!-- =================================================================== -->
    <!--                   START: AUTH GUARD & LOGOUT                     -->
    <!-- =================================================================== -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Enforce authentication: if no Supabase session, redirect to login
            try {
                const { data } = await supabaseClient.auth.getSession();
                if (!data?.session) {
                    window.location.href = 'login.html';
                    return;
                }
            } catch (e) {
                window.location.href = 'login.html';
                return;
            }

            // Wire up Logout button in Settings (if present)
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try { await supabaseClient.auth.signOut(); } catch (_) {}
                    sessionStorage.removeItem('sessionActive');
                    localStorage.removeItem('rememberMe');
                    window.location.href = 'login.html';
                });
            }

            // Auto-redirect to login if session ends
            supabaseClient.auth.onAuthStateChange((_event, session) => {
                if (!session) {
                    window.location.href = 'login.html';
                }
            });
        });
    </script>
    <!-- =================================================================== -->
    <!--                    END: AUTH GUARD & LOGOUT                       -->
    <!-- =================================================================== -->

    <!-- START: Mobile Navigation (prototype) -->
    <style>
      /* Mobile-only scope */
      @media (max-width: 900px) {
        :root { --mobile-safe-bottom: env(safe-area-inset-bottom, 20px); --mobile-nav-height: 70px; }
        body { padding-bottom: calc(var(--mobile-nav-height) + var(--mobile-safe-bottom)); }
        /* Hide any legacy/old mobile navs and FAB so only the new mobile nav shows */
        .center-hub-fab,
        .nav-actions, .bottom-nav, .old-mobile-nav, .legacy-mobile-nav { display: none !important; }

        .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--mobile-nav-height) + var(--mobile-safe-bottom)); background: #0a0a0a; border-top: 1px solid #1a1a1a; display: flex; justify-content: space-between; align-items: center; padding: 6px 10px var(--mobile-safe-bottom) 10px; z-index: 2000; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); -webkit-user-select: none; user-select: none; column-gap: 6px; box-sizing: border-box; }
        nav.mobile-nav .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1 1 0; min-width: 66px; height: 56px; padding: 6px 10px; gap: 4px; cursor: pointer; transition: all .2s ease; border-radius: 12px; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        /* Mobile override: no background overlay on hover/active/selected */
        nav.mobile-nav .nav-item:hover { background: transparent !important; }
        nav.mobile-nav .nav-item:active { background: transparent !important; }
        nav.mobile-nav .nav-item.active { background: transparent !important; }
        nav.mobile-nav .nav-icon { font-size: 1.5rem; color: #888; margin: 0; line-height: 1; display: block; transition: all .2s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; white-space: nowrap; }
        nav.mobile-nav .nav-label { font-size: .78rem; color: #888; font-weight: 600; line-height: 1; white-space: nowrap; display: block; }
        nav.mobile-nav .nav-icon, nav.mobile-nav .nav-label { pointer-events: none; }
        nav.mobile-nav .nav-item.active .nav-icon, nav.mobile-nav .nav-item.active .nav-label { color: #4cfa9d; }
        nav.mobile-nav .nav-item.active .nav-icon { transform: scale(1.1); }
        .nav-action { position: relative; width: 56px; height: 56px; margin-top: -14px; background: radial-gradient(circle, #57ffae, #4cfa9d); color: #000; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: 0 6px 18px rgba(76,250,157,0.35), 0 0 0 8px rgba(76,250,157,0.12); cursor: pointer; z-index: 2001; transition: all .3s ease; -webkit-tap-highlight-color: transparent; touch-action: none; flex: 0 0 56px; }
        .nav-action:hover { transform: scale(1.05); }
        .nav-action:active { transform: scale(0.95); }

        /* Bottom sheet */
        .bottom-sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 3000; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
        .bottom-sheet-overlay.visible { opacity: 1; pointer-events: auto; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #0a0a0a; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px 20px calc(20px + var(--mobile-safe-bottom)); z-index: 3001; transform: translateY(100%); transition: transform .4s cubic-bezier(0.15,1.15,0.6,1); max-height: 80vh; overflow-y: auto; box-shadow: 0 -10px 30px rgba(0,0,0,0.8); border-top: 1px solid #1a1a1a; }
        .bottom-sheet-overlay.visible .bottom-sheet { transform: translateY(0); }
        .bottom-sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #1a1a1a; }
        .bottom-sheet-title { font-size: 1.2rem; font-weight: 600; margin: 0; color: #fff; }
        .close-bottom-sheet { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all .2s ease; }
        .close-bottom-sheet:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .bottom-sheet-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .bottom-sheet-grid-item { background: linear-gradient(145deg, #0d0d0d, #050505); border-radius: 1.25rem; padding: 1rem; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: all .3s ease; border: 1px solid #1a1a1a; opacity: 0; transform: translateY(20px) scale(0.95); }
        .bottom-sheet-overlay.visible .bottom-sheet-grid-item { animation: mcard-in .5s cubic-bezier(0.15,1.15,0.6,1) forwards; }
        .bottom-sheet-overlay.visible .bottom-sheet-grid-item:nth-child(1){animation-delay:.05s} .bottom-sheet-overlay.visible .bottom-sheet-grid-item:nth-child(2){animation-delay:.1s} .bottom-sheet-overlay.visible .bottom-sheet-grid-item:nth-child(3){animation-delay:.15s} .bottom-sheet-overlay.visible .bottom-sheet-grid-item:nth-child(4){animation-delay:.2s}
        @keyframes mcard-in { to { opacity: 1; transform: translateY(0) scale(1); } }
        .bottom-sheet-grid-item:hover { transform: translateY(-10px); background: linear-gradient(145deg, #151515, #0a0a0a); box-shadow: 0 8px 30px rgba(76,250,157,0.3); }
        .bottom-sheet-grid-icon { font-size: 1.8rem; color: #4cfa9d; margin-bottom: .5rem; transition: all .3s cubic-bezier(0.15,1.15,0.6,1); text-shadow: 0 0 15px transparent; }
        .bottom-sheet-grid-item:hover .bottom-sheet-grid-icon { transform: scale(1.15); text-shadow: 0 0 20px rgba(76,250,157,0.3); }
        .bottom-sheet-grid-label { font-size: .8rem; font-weight: 600; color: #fff; }

        /* (Removed) Prototype Action Hub modal styles to restore original */
    </style>

    <!-- Mobile Navigation Markup -->
    <nav class="mobile-nav" aria-label="Primary" role="navigation">
      <div class="nav-item active" data-page="dashboard" id="mnav-dashboard">
        <i class="nav-icon fas fa-quote-right" aria-hidden="true"></i>
        <span class="nav-label">Dashboard</span>
      </div>
      <div class="nav-item" data-page="reports" id="mnav-reports">
        <i class="nav-icon fas fa-chart-pie" aria-hidden="true"></i>
        <span class="nav-label">Reports</span>
      </div>
      <button class="nav-action" id="actionButton" title="Actions">
        <i class="fas fa-bolt" aria-hidden="true"></i>
      </button>
      <div class="nav-item" data-page="analytics" id="mnav-analytics">
        <i class="nav-icon fas fa-chart-bar" aria-hidden="true"></i>
        <span class="nav-label">Analytics</span>
      </div>
      <div class="nav-item" id="moreButton">
        <i class="nav-icon fas fa-map-signs" aria-hidden="true"></i>
        <span class="nav-label">More</span>
      </div>
    </nav>

    <!-- Bottom Sheet for More Items -->
    <div class="bottom-sheet-overlay" id="bottomSheetOverlay" aria-hidden="true">
      <div class="bottom-sheet" id="bottomSheet" role="dialog" aria-modal="true" aria-labelledby="bottomSheetTitle">
        <div class="bottom-sheet-header">
          <h3 class="bottom-sheet-title" id="bottomSheetTitle">More Options</h3>
          <button class="close-bottom-sheet" id="closeBottomSheet" aria-label="Close">&times;</button>
        </div>
        <div class="bottom-sheet-grid">
          <div class="bottom-sheet-grid-item" data-page="topic"><i class="bottom-sheet-grid-icon fas fa-clipboard-list"></i><span class="bottom-sheet-grid-label">Topic</span></div>
          <div class="bottom-sheet-grid-item" data-page="exams"><i class="bottom-sheet-grid-icon fas fa-graduation-cap"></i><span class="bottom-sheet-grid-label">Exams</span></div>
          <div class="bottom-sheet-grid-item" data-page="motivation"><i class="bottom-sheet-grid-icon fas fa-video"></i><span class="bottom-sheet-grid-label">Motivation</span></div>
          <div class="bottom-sheet-grid-item" data-page="settings"><i class="bottom-sheet-grid-icon fas fa-cog"></i><span class="bottom-sheet-grid-label">Settings</span></div>
        </div>
      </div>
    </div>

    

    <script>
      // Mobile nav wiring (scoped; no desktop changes). Center bolt triggers original Action Hub.
      document.addEventListener('DOMContentLoaded', () => {
        const moreButton = document.getElementById('moreButton');
        const actionButton = document.getElementById('actionButton');
        const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
        const closeBottomSheet = document.getElementById('closeBottomSheet');
        const navItems = document.querySelectorAll('nav.mobile-nav .nav-item');
        const bottomSheetGridItems = document.querySelectorAll('.bottom-sheet-grid-item');

        const openBottomSheet = () => { document.body.classList.add('nav-open'); bottomSheetOverlay.classList.add('visible'); bottomSheetOverlay.setAttribute('aria-hidden','false'); };
        const closeBottomSheetFunc = () => { document.body.classList.remove('nav-open'); bottomSheetOverlay.classList.remove('visible'); bottomSheetOverlay.setAttribute('aria-hidden','true'); };

        const setActiveNavItem = (page) => {
          navItems.forEach(i => { i.classList.toggle('active', i.dataset.page === page); });
        };

        // Prefer existing showSection if present
        const go = (page) => {
          try { if (typeof window.showSection === 'function') { window.showSection(page); } } catch(_) {}
          setActiveNavItem(page);
        };

        moreButton?.addEventListener('click', openBottomSheet);
        // Delegate to the original desktop FAB if present
        actionButton?.addEventListener('click', () => {
          const fab = document.querySelector('.center-hub-fab');
          if (fab && typeof fab.click === 'function') { fab.click(); }
        });
        closeBottomSheet?.addEventListener('click', closeBottomSheetFunc);

        bottomSheetOverlay?.addEventListener('click', (e) => { if (e.target === bottomSheetOverlay) closeBottomSheetFunc(); });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') { closeBottomSheetFunc(); }});

        navItems.forEach(item => { item.addEventListener('click', () => { if (item.dataset.page) go(item.dataset.page); }); });
        bottomSheetGridItems.forEach(item => { item.addEventListener('click', () => { closeBottomSheetFunc(); if (item.dataset.page) go(item.dataset.page); }); });

        // No prototype action hub wiring; original behavior remains intact
      });
    </script>
    <!-- END: Mobile Navigation (prototype) -->

<!-- PWA block just before the closing </body> tag -->
<script>
  // Register the service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').then((registration) => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }).catch((error) => {
        console.log('ServiceWorker registration failed: ', error);
      });
    });
  }
</script>


</body>
</html>

